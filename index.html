<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hokkaido Trip 2026 (Èõ≤Á´ØÂêåÊ≠•Áâà)</title>
    
    <!-- Tab Icon -->
    <link rel="icon" type="image/jpeg" href="./image_ec3041.jpg">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- SortableJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'jp-slate': '#7A848D',
                        'jp-rust': '#976666',
                        'jp-sage': '#A9B7AA',
                        'jp-rose': '#C09D9B',
                        'jp-sand': '#DBD2C9',
                        'jp-beige': '#DBD4C6',
                        'jp-mist': '#CCD2CC',
                        'jp-gray-1': '#999EA2',
                        'jp-gray-2': '#93939B',
                        'jp-silver': '#BEBEBE',
                        'balance-pos': '#A9B7AA',
                        'balance-neg': '#EF5350'
                    }
                }
            }
        }
    </script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        
        body { background-color: #F2F4F6; -webkit-tap-highlight-color: transparent; font-family: 'Noto Sans TC', sans-serif; color: #7A848D; }
        .app-container { max-width: 480px; margin: 0 auto; min-height: 100vh; background-color: #ffffff; box-shadow: 0 0 40px rgba(122, 132, 141, 0.15); position: relative; padding-bottom: 90px; }
        .header-bg { background-color: #ffffff; padding: 0; position: relative; overflow: hidden; box-shadow: 0 4px 20px rgba(122, 132, 141, 0.2); border-bottom-left-radius: 35px; border-bottom-right-radius: 35px; z-index: 10; height: 280px; }
        .header-image-container { width: 100%; height: 100%; position: relative; }
        .header-image-container img { width: 100%; height: 100%; object-fit: cover; object-position: center bottom; }
        .snow-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><circle cx="50" cy="50" r="1" fill="%23fff" opacity="0.8"/><circle cx="20" cy="80" r="0.5" fill="%23fff" opacity="0.6"/><circle cx="70" cy="30" r="1.5" fill="%23fff" opacity="0.9"/></svg>'); background-size: 100px 100px; opacity: 0.8; animation: snowfall 10s linear infinite; z-index: 5; pointer-events: none; }
        @keyframes snowfall { to { background-position: 100px 100px; } }
        .side-tab-bar { position: absolute; bottom: 20px; right: 20px; z-index: 30; display: flex; gap: 10px; }
        .tab-button { width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; box-shadow: 0 4px 12px rgba(122, 132, 141, 0.3); transition: all 0.3s ease; background-color: rgba(255, 255, 255, 0.95); color: #BEBEBE; border: 2px solid white; }
        .tab-button.active { background-color: #7A848D; color: #ffffff; transform: scale(1.1) translateY(-5px); box-shadow: 0 8px 20px rgba(122, 132, 141, 0.5); border-color: #7A848D; }
        .app-main { padding-top: 20px; position: relative; z-index: 5; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .card-shadow { box-shadow: 0 4px 20px rgba(153, 158, 162, 0.15); transition: transform 0.2s ease; border: 1px solid #F0F2F5; }
        .animate-fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .note-content { max-height: 2.5rem; overflow: hidden; transition: max-height 0.3s ease-out; }
        .note-content.expanded { max-height: 500px; }
        .date-selector-sticky { background-color: rgba(255,255,255,0.95); backdrop-filter: blur(8px); border-bottom: 1px solid #E5E7EB; z-index: 20; top: 0; padding-top: 10px; padding-bottom: 10px; }
        .banner-text-overlay { background: linear-gradient(to top, rgba(122, 132, 141, 0.7) 0%, rgba(0,0,0,0) 100%); position: absolute; bottom: 0; left: 0; width: 100%; height: 60%; border-bottom-left-radius: 35px; border-bottom-right-radius: 35px; pointer-events: none; }
        .member-checkbox:checked + div { background-color: #7A848D; color: white; border-color: #7A848D; }
        .sync-status { position: absolute; top: 20px; right: 20px; z-index: 50; font-size: 0.7rem; padding: 4px 10px; border-radius: 20px; background: rgba(122, 132, 141, 0.6); color: white; backdrop-filter: blur(4px); display: flex; align-items: center; gap: 6px; letter-spacing: 0.5px; }
        .sync-dot { width: 6px; height: 6px; border-radius: 50%; background-color: #976666; }
        .sync-dot.online { background-color: #A9B7AA; box-shadow: 0 0 5px #A9B7AA; }
        .sync-dot.busy { background-color: #DBD4C6; animation: pulse 1s infinite; }
        .sync-dot.error { background-color: #EF5350; box-shadow: 0 0 5px #EF5350; animation: none; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        .pie-chart { border-radius: 50%; transition: all 0.5s ease; }
        .drag-handle { cursor: move; touch-action: none; }
        
        /* È£õÊ©üÂúñÁ§∫È£õË°åÊñπÂêë */
        .flight-arrow-outbound { transform: rotate(90deg); display: inline-block; }
        .flight-arrow-inbound { transform: rotate(-90deg); display: inline-block; }

        /* Ëá™ÂÆöÁæ©ÊªæÂãïÊ¢ù */
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #CCD2CC; border-radius: 20px; }
        
        /* Loading Overlay */
        .loading-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.9); z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .loading-spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #7A848D; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="text-jp-slate">

<div id="app" class="app-container">

    <!-- Loading Overlay -->
    <div v-if="!isDataLoaded" class="loading-overlay">
        <div class="loading-spinner"></div>
        <div class="text-jp-slate text-sm font-bold">Ë≥áÊñôÂêåÊ≠•‰∏≠...</div>
    </div>

    <!-- Sync Status -->
    <div class="sync-status">
        <div class="sync-dot" :class="syncStatusClass"></div>
        <span>{{ statusMessage }}</span>
    </div>

    <!-- Header -->
    <div class="header-bg">
        <div class="header-image-container">
            <img src="./banner.jpg" 
                 onerror="this.src='https://images.unsplash.com/photo-1548578709-32269a838573?q=80&w=1920&auto=format&fit=crop'"
                 alt="ÂåóÊµ∑ÈÅìÂÆ∂ÊóèÊóÖË°å">
            <div class="banner-text-overlay"></div>
            <div class="absolute bottom-6 left-6 text-white z-20">
                <h1 class="text-3xl font-bold tracking-widest drop-shadow-md text-white">HOKKAIDO</h1>
                <p class="text-sm font-light tracking-wider opacity-90 text-jp-silver">2026.03.06 - 03.14</p>
            </div>
        </div>
        <div class="snow-layer"></div> 
        <div class="side-tab-bar">
            <button @click="currentTab = 'itinerary'" :class="{'active': currentTab === 'itinerary'}" class="tab-button"><i class="fa-solid fa-map-location-dot"></i></button>
            <button @click="currentTab = 'info'" :class="{'active': currentTab === 'info'}" class="tab-button"><i class="fa-solid fa-circle-info"></i></button>
            <button @click="currentTab = 'shopping'" :class="{'active': currentTab === 'shopping'}" class="tab-button"><i class="fa-solid fa-basket-shopping"></i></button>
            <button @click="currentTab = 'expenses'" :class="{'active': currentTab === 'expenses'}" class="tab-button"><i class="fa-solid fa-coins"></i></button>
        </div>
    </div>

    <!-- Main Content -->
    <main class="p-4 app-main" v-if="isDataLoaded">
        
        <!-- Tab 1: Ë°åÁ®ã -->
        <div v-if="currentTab === 'itinerary'" class="animate-fade-in">
            <div class="flex overflow-x-auto hide-scrollbar space-x-3 mb-6 snap-x px-1 sticky date-selector-sticky -mx-4 px-4 pb-2">
                <div v-for="(day, index) in dates" :key="index" @click="selectedDateIndex = index"
                     class="snap-center flex-shrink-0 w-[70px] h-[80px] rounded-2xl flex flex-col items-center justify-center cursor-pointer transition-all duration-300 border shadow-sm"
                     :class="selectedDateIndex === index ? 'bg-jp-slate text-white border-jp-slate shadow-lg scale-105' : 'bg-white text-jp-gray-1 border-transparent hover:bg-jp-mist/20'">
                    <span class="text-[10px] font-bold uppercase tracking-wider opacity-90">{{ day.dayLabel }}</span>
                    <span class="text-sm font-bold mt-0.5">{{ day.date }}</span> 
                    <span class="text-[10px] font-medium opacity-70">({{ day.weekday }})</span> 
                </div>
            </div>

            <!-- Ë°åÁ®ãÊ®ôÈ°åËàáÂ§©Ê∞£ -->
            <div class="flex items-center justify-between mb-6 px-1 mt-2">
                <div class="flex items-center gap-2 flex-1 min-w-0 mr-4">
                    <i class="fa-solid fa-map-location-dot text-2xl text-jp-rust shrink-0"></i>
                    <input v-model="dates[selectedDateIndex].area" 
                           @change="triggerSync"
                           class="text-3xl font-bold text-jp-slate tracking-tight bg-transparent border-b-2 border-transparent focus:border-jp-slate focus:outline-none w-full truncate"
                           type="text">
                </div>
                <div class="flex flex-col items-end shrink-0">
                    <div class="flex items-center gap-2 mb-1">
                         <span class="text-2xl font-bold text-jp-gray-1 tracking-tight">{{ dates[selectedDateIndex].temp }}</span>
                         <div class="w-8 h-8 rounded-full bg-white border border-jp-mist/50 flex items-center justify-center text-jp-slate shadow-sm" :title="dates[selectedDateIndex].weather">
                            <i :class="getWeatherIcon(dates[selectedDateIndex].weather)" class="text-lg"></i>
                        </div>
                    </div>
                     <span v-if="dates[selectedDateIndex].transport" class="text-[10px] bg-jp-mist/30 text-jp-slate px-2 py-0.5 rounded-full mt-1">
                        <i class="fa-solid fa-van-shuttle mr-1"></i> {{ dates[selectedDateIndex].transport }}
                    </span>
                </div>
            </div>

            <!-- Ë°åÁ®ãÂàóË°® -->
            <div class="space-y-4 pb-20" id="itinerary-list" ref="itineraryList">
                <div v-for="(item, idx) in currentItinerary" :key="item.id" class="relative pl-4 group" :data-id="item.id">
                    <!-- ÈÄ£Êé•Á∑ö -->
                    <div v-if="idx < currentItinerary.length - 1" class="absolute left-[23px] top-8 bottom-[-16px] w-0.5 bg-jp-silver/50 z-0">
                        <!-- ‰∫§ÈÄöÊôÇÈñìÊ®ôÁ±§ -->
                        <div v-if="item.travelTime" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-jp-mist/80 text-jp-slate text-[9px] font-bold px-1.5 py-0.5 rounded-full border border-white whitespace-nowrap z-10 shadow-sm">
                            <i class="fa-solid fa-arrow-down mr-0.5"></i> {{ item.travelTime }}
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-2xl p-4 card-shadow relative z-10 cursor-move">
                        <div class="flex items-start gap-3">
                            <div class="flex flex-col items-center min-w-[50px]">
                                <div class="w-10 h-10 rounded-full flex items-center justify-center text-white shadow-md text-sm mb-1" :class="getCategoryColor(item.category)">
                                    <i :class="getCategoryIcon(item.category)"></i>
                                </div>
                                <span class="text-xs font-bold text-jp-gray-1">{{ item.startTime }}</span>
                            </div>
                            
                            <div class="flex-1 min-w-0">
                                <div class="flex justify-between items-start">
                                    <h3 class="font-bold text-jp-slate text-lg leading-tight truncate pr-6">{{ item.name }}</h3>
                                    <div class="flex gap-3 shrink-0 absolute top-4 right-4">
                                         <button @click.stop="editItem(item)" class="text-jp-silver hover:text-jp-slate transition-colors"><i class="fa-solid fa-pencil"></i></button>
                                         <button @click.stop="removeItineraryItemCard(item.id)" class="text-jp-silver hover:text-jp-rust transition-colors"><i class="fa-solid fa-trash-can"></i></button>
                                         <button class="drag-handle text-jp-silver hover:text-jp-slate transition-colors"><i class="fa-solid fa-bars"></i></button>
                                    </div>
                                </div>
                                
                                <div class="flex gap-2 mt-2">
                                    <!-- Âú∞ÂùÄÈÄ£ÁµêÊåâÈàï -->
                                    <button v-if="item.address" @click.stop="openMap(item.address)" class="text-xs bg-jp-mist/20 text-jp-slate px-2.5 py-1.5 rounded-lg hover:bg-jp-slate hover:text-white transition-colors flex items-center text-left">
                                        <i class="fa-solid fa-location-dot mr-1.5 text-jp-rust"></i> {{ item.address }}
                                    </button>
                                    <!-- ÂÇôÁî®Â∞éËà™ÊåâÈàï -->
                                    <button v-else @click.stop="openMap(item.name)" class="text-xs bg-jp-mist/20 text-jp-slate px-2.5 py-1.5 rounded-lg hover:bg-jp-slate hover:text-white transition-colors flex items-center">
                                        <i class="fa-solid fa-map mr-1.5"></i> Â∞éËà™
                                    </button>

                                    <!-- Ë≤ªÁî®Ê®ôÁ±§ -->
                                    <span v-if="item.price" class="text-xs bg-jp-rose/10 text-jp-rose px-2.5 py-1.5 rounded-lg border border-jp-rose/20 flex items-center whitespace-nowrap">
                                        <i class="fa-solid fa-ticket mr-1.5"></i> {{ item.price }}
                                    </span>
                                </div>
                                
                                <div v-if="item.note" class="mt-3 bg-jp-mist/10 p-2.5 rounded-xl border border-jp-mist/20 text-xs text-jp-gray-2 whitespace-pre-line">
                                    <div class="note-content" :class="{'expanded': item.isNoteExpanded}">{{ item.note }}</div>
                                    <button v-if="item.note.length > 40" @click="item.isNoteExpanded = !item.isNoteExpanded" class="text-jp-slate font-bold mt-1">{{ item.isNoteExpanded ? 'Êî∂Âêà' : 'Â±ïÈñã...' }}</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div v-if="currentItinerary.length === 0" class="text-center py-10 text-jp-silver"><p>Êú¨Êó•Êö´ÁÑ°Ë°åÁ®ãÔºåÈªûÊìäÂè≥‰∏ãËßí + Êñ∞Â¢û</p></div>
            </div>
        </div>

        <!-- Tab 2: Ë≥áË®ä -->
        <div v-if="currentTab === 'info'" class="animate-fade-in space-y-5 pb-20">
             <!-- ÂåØÁéáË®àÁÆó (ÈõôÂêë) -->
             <div class="bg-gradient-to-br from-jp-slate to-jp-gray-2 rounded-3xl p-6 text-white shadow-xl relative overflow-hidden">
                <div class="absolute top-0 right-0 w-32 h-32 bg-white/5 rounded-full -mr-10 -mt-10 blur-2xl"></div>
                <div class="flex justify-between items-center mb-4 relative z-10">
                    <h3 class="font-bold flex items-center"><i class="fa-solid fa-calculator mr-2"></i> ÂåØÁéáÊèõÁÆó</h3>
                    <div class="flex items-center bg-white/10 rounded-lg px-2 py-1 border border-white/10">
                        <span class="text-xs text-jp-sand mr-1">ÂåØÁéá:</span>
                        <input type="number" v-model="exchangeRate" @change="triggerSync" step="0.001" class="w-12 bg-transparent text-white font-bold text-sm text-right focus:outline-none border-b border-white/30">
                    </div>
                </div>
                <div class="flex items-center justify-between gap-4 relative z-10">
                    <div class="flex-1">
                        <label class="text-[10px] text-jp-sand block mb-1">JPY</label>
                        <input type="number" v-model="calcJPY" @input="calculateTWD" class="w-full bg-white/10 border border-white/20 rounded-xl px-3 py-2 text-white font-bold text-lg focus:outline-none">
                    </div>
                    <i class="fa-solid fa-arrow-right-arrow-left text-jp-sand mt-4"></i>
                    <div class="flex-1">
                        <label class="text-[10px] text-jp-sand block mb-1">TWD</label>
                        <input type="number" v-model="calcTWD" @input="calculateJPY" class="w-full bg-white/10 border border-white/20 rounded-xl px-3 py-2 text-white font-bold text-lg focus:outline-none">
                    </div>
                </div>
            </div>

            <!-- Ëà™Áè≠Ë≥áË®ä -->
            <div class="bg-white rounded-3xl p-6 card-shadow mb-6">
                <h3 class="font-bold text-jp-slate mb-4 border-b border-jp-mist/30 pb-2 flex items-center">
                    <i class="fa-solid fa-plane-departure text-jp-gray-1 mr-2"></i> Ëà™Áè≠Ë≥áË®ä
                </h3>
                
                <div class="space-y-6">
                    <!-- ÂéªÁ®ã -->
                    <div class="relative pl-3 border-l-2 border-jp-rust/50">
                        <div class="absolute -left-[5px] top-0 w-2.5 h-2.5 rounded-full bg-jp-rust"></div>
                        <span class="text-xs font-bold text-white bg-jp-rust px-2 py-0.5 rounded mb-2 inline-block">ÂéªÁ®ã 03/06 (‰∫î)</span>
                        <div class="bg-jp-mist/10 p-3 rounded-xl">
                            <div class="flex justify-between items-center mb-1">
                                <span class="font-bold text-jp-slate">Ê≥∞Ë∂äÊç∑Ëà™Á©∫ VZ570</span>
                            </div>
                            <div class="flex justify-between text-sm text-jp-gray-2">
                                <div>
                                    <div class="font-mono font-bold text-jp-slate text-lg">02:50</div>
                                    <div class="text-xs">TPE T1</div>
                                </div>
                                <i class="fa-solid fa-plane text-jp-rose mx-3 flight-arrow-outbound"></i>
                                <div class="text-right">
                                    <div class="font-mono font-bold text-jp-slate text-lg">07:30</div>
                                    <div class="text-xs">CTS</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ÂõûÁ®ã -->
                    <div class="relative pl-3 border-l-2 border-jp-slate/50">
                        <div class="absolute -left-[5px] top-0 w-2.5 h-2.5 rounded-full bg-jp-slate"></div>
                        <span class="text-xs font-bold text-white bg-jp-slate px-2 py-0.5 rounded mb-2 inline-block">ÂõûÁ®ã 03/14 (ÂÖ≠)</span>
                        
                        <div class="space-y-3">
                            <!-- ÂõûÁ®ã 1 -->
                            <div class="bg-jp-mist/10 p-3 rounded-xl border border-transparent hover:border-jp-mist/50 transition-colors">
                                <div class="flex justify-between items-center mb-1">
                                    <span class="font-bold text-jp-slate text-sm">‰∏≠ËèØËà™Á©∫ CI131</span>
                                </div>
                                <div class="flex justify-between items-center text-sm text-jp-gray-2">
                                    <div><span class="font-mono font-bold text-jp-slate text-lg">14:40</span> CTS</div>
                                    <i class="fa-solid fa-plane text-jp-silver mx-2 flight-arrow-inbound"></i>
                                    <div class="text-right"><span class="font-mono font-bold text-jp-slate text-lg">18:15</span> TPE T2</div>
                                </div>
                            </div>
                            <!-- ÂõûÁ®ã 2 -->
                            <div class="bg-jp-mist/10 p-3 rounded-xl border border-transparent hover:border-jp-mist/50 transition-colors">
                                <div class="flex justify-between items-center mb-1">
                                    <span class="font-bold text-jp-slate text-sm">ÊòüÂÆáËà™Á©∫ JX851</span>
                                </div>
                                <div class="flex justify-between items-center text-sm text-jp-gray-2">
                                    <div><span class="font-mono font-bold text-jp-slate text-lg">15:20</span> CTS</div>
                                    <i class="fa-solid fa-plane text-jp-silver mx-2 flight-arrow-inbound"></i>
                                    <div class="text-right"><span class="font-mono font-bold text-jp-slate text-lg">19:05</span> TPE T1</div>
                                </div>
                            </div>
                            <!-- ÂõûÁ®ã 3 -->
                            <div class="bg-jp-mist/10 p-3 rounded-xl border border-transparent hover:border-jp-mist/50 transition-colors">
                                <div class="flex justify-between items-center mb-1">
                                    <span class="font-bold text-jp-slate text-sm">ÈÖ∑Ëà™ TR893</span>
                                </div>
                                <div class="flex justify-between items-center text-sm text-jp-gray-2">
                                    <div><span class="font-mono font-bold text-jp-slate text-lg">18:40</span> CTS</div>
                                    <i class="fa-solid fa-plane text-jp-silver mx-2 flight-arrow-inbound"></i>
                                    <div class="text-right"><span class="font-mono font-bold text-jp-slate text-lg">22:20</span> TPE T1</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ‰ΩèÂÆøÊ∏ÖÂñÆ -->
            <div class="bg-white rounded-3xl p-6 card-shadow">
                <h3 class="font-bold text-jp-slate mb-4 border-b border-jp-mist/30 pb-2"><i class="fa-solid fa-hotel text-jp-rose mr-2"></i> ‰ΩèÂÆøÊ∏ÖÂñÆ</h3>
                <ul class="space-y-4">
                    <li v-for="hotel in hotels" class="group">
                        <div class="flex justify-between items-start">
                            <div><span class="font-bold text-jp-slate block">{{ hotel.name }}</span><span class="text-xs bg-jp-mist/30 text-jp-slate px-2 py-0.5 rounded-md mt-1 inline-block">{{ hotel.date }}</span></div>
                            <button @click="openMap(hotel.name)" class="w-8 h-8 rounded-full bg-jp-mist/20 text-jp-slate flex items-center justify-center hover:bg-jp-slate hover:text-white transition-colors"><i class="fa-solid fa-location-arrow text-xs"></i></button>
                        </div>
                        <p class="text-xs text-jp-gray-1 mt-1"><i class="fa-solid fa-map-pin mr-1"></i> {{ hotel.address }}</p>
                    </li>
                </ul>
            </div>

            <!-- ÂøÖË≤∑Ê∏ÖÂñÆ -->
            <div class="bg-white rounded-3xl p-6 card-shadow relative mt-6">
                <div class="flex justify-between items-center mb-4 border-b border-jp-mist/30 pb-2">
                    <h3 class="font-bold text-jp-slate"><i class="fa-solid fa-thumbs-up text-jp-rust mr-2"></i> ÂøÖË≤∑Êé®Ëñ¶</h3>
                    <button @click="isMustBuyEditMode = !isMustBuyEditMode" class="text-xs px-2 py-1 rounded-full transition-colors" :class="isMustBuyEditMode ? 'bg-jp-slate text-white' : 'bg-jp-mist/30 text-jp-slate'">
                        <i class="fa-solid fa-pen-to-square mr-1"></i> {{ isMustBuyEditMode ? 'ÂÆåÊàê' : 'Á∑®ËºØ' }}
                    </button>
                </div>
                
                <div v-for="(region, rIdx) in mustBuyList" :key="rIdx" class="mb-5 last:mb-0 group/region">
                    <div class="flex items-center mb-2">
                        <span class="w-1.5 h-4 bg-jp-rose rounded-r mr-2"></span>
                        <input v-if="isMustBuyEditMode" v-model="region.area" @change="triggerSync" class="font-bold text-sm text-jp-gray-2 bg-gray-50 border-b border-jp-silver w-full focus:outline-none">
                        <h4 v-else class="font-bold text-sm text-jp-gray-2">{{ region.area }}</h4>
                        <button v-if="isMustBuyEditMode" @click="removeRegion(rIdx)" class="ml-2 text-jp-silver hover:text-jp-rust text-xs"><i class="fa-solid fa-trash-can"></i></button>
                    </div>
                    <div class="flex flex-wrap gap-2">
                        <span v-for="(item, iIdx) in region.items" :key="iIdx" class="bg-jp-beige/50 text-jp-gray-2 text-xs px-3 py-1.5 rounded-lg border border-jp-beige flex items-center">
                            {{ item }}
                            <button v-if="isMustBuyEditMode" @click="removeMustBuyItem(rIdx, iIdx)" class="ml-2 text-jp-silver hover:text-jp-rust font-bold">√ó</button>
                        </span>
                        <div v-if="isMustBuyEditMode" class="flex items-center">
                            <input @keyup.enter="addMustBuyItem(rIdx, $event)" placeholder="Ëº∏ÂÖ•ÂæåEnter" class="text-xs bg-white border border-jp-silver rounded-lg px-2 py-1.5 w-24 outline-none focus:border-jp-slate">
                        </div>
                    </div>
                </div>

                <div v-if="isMustBuyEditMode" class="mt-4 pt-4 border-t border-jp-mist/30">
                    <div class="flex items-center gap-2">
                        <input v-model="newRegionName" placeholder="Êñ∞ÂçÄÂüüÂêçÁ®±" class="flex-1 text-sm bg-gray-50 border border-jp-silver rounded-lg px-3 py-2 outline-none focus:border-jp-slate">
                        <button @click="addRegion" class="bg-jp-slate text-white text-xs px-3 py-2 rounded-lg font-bold">Êñ∞Â¢û</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab 3: Ë≥ºÁâ©Ê∏ÖÂñÆ -->
        <div v-if="currentTab === 'shopping'" class="animate-fade-in pb-20">
            <button @click="showShoppingModal = true; resetShoppingForm()" class="w-full bg-white border-2 border-dashed border-jp-silver rounded-2xl p-4 mb-4 text-jp-gray-1 font-bold hover:bg-jp-beige/20 hover:border-jp-slate transition-colors flex items-center justify-center">
                <i class="fa-solid fa-plus mr-2"></i> Êñ∞Â¢ûÂæÖË≤∑ÂïÜÂìÅ
            </button>

            <div class="space-y-3">
                <div v-for="(item, idx) in shoppingList" :key="idx" class="flex items-center bg-white p-3 rounded-2xl card-shadow transition-all hover:translate-x-1">
                    <div class="mr-3 pl-1">
                        <input type="checkbox" v-model="item.checked" @change="triggerSync" class="w-5 h-5 accent-jp-slate rounded border-jp-silver cursor-pointer">
                    </div>
                    <!-- ÂàÜÈ°ûÂúñÁ§∫ -->
                    <div class="w-10 h-10 rounded-lg flex items-center justify-center text-white text-sm shrink-0 shadow-sm"
                         :class="getShoppingCategoryColor(item.category)">
                        <i :class="getShoppingCategoryIcon(item.category)"></i>
                    </div>
                    <div class="flex-1 ml-3 overflow-hidden">
                        <div class="flex items-center">
                            <p class="font-bold text-sm text-jp-slate truncate" :class="{'line-through text-jp-silver': item.checked}">{{ item.name }}</p>
                            <span v-if="item.buyer" class="ml-2 text-[10px] bg-jp-mist/20 text-jp-slate px-1.5 py-0.5 rounded border border-jp-mist/30 flex items-center shrink-0">
                                <i class="fa-solid fa-user mr-1 text-[8px]"></i>{{ item.buyer }}
                            </span>
                        </div>
                        <p class="text-xs text-jp-gray-1 mt-0.5 flex items-center">
                            <span class="font-mono text-deep-sea-blue font-bold mr-2">x{{ item.qty }}</span>
                            <span class="text-[10px] bg-jp-beige/40 px-1.5 py-0.5 rounded text-jp-gray-2">{{ getShoppingCategoryName(item.category) }}</span>
                        </p>
                    </div>
                    <button @click="removeShoppingItem(idx)" class="w-8 h-8 rounded-full flex items-center justify-center text-jp-silver hover:text-jp-rust hover:bg-jp-rose/10 transition-colors ml-2">
                        <i class="fa-solid fa-trash-can"></i>
                    </button>
                </div>
                <div v-if="shoppingList.length === 0" class="text-center py-10 text-jp-silver text-sm">Êö´ÁÑ°Ë≥ºÁâ©Ê∏ÖÂñÆ</div>
            </div>
        </div>

        <!-- Tab 4: Ëä±Ë≤ª -->
        <div v-if="currentTab === 'expenses'" class="animate-fade-in pb-20">
            <!-- Á∏ΩÊîØÂá∫ -->
            <div class="bg-gradient-to-r from-jp-slate to-jp-gray-2 text-white rounded-3xl p-6 mb-6 relative overflow-hidden shadow-lg">
                <div class="absolute -right-10 -top-10 bg-white/10 w-48 h-48 rounded-full blur-3xl"></div>
                
                <div class="flex justify-between items-end relative z-10">
                    <div>
                        <p class="text-xs text-jp-sand mb-1">Êú¨Ê¨°Ë°åÁ®ãÁ∏ΩÊîØÂá∫ (‰∏çÂê´ËΩâÂ∏≥)</p>
                        <h2 class="text-3xl font-bold tracking-tight">¬• {{ formatNumber(totalExpensesJPY) }}</h2>
                    </div>
                    <div class="text-right">
                        <p class="text-lg font-bold text-jp-sand">NT$ {{ formatNumber(totalExpensesTWD) }}</p>
                    </div>
                </div>
            </div>

            <!-- Êñ∞Â¢ûÊîØÂá∫ÊåâÈàï -->
            <button @click="handleAddClick" class="w-full bg-jp-rust text-white rounded-2xl p-3 mb-6 shadow-md hover:bg-jp-rust/90 transition-all flex items-center justify-center font-bold">
                <i class="fa-solid fa-plus mr-2"></i> Êñ∞Â¢ûÊîØÂá∫
            </button>

            <!-- ÊîØÂá∫ÊòéÁ¥∞ÁØ©ÈÅ∏ -->
            <div class="mb-6">
                 <h3 class="font-bold text-jp-slate mb-3 flex items-center text-sm px-1"><i class="fa-solid fa-filter mr-2 text-jp-gray-1"></i> ÊîØÂá∫ÊòéÁ¥∞ÁØ©ÈÅ∏</h3>
                 <div class="flex gap-3">
                     <select v-model="filterMember" class="flex-1 bg-white border border-jp-mist/50 rounded-xl p-2.5 text-sm text-jp-slate outline-none focus:border-jp-rust">
                         <option value="all">ÊâÄÊúâÊàêÂì°</option>
                         <option v-for="m in members" :key="m" :value="m">{{ m }}</option>
                     </select>
                     <select v-model="filterCategory" class="flex-1 bg-white border border-jp-mist/50 rounded-xl p-2.5 text-sm text-jp-slate outline-none focus:border-jp-rust">
                         <option value="all">ÊâÄÊúâÈ°ûÂà•</option>
                         <option v-for="(icon, cat) in CATEGORY_MAP" :key="cat" :value="cat">{{ CATEGORY_MAP_NAME[cat] || cat }}</option>
                     </select>
                 </div>
                 <div v-if="filteredExpenses.length > 0 && (filterMember !== 'all' || filterCategory !== 'all')" class="mt-2 text-right text-xs text-jp-gray-1">
                     ÁØ©ÈÅ∏Á∏ΩË®à (‰∏çÂê´ËΩâÂ∏≥): ¬•{{ formatNumber(filteredExpenses.filter(e => e.category !== 'transfer' && e.type !== 'transfer').reduce((s, e) => s + e.amount, 0)) }}
                 </div>
            </div>

            <!-- Ê∂àË≤ªÁµ±Ë®àÂàÜÊûê (Modified: Dynamic based on filters) -->
            <div class="mb-6" v-if="analysisItems.length > 0">
                 <h3 class="font-bold text-jp-slate mb-3 flex items-center text-sm px-1"><i class="fa-solid fa-chart-pie mr-2 text-jp-rose"></i> Ê∂àË≤ªÁµ±Ë®àÂàÜÊûê {{ filterMember !== 'all' ? '(' + filterMember + ')' : '(Á∏ΩË¶Ω)' }}</h3>
                 <div class="bg-white rounded-3xl p-5 shadow-sm border border-jp-mist/30">
                     <div class="flex items-center justify-between">
                         <!-- Pie Chart -->
                         <div class="relative w-32 h-32 pie-chart shadow-inner shrink-0"
                              :style="{ background: getFilterPieChartGradient(analysisItems) }">
                              <div class="absolute inset-5 bg-white rounded-full flex flex-col items-center justify-center">
                                  <span class="text-[10px] text-jp-gray-2 text-center leading-tight">Á∏ΩË®à</span>
                                  <span class="text-sm font-bold text-jp-slate">¬•{{ formatNumber(Math.round(analysisItems.reduce((s, e) => s + (e.displayAmount || 0), 0))) }}</span>
                                  <span class="text-[10px] text-jp-gray-1">NT$ {{ formatNumber(Math.round(analysisItems.reduce((s, e) => s + (e.displayAmountTWD || 0), 0))) }}</span>
                              </div>
                         </div>
                         
                         <!-- Legend -->
                         <div class="flex-1 ml-5 space-y-2 max-h-40 overflow-y-auto hide-scrollbar">
                             <div v-for="(item, idx) in getFilteredCategoryStats(analysisItems)" :key="idx" 
                                  class="flex items-center justify-between text-xs text-jp-gray-2">
                                 <div class="flex items-center">
                                     <div class="w-2.5 h-2.5 rounded-full mr-2 shadow-sm" :style="{ backgroundColor: CATEGORY_HEX[item.category] }"></div>
                                     <span class="truncate max-w-[80px]">{{ CATEGORY_MAP_NAME[item.category] || item.category }}</span>
                                 </div>
                                 <div class="text-right">
                                     <span class="font-bold text-jp-slate block">¬•{{ formatNumber(Math.round(item.total)) }}</span>
                                     <span class="text-[9px] text-jp-gray-1 block">NT$ {{ formatNumber(Math.round(item.totalTWD)) }}</span>
                                 </div>
                             </div>
                         </div>
                     </div>
                     
                     <!-- üßæ Ë©≥Á¥∞ÊòéÁ¥∞ÂàóË°® (Linked to Analysis) -->
                     <div class="mt-4 border-t border-jp-mist/30 pt-4">
                         <div class="text-xs text-jp-gray-1 mb-2 flex items-center justify-between">
                             <span><i class="fa-solid fa-list-ul mr-1.5"></i> Ë©≥Á¥∞ÊòéÁ¥∞ÂàóË°®</span>
                             <span class="text-[10px] bg-jp-mist/20 px-2 py-0.5 rounded-full">{{ analysisItems.length }} Á≠Ü</span>
                         </div>
                         <div class="space-y-2 max-h-60 overflow-y-auto pr-1 custom-scrollbar">
                             <div v-for="exp in analysisItems" :key="exp.id" class="flex justify-between items-center bg-jp-mist/5 p-2 rounded-lg border border-transparent hover:border-jp-mist/30 transition-colors">
                                 <div class="flex items-center gap-2 min-w-0">
                                     <div class="w-8 h-8 rounded-full flex items-center justify-center text-white text-[10px] shrink-0" :class="getCategoryColor(exp.category)">
                                         <i :class="getCategoryIcon(exp.category)"></i>
                                     </div>
                                     <div class="min-w-0">
                                         <div class="text-xs font-bold text-jp-slate truncate">{{ exp.name }}</div>
                                         <div class="text-[9px] text-jp-gray-2 flex items-center">
                                            <span class="mr-2">{{ exp.date }}</span>
                                            <span v-if="exp.isShare" class="text-jp-rust">ÂàÜÊî§È°ç (Áî± {{ exp.payer }} Â¢ä‰ªò)</span>
                                            <span v-else-if="exp.category === 'transfer'" class="text-jp-sage">ËΩâÂ∏≥</span>
                                            <span v-else>{{ exp.payer }} Â¢ä‰ªò</span>
                                         </div>
                                     </div>
                                 </div>
                                 <div class="text-right shrink-0">
                                     <div class="text-xs font-bold text-jp-slate font-mono">¬•{{ formatNumber(Math.round(exp.displayAmount)) }}</div>
                                     <div class="text-[9px] text-jp-gray-1 font-mono">NT$ {{ formatNumber(Math.round(exp.displayAmountTWD)) }}</div>
                                 </div>
                             </div>
                         </div>
                     </div>
                 </div>
            </div>

            <!-- ÂàÜÂ∏≥ÁµêÁÆó -->
            <div class="mb-6">
                <h3 class="font-bold text-jp-slate mb-3 flex items-center text-sm px-1"><i class="fa-solid fa-scale-balanced text-jp-rose mr-2"></i> ÂàÜÂ∏≥ÁµêÁÆó</h3>
                
                <div class="flex overflow-x-auto hide-scrollbar gap-3 px-1 pb-2">
                    <div v-for="member in balanceSheet" :key="member.name" 
                         @click="selectedMemberName = member.name"
                         class="flex flex-col items-center min-w-[60px] cursor-pointer transition-all duration-300"
                         :class="selectedMemberName === member.name ? 'scale-110 opacity-100' : 'opacity-60 scale-100'">
                        <div class="w-12 h-12 rounded-full flex items-center justify-center text-white font-bold text-lg mb-1 shadow-md transition-colors border-2 border-white"
                             :class="member.balance >= 0 ? 'bg-jp-sage' : 'bg-jp-rust'">
                            {{ member.name.charAt(0) }}
                        </div>
                        <span class="text-xs font-bold text-jp-gray-2 whitespace-nowrap">{{ member.name }}</span>
                    </div>
                </div>
                
                <div v-if="selectedMemberData" class="bg-white rounded-3xl p-5 mt-2 shadow-sm border border-jp-mist/30 animate-fade-in">
                    <div class="flex justify-between items-center mb-4 border-b border-jp-mist/30 pb-3">
                        <h3 class="font-bold text-jp-slate text-lg">{{ selectedMemberData.name }} ÁöÑÂ∏≥Âãô</h3>
                        <div class="text-right">
                            <span class="block font-bold text-lg" :class="selectedMemberData.balance >= 0 ? 'text-jp-sage' : 'text-jp-rust'">
                                {{ selectedMemberData.balance >= 0 ? 'ÊáâÊî∂' : 'Êáâ‰ªò' }} ¬•{{ formatNumber(Math.abs(selectedMemberData.balance)) }}
                            </span>
                            <span class="text-xs opacity-60 block" :class="selectedMemberData.balanceTWD >= 0 ? 'text-jp-sage' : 'text-jp-rust'">
                                ‚âà NT$ {{ formatNumber(Math.abs(selectedMemberData.balanceTWD)) }}
                            </span>
                        </div>
                    </div>
                    <!-- Ê¨†Ë≤ª/‰ªòÊ¨æ ÂúñË°® -->
                    <div class="mb-5">
                        <div class="flex justify-between text-xs text-jp-gray-1 mb-1">
                            <span>Êî∂ÊîØÂ∞çÊØî (JPY)</span>
                        </div>
                        <div class="w-full h-3 bg-jp-mist/20 rounded-full flex overflow-hidden">
                            <div class="bg-jp-rose h-full" :style="{ width: (selectedMemberData.share / (Math.max(selectedMemberData.share, selectedMemberData.paid) * 1.2 || 1) * 100) + '%' }"></div>
                        </div>
                        <div class="flex justify-between text-[10px] mt-1 text-jp-gray-2">
                            <span>Êáâ‰ªò ¬•{{ formatNumber(Math.round(selectedMemberData.share)) }}</span>
                            <span>Â∑≤‰ªò ¬•{{ formatNumber(selectedMemberData.paid) }}</span>
                        </div>
                        <div class="w-full h-3 bg-jp-mist/20 rounded-full flex overflow-hidden mt-1">
                            <div class="bg-jp-slate h-full" :style="{ width: (selectedMemberData.paid / (Math.max(selectedMemberData.share, selectedMemberData.paid) * 1.2 || 1) * 100) + '%' }"></div>
                        </div>
                    </div>
                    <!-- ÂàóË°® -->
                     <div class="grid grid-cols-2 gap-4 mt-4 pt-4 border-t border-jp-mist/30">
                        <div class="bg-jp-beige/20 p-3 rounded-xl border border-jp-beige/50">
                            <span class="text-xs text-jp-gray-1 block mb-1">Ê∂àË≤ª (Êáâ‰ªò)</span>
                            <span class="block font-bold text-jp-slate text-lg">¬• {{ formatNumber(Math.round(selectedMemberData.share)) }}</span>
                        </div>
                        <div class="bg-jp-beige/20 p-3 rounded-xl border border-jp-beige/50">
                            <span class="text-xs text-jp-gray-1 block mb-1">Â¢ä‰ªò (Â∑≤‰ªò)</span>
                            <span class="block font-bold text-jp-slate text-lg">¬• {{ formatNumber(selectedMemberData.paid) }}</span>
                        </div>
                    </div>
                    
                </div>
            </div>

            <!-- ÊúÄ‰Ω≥ÈÇÑÊ¨æ -->
            <div v-if="settlements.length > 0" class="bg-gradient-to-br from-jp-beige/40 to-jp-sage/10 rounded-3xl p-5 mb-6 shadow-sm border border-jp-sage/20">
                <h3 class="font-bold text-jp-slate mb-3 flex items-center text-sm"><i class="fa-solid fa-hand-holding-dollar mr-2 text-jp-sage"></i> Âª∫Ë≠∞ÈÇÑÊ¨æÊñπÊ°à</h3>
                <div class="space-y-2">
                    <div v-for="(txn, idx) in settlements" :key="idx" class="flex items-center justify-between bg-white/80 p-2.5 rounded-xl border border-white">
                        <div class="flex items-center text-sm text-jp-gray-2">
                            <span class="font-bold text-jp-slate">{{ txn.from }}</span>
                            <i class="fa-solid fa-arrow-right-long mx-2 text-jp-silver text-xs"></i>
                            <span class="font-bold text-jp-slate">{{ txn.to }}</span>
                        </div>
                        <div class="text-right">
                            <span class="block font-bold text-jp-sage text-sm font-mono">¬•{{ formatNumber(txn.amount) }}</span>
                            <span class="block text-[9px] text-jp-gray-1">‚âà NT$ {{ formatNumber(Math.round(txn.amountTWD)) }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-t-3xl min-h-[400px] p-6 shadow-[0_-10px_40px_rgba(0,0,0,0.03)] -mx-4 px-8">
                <h3 class="font-bold text-jp-slate mb-5 flex items-center"><i class="fa-solid fa-receipt text-jp-gray-1 mr-2"></i>ÊîØÂá∫Á¥ÄÈåÑ (ÂéüÂßãË≥áÊñô)</h3>
                <div v-if="expenses.length === 0" class="text-center text-jp-silver py-10">Â∞öÁÑ°Á¥ÄÈåÑ</div>
                <div v-else class="space-y-4">
                    <!-- Filtered Expenses Loop (Updated for Edit/Delete Fix) -->
                    <div v-for="(exp, idx) in filteredExpenses" :key="exp.id" class="flex items-start justify-between border-b border-jp-mist/30 pb-3 last:border-0">
                        <div class="flex items-start">
                            <div class="w-10 h-10 rounded-full flex items-center justify-center text-white text-xs mr-3 shadow-sm shrink-0" :class="getCategoryColor(exp.category)">
                                <i :class="getCategoryIcon(exp.category)"></i>
                            </div>
                            <div>
                                <p class="font-bold text-jp-slate text-sm">{{ exp.name }}</p>
                                <p class="text-[10px] text-jp-gray-1 mt-0.5">
                                    <span v-if="exp.category === 'transfer'" class="text-jp-sage font-bold">ËΩâÂ∏≥ÈÇÑÊ¨æ</span>
                                    <span v-else>
                                        <span class="bg-jp-mist/20 px-1.5 py-0.5 rounded text-jp-gray-2 mr-1">{{ exp.payer }}</span>
                                        <span v-if="exp.involved && exp.involved.length < members.length" class="text-jp-rust">({{ exp.involved.length }}‰∫∫)</span>
                                        <span v-else>ÂÖ®È´î</span>
                                    </span>
                                </p>
                            </div>
                        </div>
                        <div class="text-right shrink-0">
                            <p class="font-bold text-jp-slate text-sm">¬•{{ formatNumber(exp.amount) }}</p>
                            <p class="text-[10px] text-jp-gray-1">NT$ {{ formatNumber(exp.amountTWD) }}</p>
                            <div class="flex justify-end gap-2 mt-1">
                                <!-- Pass the expense object directly -->
                                <button @click="copyExpense(exp)" class="text-[10px] text-jp-silver hover:text-jp-sage"><i class="fa-regular fa-copy"></i></button>
                                <button @click="editExpense(exp)" class="text-[10px] text-jp-silver hover:text-jp-slate"><i class="fa-solid fa-pen"></i></button>
                                <button @click="removeExpense(exp)" class="text-[10px] text-jp-silver hover:text-jp-rust"><i class="fa-solid fa-trash-can"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- FAB: Only on shopping/itinerary tabs now -->
    <button v-if="currentTab !== 'info' && currentTab !== 'expenses'" @click="handleAddClick" class="fixed bottom-24 right-6 w-14 h-14 bg-jp-rust rounded-full shadow-[0_4px_15px_rgba(151,102,102,0.5)] text-white text-2xl flex items-center justify-center hover:scale-110 transition-transform z-40">
        <i class="fa-solid fa-plus"></i>
    </button>

    <!-- 1. Ë°åÁ®ã Modal -->
    <div v-if="showItineraryModal" class="fixed inset-0 bg-jp-slate/40 z-50 flex items-center justify-center p-6 backdrop-blur-sm animate-fade-in">
        <div class="bg-white rounded-3xl w-full max-w-sm p-6 shadow-2xl max-h-[90vh] overflow-y-auto">
            <h3 class="font-bold text-lg mb-4 text-center text-jp-slate">{{ isEditMode ? 'Á∑®ËºØË°åÁ®ã' : 'Êñ∞Â¢ûË°åÁ®ã' }}</h3>
            <div class="space-y-3">
                <select v-model="newItinerary.category" class="w-full bg-jp-mist/20 rounded-xl p-3 text-sm outline-none text-jp-slate">
                    <option value="sightseeing">ÊôØÈªû</option>
                    <option value="food">È£≤È£ü</option>
                    <option value="shopping">Ë≥ºÁâ©</option>
                    <option value="accommodation">‰ΩèÂÆø</option>
                    <option value="transport">‰∫§ÈÄö</option>
                    <option value="flight">Ëà™Áè≠</option>
                </select>
                <input v-model="newItinerary.name" placeholder="ÂêçÁ®±" class="w-full bg-jp-mist/20 rounded-xl p-3 text-sm outline-none focus:ring-2 focus:ring-jp-slate text-jp-slate">
                <input v-model="newItinerary.startTime" type="time" class="w-full bg-jp-mist/20 rounded-xl p-3 text-sm outline-none text-jp-slate">
                <input v-model="newItinerary.address" placeholder="Âú∞ÂùÄ" class="w-full bg-jp-mist/20 rounded-xl p-3 text-sm outline-none text-jp-slate">
                <input v-model="newItinerary.price" placeholder="Ë≤ªÁî®" class="w-full bg-jp-mist/20 rounded-xl p-3 text-sm outline-none text-jp-slate">
                <textarea v-model="newItinerary.note" placeholder="ÂÇôË®ª" rows="3" class="w-full bg-jp-mist/20 rounded-xl p-3 text-sm outline-none text-jp-slate"></textarea>
            </div>
            
            <div class="flex space-x-3 mt-6">
                 <!-- ‰øÆÊ≠£ÔºöÁï∂ isEditMode ÁÇ∫ true ÊôÇÈ°ØÁ§∫Âà™Èô§ÊåâÈàï -->
                <button v-if="isEditMode" @click="removeItineraryItem" class="py-3 px-4 rounded-xl bg-jp-rust/10 text-jp-rust font-bold text-sm hover:bg-jp-rust/20"><i class="fa-solid fa-trash-can"></i></button>
                <button @click="showItineraryModal = false" class="flex-1 py-3 rounded-xl bg-jp-mist/30 text-jp-gray-2 font-bold text-sm">ÂèñÊ∂à</button>
                <button @click="saveItineraryItem" class="flex-1 py-3 rounded-xl bg-jp-slate text-white font-bold text-sm shadow-md">{{ isEditMode ? 'Êõ¥Êñ∞' : 'Êñ∞Â¢û' }}</button>
            </div>
        </div>
    </div>

    <!-- 2. Ë≥ºÁâ© Modal -->
    <div v-if="showShoppingModal" class="fixed inset-0 bg-jp-slate/40 z-50 flex items-center justify-center p-6 backdrop-blur-sm animate-fade-in">
        <div class="bg-white rounded-3xl w-full max-w-sm p-6 shadow-2xl">
            <h3 class="font-bold text-lg mb-4 text-center text-jp-slate">Êñ∞Â¢ûË≥ºÁâ©Ê∏ÖÂñÆ</h3>
            <div class="grid grid-cols-3 gap-3 mb-4">
                <div class="col-span-2">
                    <input v-model="newShoppingItem.name" type="text" placeholder="ÂïÜÂìÅÂêçÁ®±" class="w-full bg-jp-mist/20 rounded-xl p-3 text-sm focus:outline-none focus:ring-2 focus:ring-jp-slate text-jp-slate">
                </div>
                <div>
                    <input v-model="newShoppingItem.qty" type="number" placeholder="Êï∏Èáè" class="w-full bg-jp-mist/20 rounded-xl p-3 text-sm focus:outline-none text-jp-slate">
                </div>
            </div>
            
            <div class="mb-4">
                <label class="block text-xs font-bold text-jp-gray-1 mb-2 pl-1">ÊåáÂÆöË≥ºË≤∑‰∫∫</label>
                <div class="flex gap-2 overflow-x-auto pb-2 hide-scrollbar">
                    <button v-for="m in members" :key="m"
                            @click="newShoppingItem.buyer = m"
                            :class="newShoppingItem.buyer === m ? 'bg-jp-slate text-white shadow-md' : 'bg-jp-mist/20 text-jp-gray-2 border border-jp-mist/30'"
                            class="whitespace-nowrap px-3 py-1.5 rounded-lg text-xs font-bold transition-all">
                        {{ m }}
                    </button>
                </div>
            </div>

            <div class="mb-6">
                <label class="block text-xs font-bold text-jp-gray-1 mb-2 pl-1">ÂïÜÂìÅÂàÜÈ°û</label>
                <div class="grid grid-cols-3 gap-2">
                    <button v-for="cat in shoppingCategories" :key="cat.id" 
                            @click="newShoppingItem.category = cat.id"
                            :class="newShoppingItem.category === cat.id ? 'bg-jp-slate text-white shadow-md' : 'bg-jp-mist/20 text-jp-gray-2 hover:bg-jp-mist/30'"
                            class="py-2.5 rounded-xl text-xs font-bold transition-all flex items-center justify-center">
                        <i :class="cat.icon" class="mr-1.5"></i> {{ cat.name }}
                    </button>
                </div>
            </div>

            <div class="flex space-x-3">
                <button @click="showShoppingModal = false" class="flex-1 py-3 rounded-xl bg-jp-mist/30 text-jp-gray-2 font-bold text-sm">ÂèñÊ∂à</button>
                <button @click="addShoppingItem" class="flex-1 py-3 rounded-xl bg-jp-slate text-white font-bold text-sm shadow-md">Êñ∞Â¢û</button>
            </div>
        </div>
    </div>

    <!-- 3. Êñ∞Â¢ûËä±Ë≤ª Modal -->
    <div v-if="showExpenseModal" class="fixed inset-0 bg-jp-slate/40 z-50 flex items-center justify-center p-6 backdrop-blur-sm animate-fade-in">
        <div class="bg-white rounded-3xl w-full max-w-sm p-6 shadow-2xl max-h-[95vh] overflow-y-auto">
            <h3 class="font-bold text-lg mb-4 text-center text-jp-slate">{{ isExpenseEditMode ? 'Á∑®ËºØÊîØÂá∫' : 'Ë®ò‰∏ÄÁ≠Ü' }}</h3>
            
            <div class="flex mb-5 bg-jp-mist/20 p-1 rounded-xl">
                <button @click="newExpense.type = 'expense'" :class="newExpense.type === 'expense' ? 'bg-white shadow text-jp-slate' : 'text-jp-gray-1'" class="flex-1 py-2 rounded-lg text-sm font-bold transition-all">‰∏ÄËà¨Ê∂àË≤ª</button>
                <button @click="newExpense.type = 'transfer'" :class="newExpense.type === 'transfer' ? 'bg-white shadow text-jp-sage' : 'text-jp-gray-1'" class="flex-1 py-2 rounded-lg text-sm font-bold transition-all">ËΩâÂ∏≥ÈÇÑÊ¨æ</button>
            </div>

            <div class="mb-4 bg-jp-mist/10 p-3 rounded-xl border border-jp-mist/30 flex justify-between items-center">
                <span class="text-xs text-jp-gray-1 font-bold">Êú¨Á≠ÜÂåØÁéá</span>
                <div class="flex items-center">
                    <span class="text-xs text-jp-gray-1 mr-1">1 JPY =</span>
                    <input v-model="newExpense.customRate" @input="onRateInput" type="number" step="0.001" class="w-14 bg-white border border-jp-silver rounded px-1 py-0.5 text-sm text-right outline-none focus:border-jp-slate text-jp-slate">
                    <span class="text-xs text-jp-gray-1 ml-1">TWD</span>
                </div>
            </div>

            <div v-if="newExpense.type === 'expense'">
                <div class="grid grid-cols-2 gap-3 mb-3">
                    <input v-model="newExpense.date" type="date" class="bg-jp-mist/20 rounded-xl p-3 text-sm outline-none text-jp-slate">
                    <select v-model="newExpense.category" class="bg-jp-mist/20 rounded-xl p-3 text-sm outline-none text-jp-slate">
                        <option value="food">È£≤È£ü</option>
                        <option value="shopping">Ë≥ºÁâ©</option>
                        <option value="transport">‰∫§ÈÄö</option>
                        <option value="stay">‰ΩèÂÆø</option>
                        <option value="ticket">ÈñÄÁ•®</option>
                        <option value="entertainment">Â®õÊ®Ç</option>
                        <option value="communication">Á∂≤Âç°/ÈÄöË®ä</option>
                        <option value="medical">ÈÜ´Ëó•</option>
                        <option value="other">ÂÖ∂‰ªñ/ÈõúÊîØ</option>
                    </select>
                </div>
                <input v-model="newExpense.name" placeholder="È†ÖÁõÆÂêçÁ®±" class="w-full bg-jp-mist/20 rounded-xl p-4 mb-4 text-sm focus:outline-none text-jp-slate">
                
                <div class="grid grid-cols-2 gap-3 mb-4">
                    <div class="relative">
                        <span class="absolute left-3 top-3 text-jp-gray-1 font-bold text-xs">JPY</span>
                        <input v-model.number="newExpense.amount" @input="onJPYInput" type="number" placeholder="Êó•Âπ£" class="w-full bg-jp-mist/20 rounded-xl p-3 pl-10 text-sm outline-none focus:ring-2 focus:ring-jp-slate text-jp-slate font-bold">
                    </div>
                    <div class="relative">
                        <span class="absolute left-3 top-3 text-jp-gray-1 font-bold text-xs">TWD</span>
                        <input v-model.number="newExpense.amountTWD" @input="onTWDInput" type="number" placeholder="Âè∞Âπ£" class="w-full bg-jp-mist/20 rounded-xl p-3 pl-10 text-sm outline-none focus:ring-2 focus:ring-jp-slate text-jp-slate">
                    </div>
                </div>

                <div class="flex space-x-3 mb-4">
                    <button @click="newExpense.payment='cash'" :class="newExpense.payment==='cash' ? 'bg-jp-slate text-white' : 'bg-jp-mist/20 text-jp-gray-2'" class="flex-1 py-2 rounded-xl text-sm transition-colors font-bold"><i class="fa-solid fa-coins mr-1"></i> ÁèæÈáë</button>
                    <button @click="newExpense.payment='card'" :class="newExpense.payment==='card' ? 'bg-jp-slate text-white' : 'bg-jp-mist/20 text-jp-gray-2'" class="flex-1 py-2 rounded-xl text-sm transition-colors font-bold"><i class="fa-regular fa-credit-card mr-1"></i> ‰ø°Áî®Âç°</button>
                </div>

                <div class="mb-6 border-t border-jp-mist/30 pt-4">
                    <label class="block text-xs font-bold text-jp-gray-1 mb-2">‰ªòÊ¨æ‰∫∫ (Ë™∞ÂÖàÂ¢ä?)</label>
                    <select v-model="newExpense.payer" class="w-full bg-jp-mist/30 text-jp-slate font-bold rounded-xl p-3 text-sm outline-none mb-4">
                        <option v-for="m in members" :key="m" :value="m">{{ m }}</option>
                    </select>
                    <div class="flex justify-between items-center mb-2">
                        <label class="block text-xs font-bold text-jp-gray-1">ÂàÜÊî§Â∞çË±°</label>
                        <button @click="toggleSelectAll" class="text-xs text-jp-slate font-bold">{{ newExpense.involved.length === members.length ? 'ÂÖ®ÂèñÊ∂à' : 'ÂÖ®ÈÅ∏' }}</button>
                    </div>
                    <div class="grid grid-cols-2 gap-2 mb-3">
                        <label v-for="m in members" :key="m" class="cursor-pointer relative">
                            <input type="checkbox" :value="m" v-model="newExpense.involved" class="member-checkbox hidden">
                            <div class="bg-jp-mist/20 border border-jp-mist/50 rounded-lg p-2 text-center text-xs text-jp-gray-2 transition-colors hover:bg-jp-mist/40">{{ m }}</div>
                        </label>
                    </div>
                    <div v-if="newExpense.amount > 0 && newExpense.involved.length > 0" class="bg-jp-beige/30 rounded-xl p-3 flex justify-between items-center">
                        <span class="text-xs text-jp-rust">ÊØè‰∫∫Êáâ‰ªò</span>
                        <span class="font-bold text-jp-rust">¬• {{ formatNumber(Math.ceil(newExpense.amount / newExpense.involved.length)) }}</span>
                    </div>
                </div>
            </div>

            <div v-else>
                <div class="mb-4">
                    <input v-model="newExpense.date" type="date" class="w-full bg-jp-mist/20 rounded-xl p-3 text-sm outline-none mb-4 text-jp-slate">
                    
                    <div class="flex items-center justify-between gap-2 mb-4">
                        <div class="flex-1">
                            <label class="block text-xs font-bold text-jp-gray-1 mb-1">ËΩâÂá∫ (ÈÇÑÈå¢)</label>
                            <select v-model="newExpense.payer" class="w-full bg-jp-rust/10 text-jp-rust font-bold rounded-xl p-3 text-sm outline-none">
                                <option v-for="m in members" :key="m" :value="m">{{ m }}</option>
                            </select>
                        </div>
                        <i class="fa-solid fa-arrow-right text-jp-silver mt-4"></i>
                        <div class="flex-1">
                            <label class="block text-xs font-bold text-jp-gray-1 mb-1">ËΩâÂÖ• (Êî∂Èå¢)</label>
                            <select v-model="newExpense.payee" class="w-full bg-jp-sage/20 text-jp-sage font-bold rounded-xl p-3 text-sm outline-none">
                                <option v-for="m in members" :key="m" :value="m">{{ m }}</option>
                            </select>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-3 mb-4">
                        <div class="relative">
                            <span class="absolute left-3 top-3 text-jp-gray-1 font-bold text-xs">JPY</span>
                            <input v-model.number="newExpense.amount" @input="onJPYInput" type="number" placeholder="Êó•Âπ£" class="w-full bg-jp-mist/20 rounded-xl p-3 pl-10 text-sm outline-none focus:ring-2 focus:ring-jp-sage font-bold text-jp-sage">
                        </div>
                        <div class="relative">
                            <span class="absolute left-3 top-3 text-jp-gray-1 font-bold text-xs">TWD</span>
                            <input v-model.number="newExpense.amountTWD" @input="onTWDInput" type="number" placeholder="Âè∞Âπ£" class="w-full bg-jp-mist/20 rounded-xl p-3 pl-10 text-sm outline-none focus:ring-2 focus:ring-jp-sage">
                        </div>
                    </div>
                </div>
            </div>

            <div class="flex space-x-3">
                <button @click="showExpenseModal = false" class="flex-1 py-3 rounded-xl bg-jp-mist/30 text-jp-gray-2 font-bold text-sm">ÂèñÊ∂à</button>
                <button @click="saveExpense" class="flex-1 py-3 rounded-xl bg-jp-rust text-white font-bold text-sm shadow-md">ÂÑ≤Â≠ò</button>
            </div>
        </div>
    </div>

</div>

<!-- Firebase SDK -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
    import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
    import { createApp, ref, computed, onMounted, watch, nextTick } from "https://unpkg.com/vue@3/dist/vue.esm-browser.js";

    // Use system config
    const firebaseConfig = JSON.parse(__firebase_config);
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

    let app;
    let db;
    let auth;
    try { 
        app = initializeApp(firebaseConfig); 
        db = getFirestore(app);
        auth = getAuth(app);
    } catch (e) { console.error("Firebase Init Failed", e); }

    createApp({
        setup() {
            const currentTab = ref('itinerary');
            const selectedDateIndex = ref(0);
            const isConnected = ref(false);
            const statusMessage = ref('ÈÄ£Á∑ö‰∏≠...');
            const isDataLoaded = ref(false); // Added loading state
            const exchangeRate = ref(0.22);
            // currencyInput removed
            const members = ref(['ÂæêÁ∫åÁ∞°ÈÄ≤', 'Â≠´Âê≥Á©∫', 'Âê≥Âè§ÈõúÁ≥ß', '‰ΩïËï≠‰∫ÜÂóé', 'Èô≥ÈªÉÂªü']);
            const selectedMemberName = ref(members.value[0]); 
            
            const shoppingCategories = [
                { id: 'souvenir', name: '‰º¥ÊâãÁ¶Æ', color: 'bg-jp-rose', icon: 'fa-solid fa-gift' },
                { id: 'snack', name: 'Èõ∂È£ü', color: 'bg-jp-sand', icon: 'fa-solid fa-cookie-bite' },
                { id: 'drug', name: 'Ëó•Â¶ù', color: 'bg-jp-rust', icon: 'fa-solid fa-pump-soap' },
                { id: 'electric', name: 'ÈõªÂô®', color: 'bg-jp-slate', icon: 'fa-solid fa-plug' },
                { id: 'clothes', name: 'ÊúçÈ£æ', color: 'bg-jp-sage', icon: 'fa-solid fa-shirt' },
                { id: 'other', name: 'ÂÖ∂‰ªñ', color: 'bg-jp-gray-1', icon: 'fa-solid fa-bag-shopping' }
            ];

            const shoppingList = ref([]);
            const expenses = ref([]);
            const itineraryData = ref([]);
            const mustBuyList = ref([]);

            // Filters
            const filterMember = ref('all');
            const filterCategory = ref('all');

            const showItineraryModal = ref(false);
            const showShoppingModal = ref(false);
            const showExpenseModal = ref(false);
            const isEditMode = ref(false);
            const isMustBuyEditMode = ref(false);
            const newRegionName = ref('');
            const isRemoteUpdate = ref(false);
            
            // New state for expense editing
            const isExpenseEditMode = ref(false);
            const editingExpenseIndex = ref(null);
            const editingExpenseId = ref(null); // Use ID for editing tracking

            const newItinerary = ref({ id: null, category: 'sightseeing', name: '', startTime: '', address: '', price: '', note: '' });
            const newShoppingItem = ref({ name: '', qty: 1, category: 'souvenir', buyer: '' });
            
            const newExpense = ref({ 
                type: 'expense', name: '', amount: null, amountTWD: null, 
                customRate: 0.22, category: 'food', date: '2026-03-06', 
                payment: 'cash', payer: members.value[0], payee: members.value[1], involved: [...members.value] 
            });

            const onJPYInput = () => { if(newExpense.value.amount) newExpense.value.amountTWD = Math.round(newExpense.value.amount * newExpense.value.customRate); else newExpense.value.amountTWD = null; };
            const onTWDInput = () => { if(newExpense.value.amountTWD) newExpense.value.amount = Math.round(newExpense.value.amountTWD / newExpense.value.customRate); else newExpense.value.amount = null; };
            const onRateInput = () => { if(newExpense.value.amount) newExpense.value.amountTWD = Math.round(newExpense.value.amount * newExpense.value.customRate); };

            // Info Tab Calculator Logic (Bi-directional)
            const calcJPY = ref(50000); 
            const calcTWD = ref(Math.round(50000 * 0.22));
            const calculateTWD = () => { if (calcJPY.value !== '') calcTWD.value = Math.round(calcJPY.value * exchangeRate.value); };
            const calculateJPY = () => { if (calcTWD.value !== '') calcJPY.value = Math.round(calcTWD.value / exchangeRate.value); };
            const onExchangeRateChange = () => { triggerSync(); calculateTWD(); };

            const CATEGORY_MAP = { 
                sightseeing: { color: 'bg-jp-sage', icon: 'fa-solid fa-camera' }, 
                food: { color: 'bg-jp-rust', icon: 'fa-solid fa-utensils' }, 
                shopping: { color: 'bg-jp-rose', icon: 'fa-solid fa-bag-shopping' }, 
                accommodation: { color: 'bg-jp-slate', icon: 'fa-solid fa-bed' }, 
                flight: { color: 'bg-jp-gray-1', icon: 'fa-solid fa-plane' }, 
                transport: { color: 'bg-jp-gray-2', icon: 'fa-solid fa-van-shuttle' }, 
                ticket: { color: 'bg-jp-sage', icon: 'fa-solid fa-ticket' }, 
                stay: { color: 'bg-jp-slate', icon: 'fa-solid fa-hotel' }, 
                transfer: { color: 'bg-jp-sage', icon: 'fa-solid fa-money-bill-transfer' },
                entertainment: { color: 'bg-jp-sand', icon: 'fa-solid fa-gamepad' },
                communication: { color: 'bg-jp-gray-2', icon: 'fa-solid fa-wifi' },
                medical: { color: 'bg-jp-rose', icon: 'fa-solid fa-kit-medical' },
                other: { color: 'bg-jp-silver', icon: 'fa-solid fa-ellipsis' }
            };
            const CATEGORY_MAP_NAME = { sightseeing: 'ÊôØÈªû', food: 'È£≤È£ü', shopping: 'Ë≥ºÁâ©', accommodation: '‰ΩèÂÆø', flight: 'Ê©üÁ•®', transport: '‰∫§ÈÄö', ticket: 'ÈñÄÁ•®', stay: '‰ΩèÂÆø', transfer: 'ËΩâÂ∏≥', entertainment: 'Â®õÊ®Ç', communication: 'ÈÄöË®ä', medical: 'ÈÜ´Ëó•', other: 'ÂÖ∂‰ªñ' };
            const CATEGORY_HEX = { sightseeing: '#A9B7AA', food: '#976666', shopping: '#C09D9B', accommodation: '#7A848D', flight: '#999EA2', transport: '#93939B', ticket: '#A9B7AA', stay: '#7A848D', transfer: '#A9B7AA', entertainment: '#DBD2C9', communication: '#93939B', medical: '#C09D9B', other: '#BEBEBE' };

            const dates = ref([
                { dayLabel: 'Day 1', date: '03/06', weekday: '‰∫î', area: 'ÊòüÈáé', temp: '-2¬∞C', weather: 'snow', transport: 'ÂåÖËªä' }, 
                { dayLabel: 'Day 2', date: '03/07', weekday: 'ÂÖ≠', area: 'ÂÆöÂ±±Ê∫™/Êú≠Âπå', temp: '0¬∞C', weather: 'cloudy', transport: 'ÂåÖËªä' }, 
                { dayLabel: 'Day 3', date: '03/08', weekday: 'Êó•', area: 'ÁôªÂà•/ÂáΩÈ§®', temp: '2¬∞C', weather: 'sunny', transport: 'ÂåÖËªä' }, 
                { dayLabel: 'Day 4', date: '03/09', weekday: '‰∏Ä', area: 'ÂáΩÈ§®', temp: '3¬∞C', weather: 'sunny', transport: 'Â∏ÇÈõª' }, 
                { dayLabel: 'Day 5', date: '03/10', weekday: '‰∫å', area: 'ÂáΩÈ§®/Êú≠Âπå', temp: '1¬∞C', weather: 'cloudy', transport: 'JR' }, 
                { dayLabel: 'Day 6', date: '03/11', weekday: '‰∏â', area: 'Â∞èÊ®Ω', temp: '-1¬∞C', weather: 'snow', transport: 'JR' }, 
                { dayLabel: 'Day 7', date: '03/12', weekday: 'Âõõ', area: 'Êó≠Â±±', temp: '-5¬∞C', weather: 'snow', transport: 'Â∑¥Â£´' }, 
                { dayLabel: 'Day 8', date: '03/13', weekday: '‰∫î', area: 'Êú≠Âπå', temp: '1¬∞C', weather: 'cloudy', transport: 'Âú∞Èêµ' }, 
                { dayLabel: 'Day 9', date: '03/14', weekday: 'ÂÖ≠', area: 'ÂõûÁ®ã', temp: '2¬∞C', weather: 'sunny', transport: 'È£õÊ©ü' }
            ]);
            
            const hotels = ref([{ name: 'ÊòüÈáé„É™„Çæ„Éº„Éà „Éà„Éû„É† The Tower', date: '3/06', address: 'ÂåóÊµ∑ÈÅìÂãáÊâïÈÉ°Âç†ÂÜ†Êùë‰∏≠„Éà„Éû„É†' }, { name: 'Vessel Inn Êú≠Âπå‰∏≠Â≥∂ÂÖ¨Âúí', date: '3/07', address: 'Êú≠ÂπåÂ∏Ç‰∏≠Â§ÆÂçÄÂçó‰πùÊ¢ùË•ø4-1-2' }, { name: 'OMO5 ÂáΩÈ§® by ÊòüÈáéÈõÜÂúò', date: '3/08', address: 'ÂáΩÈ§®Â∏ÇËã•ÊùæÁî∫24Áï™1' }, { name: 'Royal Park Canvas Êú≠ÂπåÂ§ßÈÄöÂÖ¨Âúí', date: '3/10', address: 'Êú≠ÂπåÂ∏Ç‰∏≠Â§ÆÂå∫Â§ßÈÄöË•ø1-12' }]);
            
            const inboundFlights = ref([
                { airline: '‰∏≠ËèØËà™Á©∫', code: 'CI131', depTime: '14:40', arrTime: '18:15', arrTerminal: 'TPE T2' },
                { airline: 'ÊòüÂÆáËà™Á©∫', code: 'JX851', depTime: '15:20', arrTime: '19:05', arrTerminal: 'TPE T1' },
                { airline: 'ÈÖ∑Ëà™', code: 'TR893', depTime: '18:40', arrTime: '22:20', arrTerminal: 'TPE T1' }
            ]);

            // Removed currencyResult as it is no longer used directly in template (using calcTWD)
            const currentItinerary = computed(() => itineraryData.value[selectedDateIndex.value] || []);
            
            // Computed for filtered expenses
            const filteredExpenses = computed(() => {
                return expenses.value.filter(exp => {
                    const matchMember = filterMember.value === 'all' || exp.payer === filterMember.value || (exp.involved && exp.involved.includes(filterMember.value));
                    const matchCategory = filterCategory.value === 'all' || exp.category === filterCategory.value;
                    return matchMember && matchCategory;
                }).sort((a, b) => new Date(b.date) - new Date(a.date)); // Sort by date desc
            });
            
            // The Main Logic for Analysis Section
            const analysisItems = computed(() => {
                let items = [];
                if (filterMember.value === 'all') {
                    // All: Show total expense items (Raw)
                    // EXCLUDE TRANSFERS HERE
                    items = expenses.value.filter(e => e.category !== 'transfer' && e.type !== 'transfer').map(e => ({
                        ...e,
                        displayAmount: e.amount,
                        displayAmountTWD: e.amountTWD,
                        isShare: false
                    }));
                } else {
                    // Personal: Show share items from balanceSheet
                    // transfers already excluded in balanceSheet logic
                    const memberData = balanceSheet.value.find(m => m.name === filterMember.value);
                    if(memberData) {
                         // We need to map consumptionItems to include 'payer' etc which I added earlier
                         items = memberData.consumptionItems.map(item => ({
                             ...item,
                             displayAmount: item.amount,
                             displayAmountTWD: item.amountTWD,
                             isShare: true
                         }));
                    }
                }
                
                // Filter by Category
                if(filterCategory.value !== 'all') {
                    items = items.filter(i => i.category === filterCategory.value);
                }
                
                return items.sort((a,b) => new Date(b.date) - new Date(a.date));
            });

            const totalExpensesTWD = computed(() => expenses.value.filter(e => e.category !== 'transfer').reduce((sum, e) => sum + (e.amountTWD || Math.round(e.amount * (e.customRate || exchangeRate.value))), 0));
            const totalExpensesJPY = computed(() => expenses.value.filter(e => e.category !== 'transfer').reduce((sum, e) => sum + (e.amount || 0), 0));
            
            const balanceSheet = computed(() => {
                const balances = {};
                members.value.forEach(m => balances[m] = { 
                    name: m, 
                    paid: 0, share: 0, balance: 0, 
                    paidTWD: 0, shareTWD: 0, balanceTWD: 0, 
                    paidCash: 0, paidCard: 0, 
                    transferReceived: 0, // NEW field
                    categoryBreakdown: {},
                    consumptionItems: [] 
                });
                
                Object.keys(CATEGORY_MAP).forEach(cat => { members.value.forEach(m => balances[m].categoryBreakdown[cat] = 0) });

                expenses.value.forEach(exp => {
                    const rate = exp.customRate || exchangeRate.value;
                    const jpy = exp.amount;
                    const twd = exp.amountTWD || Math.round(jpy * rate);
                    
                    // Robust check for transfer
                    const isTransfer = exp.category === 'transfer' || exp.type === 'transfer';

                    if (isTransfer) {
                        if (balances[exp.payer]) { balances[exp.payer].paid += jpy; balances[exp.payer].paidTWD += twd; }
                        // For transfer, the receiver (involved[0]) gets "transferReceived", NOT share.
                        if (balances[exp.involved[0]]) { 
                            // balances[exp.involved[0]].share += jpy; // OLD LOGIC REMOVED
                            balances[exp.involved[0]].transferReceived += jpy; // NEW LOGIC
                        }
                    } else {
                        if (balances[exp.payer]) { 
                            balances[exp.payer].paid += jpy; 
                            balances[exp.payer].paidTWD += twd;
                            if(exp.payment === 'cash') balances[exp.payer].paidCash += jpy;
                            if(exp.payment === 'card') balances[exp.payer].paidCard += jpy;
                        }
                        if (exp.involved && exp.involved.length > 0) {
                            const shareJPY = jpy / exp.involved.length;
                            const shareTWD = twd / exp.involved.length;
                            exp.involved.forEach(p => { 
                                if(balances[p]) {
                                    balances[p].share += shareJPY;
                                    balances[p].shareTWD += shareTWD;
                                    if(balances[p].categoryBreakdown[exp.category] !== undefined) balances[p].categoryBreakdown[exp.category] += shareJPY;
                                    else balances[p].categoryBreakdown[exp.category] = shareJPY; // Handle newly added categories
                                    
                                    // Add to consumptionItems list
                                    balances[p].consumptionItems.push({
                                        id: exp.id, 
                                        date: exp.date,
                                        name: exp.name,
                                        category: exp.category,
                                        amount: shareJPY,
                                        amountTWD: shareTWD,
                                        payer: exp.payer, // Ensure payer is passed
                                        type: exp.type // Ensure type is passed
                                    });
                                }
                            });
                        }
                    }
                });
                // Updated balance formula: Paid - Share - ReceivedTransfer
                return Object.values(balances).map(m => { 
                    m.balance = Math.round(m.paid - m.share - m.transferReceived); 
                    m.balanceTWD = Math.round(m.paidTWD - m.shareTWD - (m.transferReceived * exchangeRate.value)); // approx
                    return m; 
                });
            });

            const selectedMemberData = computed(() => balanceSheet.value.find(m => m.name === selectedMemberName.value));
            
            const getPieChartGradient = (memberData) => {
                if (!memberData || !memberData.categoryBreakdown) return 'conic-gradient(#ddd 0% 100%)';
                const total = memberData.share || 1;
                let currentAngle = 0;
                const gradientParts = [];
                Object.entries(memberData.categoryBreakdown).forEach(([cat, amount]) => {
                    if (amount > 0) {
                        const percentage = (amount / total) * 100;
                        const color = CATEGORY_HEX[cat] || '#ccc';
                        const start = currentAngle;
                        const end = currentAngle + percentage;
                        gradientParts.push(`${color} ${start}% ${end}%`);
                        currentAngle = end;
                    }
                });
                if (gradientParts.length === 0) return 'conic-gradient(#f0f0f0 0% 100%)';
                return `conic-gradient(${gradientParts.join(', ')})`;
            };
            
            // Filtered Chart Data Helper
            const getFilterPieChartGradient = (filteredList) => {
                if (!filteredList || filteredList.length === 0) return 'conic-gradient(#ddd 0% 100%)';
                const total = filteredList.reduce((s, e) => s + (e.displayAmount || 0), 0) || 1;
                const breakdown = {};
                filteredList.forEach(e => {
                     breakdown[e.category] = (breakdown[e.category] || 0) + (e.displayAmount || 0);
                });
                
                let currentAngle = 0;
                const gradientParts = [];
                Object.entries(breakdown).forEach(([cat, amount]) => {
                     if (amount > 0) {
                        const percentage = (amount / total) * 100;
                        const color = CATEGORY_HEX[cat] || '#ccc';
                        const start = currentAngle;
                        const end = currentAngle + percentage;
                        gradientParts.push(`${color} ${start}% ${end}%`);
                        currentAngle = end;
                     }
                });
                return `conic-gradient(${gradientParts.join(', ')})`;
            };
            
            const getFilteredCategoryStats = (filteredList) => {
                const breakdown = {};
                const breakdownTWD = {};
                filteredList.forEach(e => {
                     breakdown[e.category] = (breakdown[e.category] || 0) + (e.displayAmount || 0);
                     breakdownTWD[e.category] = (breakdownTWD[e.category] || 0) + (e.displayAmountTWD || 0);
                });
                return Object.entries(breakdown)
                      .map(([cat, amount]) => ({ category: cat, total: amount, totalTWD: breakdownTWD[cat] }))
                      .sort((a,b) => b.total - a.total);
            };

            const getPaymentPieChartGradient = (memberData) => {
                if (!memberData || (memberData.paidCash === 0 && memberData.paidCard === 0)) return 'conic-gradient(#ddd 0% 100%)';
                const total = memberData.paidCash + memberData.paidCard;
                const cashPercent = (memberData.paidCash / total) * 100;
                // Cash: m-rust (#976666), Card: m-charcoal (#7A848D)
                return `conic-gradient(#976666 0% ${cashPercent}%, #7A848D ${cashPercent}% 100%)`;
            };

            const settlements = computed(() => {
                let debts = balanceSheet.value.filter(m => m.balance < -10).map(m => ({...m}));
                let credits = balanceSheet.value.filter(m => m.balance > 10).map(m => ({...m}));
                debts.sort((a, b) => a.balance - b.balance); credits.sort((a, b) => b.balance - a.balance);
                const result = []; let i = 0, j = 0;
                while(i < debts.length && j < credits.length) {
                    let debtor = debts[i], creditor = credits[j];
                    let amount = Math.min(Math.abs(debtor.balance), creditor.balance);
                    if(amount > 0) {
                        const amountTWD = amount * exchangeRate.value; 
                        result.push({ from: debtor.name, to: creditor.name, amount: Math.round(amount), amountTWD: Math.round(amountTWD) });
                    }
                    debtor.balance += amount; creditor.balance -= amount;
                    if(Math.abs(debtor.balance) < 10) i++; if(Math.abs(creditor.balance) < 10) j++;
                }
                return result;
            });

            const syncStatusClass = computed(() => { 
                if (statusMessage.value.includes('Â§±Êïó')) return 'error';
                if(statusMessage.value === 'ÂÑ≤Â≠ò‰∏≠...') return 'busy'; 
                if(isConnected.value) return 'online'; 
                return ''; 
            });
            
            let debounceTimer = null;
            const triggerSync = () => { if (isRemoteUpdate.value) return; statusMessage.value = 'ÂÑ≤Â≠ò‰∏≠...'; clearTimeout(debounceTimer); debounceTimer = setTimeout(syncData, 1500); };

            const DB_COLLECTION = "hokkaido_trip_v4"; // Using proper collection name structure for the app
            const DB_DOC_ID = "main_data";

            const syncData = () => {
                if (!db || !auth.currentUser) return; // Ensure auth
                
                const userId = auth.currentUser.uid;
                // Path: artifacts/{appId}/public/data/{collectionName}/{docId}
                // We use public data for sharing
                setDoc(doc(db, 'artifacts', appId, 'public', 'data', DB_COLLECTION, DB_DOC_ID), {
                    shoppingList: shoppingList.value,
                    expenses: expenses.value,
                    itineraryData: JSON.stringify(itineraryData.value),
                    mustBuyList: mustBuyList.value,
                    exchangeRate: exchangeRate.value,
                    lastUpdated: new Date().toISOString() // Store as ISO string
                }).then(() => { statusMessage.value = 'Â∑≤ÂêåÊ≠•'; isConnected.value = true; }).catch(err => { statusMessage.value = 'ÂêåÊ≠•Â§±Êïó'; console.error(err); });
            };

            watch([shoppingList, expenses, itineraryData, mustBuyList, exchangeRate], () => { if (isRemoteUpdate.value) return; triggerSync(); }, { deep: true });

            onMounted(async () => {
                if (auth) {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                        
                        // Path: artifacts/{appId}/public/data/{collectionName}/{docId}
                        const docRef = doc(db, 'artifacts', appId, 'public', 'data', DB_COLLECTION, DB_DOC_ID);
                        
                        onSnapshot(docRef, (docSnapshot) => {
                            isDataLoaded.value = true;
                            if (docSnapshot.exists()) {
                                isRemoteUpdate.value = true;
                                const data = docSnapshot.data();
                                if(data.shoppingList) shoppingList.value = data.shoppingList;
                                if(data.expenses) {
                                    expenses.value = data.expenses.map(e => ({...e, id: e.id || Date.now() + Math.random()}));
                                }
                                if(data.itineraryData) { try { itineraryData.value = typeof data.itineraryData === 'string' ? JSON.parse(data.itineraryData) : data.itineraryData; } catch(e) {} }
                                if(data.mustBuyList) mustBuyList.value = data.mustBuyList;
                                if(data.exchangeRate) exchangeRate.value = data.exchangeRate;
                                isConnected.value = true; 
                                statusMessage.value = 'ÈÄ£Á∑öÊ≠£Â∏∏';
                                nextTick(() => { isRemoteUpdate.value = false; });
                            } else {
                                // Only populate if doc really doesn't exist and we are connected
                                console.log("No document found, initializing...");
                                itineraryData.value = populateInitialData();
                                syncData();
                            }
                            initSortable();
                        }, (error) => {
                            console.error("Snapshot error:", error);
                            statusMessage.value = "ËÆÄÂèñÂ§±Êïó: " + error.code;
                            isDataLoaded.value = true; // Show content even if error, might be empty
                        });

                    } catch (error) {
                        console.error("Auth Error:", error);
                        statusMessage.value = "ÁôªÂÖ•Â§±Êïó";
                        isDataLoaded.value = true;
                    }
                } else {
                    isDataLoaded.value = true; // Fallback
                    itineraryData.value = populateInitialData();
                }
            });

            const initSortable = () => {
                const el = document.getElementById('itinerary-list');
                if (el) {
                    Sortable.create(el, {
                        handle: '.drag-handle',
                        animation: 150,
                        onEnd: (evt) => {
                            const list = itineraryData.value[selectedDateIndex.value];
                            const item = list.splice(evt.oldIndex, 1)[0];
                            list.splice(evt.newIndex, 0, item);
                            triggerSync();
                        }
                    });
                }
            };
            
            watch(selectedDateIndex, () => { nextTick(() => { initSortable(); }); });

            const formatNumber = (num) => num ? num.toLocaleString() : '0';
            
            const getCategoryColor = (cat) => CATEGORY_MAP[cat]?.color || 'bg-m-gray';
            const getCategoryIcon = (cat) => CATEGORY_MAP[cat]?.icon || 'fa-solid fa-circle';
            const getShoppingCategoryColor = (id) => shoppingCategories.find(c => c.id === id)?.color || 'bg-m-slate';
            const getShoppingCategoryIcon = (id) => shoppingCategories.find(c => c.id === id)?.icon || 'fa-solid fa-bag-shopping';
            const getShoppingCategoryName = (id) => shoppingCategories.find(c => c.id === id)?.name || 'ÂÖ∂‰ªñ';
            const getWeatherIcon = (w) => w === 'snow' ? 'fa-solid fa-snowflake' : (w === 'sunny' ? 'fa-solid fa-sun' : 'fa-solid fa-cloud');
            const openMap = (q) => window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(q)}`, '_blank');
            const handleAddClick = () => {
                if (currentTab.value === 'itinerary') { isEditMode.value = false; newItinerary.value = { category: 'sightseeing' }; showItineraryModal.value = true; }
                else if (currentTab.value === 'shopping') { newShoppingItem.value = { name: '', qty: 1, category: 'souvenir', buyer: members.value[0] }; showShoppingModal.value = true; }
                else if (currentTab.value === 'expenses') { 
                    newExpense.value = { 
                        type: 'expense', 
                        category: 'food', payment: 'cash', date: '2026-03-06', 
                        payer: members.value[0], payee: members.value[1], involved: [...members.value], 
                        amount: null, amountTWD: null, name: '', customRate: exchangeRate.value 
                    }; 
                    showExpenseModal.value = true; 
                    isExpenseEditMode.value = false; // Ensure Add mode
                    editingExpenseIndex.value = null;
                    editingExpenseId.value = null;
                }
            };
            const toggleSelectAll = () => newExpense.value.involved = newExpense.value.involved.length === members.value.length ? [] : [...members.value];
            const saveItineraryItem = () => {
                if(!newItinerary.value.name) return;
                const newItem = { 
                    ...newItinerary.value, 
                    isNoteExpanded: false
                };
                // Make sure ID exists
                if(!newItem.id) newItem.id = Date.now();
                
                if(isEditMode.value) {
                    const idx = currentItinerary.value.findIndex(i => i.id === newItem.id);
                    if(idx !== -1) currentItinerary.value[idx] = newItem;
                } else {
                    if(!itineraryData.value[selectedDateIndex.value]) itineraryData.value[selectedDateIndex.value] = [];
                    itineraryData.value[selectedDateIndex.value].push(newItem);
                }
                showItineraryModal.value = false; triggerSync();
            };
            const removeItineraryItem = () => {
                // Remove the currently editing item
                const idx = currentItinerary.value.findIndex(i => i.id === newItinerary.value.id);
                if(idx !== -1) {
                    if(confirm("Á¢∫ÂÆöË¶ÅÂà™Èô§Ê≠§Ë°åÁ®ãÂóéÔºü")) {
                        currentItinerary.value.splice(idx, 1);
                        showItineraryModal.value = false;
                        triggerSync();
                    }
                }
            };
            
            // Function to delete from card directly
            const removeItineraryItemCard = (id) => {
                if(confirm("Á¢∫ÂÆöË¶ÅÂà™Èô§Ê≠§Ë°åÁ®ãÂóéÔºü")) {
                    const idx = currentItinerary.value.findIndex(i => i.id === id);
                    if (idx !== -1) {
                        currentItinerary.value.splice(idx, 1);
                        triggerSync();
                    }
                }
            };
            
            const editItem = (item) => { isEditMode.value = true; newItinerary.value = { ...item }; showItineraryModal.value = true; };
            const addShoppingItem = () => { if(newShoppingItem.value.name) shoppingList.value.push({ ...newShoppingItem.value, checked: false }); showShoppingModal.value = false; triggerSync(); };
            const removeShoppingItem = (idx) => { shoppingList.value.splice(idx, 1); triggerSync(); };
            const resetShoppingForm = () => { newShoppingItem.value = { name: '', qty: 1, category: 'souvenir', buyer: members.value[0] }; };
            
            // Expense Edit Functions
            const editExpense = (exp) => {
                isExpenseEditMode.value = true;
                editingExpenseId.value = exp.id;
                newExpense.value = JSON.parse(JSON.stringify(exp)); // Deep copy
                // Ensure number types
                newExpense.value.amount = Number(newExpense.value.amount);
                if(newExpense.value.amountTWD) newExpense.value.amountTWD = Number(newExpense.value.amountTWD);
                if(newExpense.value.customRate) newExpense.value.customRate = Number(newExpense.value.customRate);
                showExpenseModal.value = true;
            };
            
            // Define the copyExpense function
            const copyExpense = (exp) => {
                const text = `${exp.date} ${exp.name} ¬•${exp.amount} (‰ªòÊ¨æ: ${exp.payer})`;
                const textArea = document.createElement("textarea");
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand("copy"); 
                document.body.removeChild(textArea);
                statusMessage.value = "Â∑≤Ë§áË£Ω";
                setTimeout(() => statusMessage.value = isConnected.value ? "ÈÄ£Á∑öÊ≠£Â∏∏" : "Êú™ÈÄ£Á∑ö", 2000);
            };

            const saveExpense = () => {
                if (!newExpense.value.amount) return;

                // Fix: Force category to 'transfer' if type is 'transfer'
                if (newExpense.value.type === 'transfer') {
                    newExpense.value.category = 'transfer';
                }

                const expenseData = {
                    ...newExpense.value,
                    id: newExpense.value.id || Date.now(), // Ensure ID
                    name: newExpense.value.type === 'transfer' 
                          ? `ËΩâÂ∏≥: ${newExpense.value.payer} ‚ûî ${newExpense.value.payee}` 
                          : newExpense.value.name,
                    involved: newExpense.value.type === 'transfer' 
                              ? [newExpense.value.payee] 
                              : [...newExpense.value.involved]
                };

                if (isExpenseEditMode.value && editingExpenseId.value) {
                    // Find index by ID
                    const idx = expenses.value.findIndex(e => e.id === editingExpenseId.value);
                    if(idx !== -1) expenses.value[idx] = expenseData;
                } else {
                    if (newExpense.value.type !== 'transfer' && !newExpense.value.name) return;
                    expenses.value.push(expenseData);
                }

                showExpenseModal.value = false;
                triggerSync();
                isExpenseEditMode.value = false;
                editingExpenseId.value = null;
            };
            
            const addExpense = () => { saveExpense(); }; 
            
            // Updated remove function that takes the expense object (by ID or reference)
            // Template passes 'exp', so we remove by ID for safety
            const removeExpenseObj = (exp) => {
                if(confirm("Á¢∫ÂÆöË¶ÅÂà™Èô§Ê≠§Á≠ÜÊîØÂá∫ÂóéÔºü")) {
                    const idx = expenses.value.findIndex(e => e.id === exp.id);
                    if(idx !== -1) {
                        expenses.value.splice(idx, 1);
                        triggerSync();
                    }
                }
            };
            
            const addRegion = () => { if (newRegionName.value) { mustBuyList.value.push({ area: newRegionName.value, items: [] }); newRegionName.value = ''; triggerSync(); }};
            const removeRegion = (idx) => { mustBuyList.value.splice(idx, 1); triggerSync(); };
            const addMustBuyItem = (rIdx, event) => { const val = event.target.value.trim(); if (val) { mustBuyList.value[rIdx].items.push(val); event.target.value = ''; triggerSync(); }};
            const removeMustBuyItem = (rIdx, iIdx) => { mustBuyList.value[rIdx].items.splice(iIdx, 1); triggerSync(); };
            
            // Initial Data Population based on User Request
            const populateInitialData = () => {
                const initialItineraryData = [
    [
        { id: 1, category: 'flight', startTime: '02:50', name: 'TPE >> CTS (VZ570)', note: '07:30 ÊäµÈÅîÊñ∞ÂçÉÊ≠≤', isNoteExpanded: false },
        { id: 2, category: 'transport', startTime: '08:45', name: 'Ê©üÂ†¥Êé•ÈßÅÂåÖËªäÂá∫Áôº', note: 'ÂâçÂæÄÊòüÈáéÂ∫¶ÂÅáÊùë', travelTime: '15ÂàÜÈêò', isNoteExpanded: false },
        { id: 3, category: 'sightseeing', startTime: '09:00', name: 'ÈúßÂÜ∞Âπ≥Âè∞', note: 'Êê≠‰πòÈõ≤Êµ∑Á∫úËªä (¬•2,500)\nÊé®Ëñ¶ÂâçÂæÄ KUMO Cafe ÂìÅÂöêÈõ≤ÊúµÂÜ∞Ê∑áÊ∑ã', isNoteExpanded: false },
        { id: 4, category: 'sightseeing', startTime: '13:00', name: 'Tomamu Snow Kart (Èõ™Âú∞Âç°‰∏ÅËªä)', note: 'Ë≤ªÁî®Ôºö¬•3,500\n‚ö†Ô∏è ÈúÄÊñº 12/1 09:00 (Êó•Êú¨ÊôÇÈñì) ÈñãÊîæÊôÇÊê∂ÂÖàÈ†êÁ¥Ñ', isNoteExpanded: false },
        { id: 5, category: 'accommodation', startTime: '15:00', name: 'ÊòüÈáé„É™„Çæ„Éº„Éà „Éà„Éû„É† The Tower', note: 'Check-in (ÈÄÄÊàø 11:00)', isNoteExpanded: false },
        { id: 6, category: 'food', startTime: '17:00', name: 'Forest Restaurant Ê£ÆÊûóÈ§êÂª≥', note: 'Ëá™Âä©È§ê (Ë≤ªÁî®Ôºö¬•5,500)\nÁáüÊ•≠ÊôÇÈñìÔºö17:00-20:30', isNoteExpanded: false },
        { id: 7, category: 'sightseeing', startTime: '19:00', name: 'ÊÑõÁµ≤ÂÜ∞Âüé (Ice Village)', note: 'ÂÖ•Â†¥Ë≤ªÔºö¬•600 (ÊúÄÂæåÂÖ•Â†¥ 21:30)\nÈñãÊîæËá≥ 22:00', isNoteExpanded: false }
    ],
    [
        { id: 8, category: 'food', startTime: '08:00', name: 'È£ØÂ∫óÊó©È§ê', note: '', isNoteExpanded: false },
        { id: 9, category: 'transport', startTime: '08:45', name: 'ÂåÖËªäÂá∫Áôº', note: '', travelTime: '2Â∞èÊôÇ', isNoteExpanded: false },
        { id: 10, category: 'sightseeing', startTime: '11:30', name: 'ÂÆöÂ±±Ê∫™Ê≥õËàü', note: 'ÈõÜÂêàÈªûÔºöÊú≠ÂπåÂ∏ÇÂçóÂå∫ÂÆöÂ±±Ê∏ìÊ∏©Ê≥âË•øÔºî‰∏ÅÁõÆ371-4\n12:00Ê¥ªÂãïÈñãÂßãÔºåÁ¥Ñ2Â∞èÊôÇ\nË≤ªÁî®Ôºö¬•9,500', address: 'Êú≠ÂπåÂ∏ÇÂçóÂå∫ÂÆöÂ±±Ê∏ìÊ∏©Ê≥âË•øÔºî‰∏ÅÁõÆ371-4', isNoteExpanded: false },
        { id: 11, category: 'accommodation', startTime: '14:00', name: 'Vessel Inn Sapporo Nakajima Park', note: 'Check-in (ÈÄÄÊàø 11:00)', isNoteExpanded: false },
        { id: 12, category: 'food', startTime: '18:00', name: 'ÊàêÂêâÊÄùÊ±óÁÉ§ÁæäËÇâ', note: 'Êú≠ÂπåÂøÖÂêÉÁâπËâ≤ÊñôÁêÜ', isNoteExpanded: false }
    ],
    [
        { id: 13, category: 'food', startTime: '08:00', name: 'È£ØÂ∫óÊó©È§ê', note: '', isNoteExpanded: false },
        { id: 14, category: 'transport', startTime: '08:30', name: 'ÂåÖËªäÂá∫Áôº', note: 'Êú≠Âπå > ÁôªÂà• > Ê¥ûÁà∫Êπñ > ÂáΩÈ§®', travelTime: '2Â∞èÊôÇ', isNoteExpanded: false },
        { id: 15, category: 'sightseeing', startTime: '10:30', name: 'ÁôªÂà•Âú∞ÁçÑË∞∑', note: 'Âú∞ÁçÑË∞∑Êï£Á≠ñ', isNoteExpanded: false },
        { id: 16, category: 'sightseeing', startTime: '13:00', name: 'Ê¥ûÁà∫Êπñ', note: 'Êò≠ÂíåÊñ∞Â±±„ÄÅÊπñÁïîÂ±ïÊúõÂè∞', isNoteExpanded: false },
        { id: 17, category: 'accommodation', startTime: '15:00', name: 'OMO5 ÂáΩÈ§® by ÊòüÈáéÈõÜÂúò', note: 'Check-in (ÈÄÄÊàø 11:00)\nÂú∞ÂùÄÔºöÂåóÊµ∑ÈÅìÂáΩÈ§®Â∏ÇËã•ÊùæÁî∫24Áï™1', address: 'ÂåóÊµ∑ÈÅìÂáΩÈ§®Â∏ÇËã•ÊùæÁî∫24Áï™1', isNoteExpanded: false },
        { id: 18, category: 'food', startTime: '19:00', name: 'ÊôöÈ§ê', note: 'ÂáΩÈ§®Â∏ÇÂçÄÊàñÈ£ØÂ∫óÂë®ÈÇä', isNoteExpanded: false }
    ],
    [
        { id: 19, category: 'food', startTime: '07:00', name: 'ÂáΩÈ§®ÊúùÂ∏Ç', note: 'Âª∫Ë≠∞ 07:00 ÂâçÊäµÈÅî\nÈ´îÈ©óÈá£ÁÉèË≥äËàáÂìÅÂöêÊµ∑ÈÆÆ‰∏º', isNoteExpanded: false },
        { id: 20, category: 'sightseeing', startTime: '10:00', name: '‰∫îÁ®úÈÉ≠ÂÖ¨ÂúíÔºã‰∫îÁ®úÈÉ≠Â°î', note: 'Êê≠Â∏ÇÈõªÁ¥Ñ30ÂàÜÈêòÔºå‰øØÁû∞ÊòüÂΩ¢Â†°Â£ò', isNoteExpanded: false },
        { id: 21, category: 'shopping', startTime: '13:00', name: 'ÈáëÊ£ÆÁ¥ÖÁ£öÂÄâÂ∫´', note: 'Ê∏ØÁÅ£Êï£Ê≠•„ÄÅË≥ºÁâ©„ÄÅ‰∏ãÂçàËå∂', isNoteExpanded: false },
        { id: 22, category: 'sightseeing', startTime: '15:00', name: 'ÂÖÉÁî∫ÊïôÊúÉÁæ§„ÄÅÂÖ´Âπ°ÂùÇ', note: 'ÊãçÊîùËëóÂêçÁöÑÂù°ÈÅìÊµ∑ÊôØËàáÊïôÂ†ÇÁæ§', isNoteExpanded: false },
        { id: 23, category: 'sightseeing', startTime: '18:00', name: 'ÂáΩÈ§®Â±±Â§úÊôØ', note: 'Êê≠‰πòÁ∫úËªäÊ¨£Ë≥ûÁôæËê¨Â§úÊôØ\n(ÂèØÂà©Áî®È£ØÂ∫óÂÖçË≤ªÊé•ÈßÅÂ∑¥Â£´)', isNoteExpanded: false },
        { id: 24, category: 'food', startTime: '20:00', name: 'ÊôöÈ§ê', note: 'Â∞è‰∏ëÊº¢Â†° (Lucky Pierrot) Êàñ ÈπΩÂë≥ÊãâÈ∫µ', isNoteExpanded: false }
    ],
    [
        { id: 25, category: 'food', startTime: '08:00', name: 'È£ØÂ∫óÊó©È§ê', note: '', isNoteExpanded: false },
        { id: 26, category: 'transport', startTime: '09:00', name: 'JR ÁâπÊÄ•ÂåóÊñóËôü', note: 'ÂáΩÈ§® > Êú≠Âπå (ËªäÁ®ãÁ¥Ñ4Â∞èÊôÇ)\nË≤ªÁî®ÔºöÁ¥Ñ ¬•9,440', travelTime: '4Â∞èÊôÇ', isNoteExpanded: false },
        { id: 27, category: 'accommodation', startTime: '15:00', name: 'The Royal Park Canvas Êú≠ÂπåÂ§ßÈÄöÂÖ¨Âúí', note: 'Check-in (ÈÄÄÊàø 11:00)\nÂú∞ÂùÄÔºöÊú≠ÂπåÂ∏Ç‰∏≠Â§ÆÂå∫Â§ßÈÄöË•ø1-12\nÊäµÈÅîÂæåÊñºÂ§ßÈÄöÂÖ¨ÂúíÂë®ÈÇäÊ¥ªÂãï', address: 'Êú≠ÂπåÂ∏Ç‰∏≠Â§ÆÂå∫Â§ßÈÄöË•ø1-12', isNoteExpanded: false }
    ],
    [
        { id: 28, category: 'food', startTime: '09:00', name: 'Êó©È§ê', note: 'È£ØÂ∫óÊó©È§êÊàñËá™Ë°åË¶ìÈ£ü', isNoteExpanded: false },
        { id: 29, category: 'transport', startTime: '10:00', name: 'JR Âø´ÈÄü Airport Ëôü', note: 'ÂæÄËøîÂ∞èÊ®Ω (Á¥Ñ35ÂàÜ)', travelTime: '35ÂàÜÈêò', isNoteExpanded: false },
        { id: 30, category: 'food', startTime: '11:00', name: '‰∏âËßíÂ∏ÇÂ†¥', note: 'Âá∫Á´ôÂç≥ÈÅîÔºåÊó©ÂçàÈ§êÂ•ΩÈÅ∏Êìá (Â∏ùÁéãËüπ/Êµ∑ÈÆÆ‰∏º)', isNoteExpanded: false },
        { id: 31, category: 'sightseeing', startTime: '12:30', name: 'Â∞èÊ®ΩÈÅãÊ≤≥', note: 'Ê∑∫ËçâÊ©ãÊãçÁÖß„ÄÅÈÅãÊ≤≥ÂÄâÂ∫´Áæ§', isNoteExpanded: false },
        { id: 32, category: 'shopping', startTime: '13:30', name: 'Â†∫Áî∫ÈÄöÂïÜÂ∫óË°ó', note: 'ÁîúÈªûÔºöÂÖ≠Ëä±‰∫≠„ÄÅÂåóËèìÊ®ì(Â¶ñÁ≤æ‰πãÊ£ÆÂπ¥Ëº™ËõãÁ≥ï)„ÄÅLeTAO\nÂ∑•ËóùÔºöÂåó‰∏ÄÂì®Â≠êÈ§®„ÄÅÂ∞èÊ®ΩÈü≥Ê®ÇÁõíÂ†Ç', isNoteExpanded: false },
        { id: 33, category: 'food', startTime: '18:00', name: 'ÊôöÈ§ê', note: 'Ëã•ÈõûÊôÇ‰ª£ (Naruto) ÁÇ∏ÂçäÈõûÂÆöÈ£ü Êàñ Â∞èÊ®ΩÂ£ΩÂè∏ÈÄö', isNoteExpanded: false }
    ],
    [
        { id: 34, category: 'food', startTime: '07:00', name: 'Êó©È§ê', note: 'Âª∫Ë≠∞ÊèêÂâçÊ∫ñÂÇôÁ∞°ÊòìÊó©È§ê', isNoteExpanded: false },
        { id: 35, category: 'transport', startTime: '07:40', name: 'ÈõÜÂêàÔºöÂ§ßÈÄöÂú∞ÈêµÁ´ô 31 ËôüÈñÄ', note: '‰∏ÄÊó•ÈÅäËßÄÂÖâÂ∑¥Â£´\nÈõÜÂêàÈªûÔºöStatue of Hope Â∏åÊúõ‰πãÂÉè', travelTime: '2.5Â∞èÊôÇ', isNoteExpanded: false },
        { id: 36, category: 'sightseeing', startTime: '10:30', name: 'Êó≠Â±±ÂãïÁâ©Âúí', note: '‰ºÅÈµùÊï£Ê≠•ÁÇ∫ÂÜ¨Â≠£ÈôêÂÆöÔºåË¶ñËûçÈõ™ÁãÄÊ≥ÅËÄåÂÆö', isNoteExpanded: false },
        { id: 37, category: 'food', startTime: '20:00', name: 'ÊôöÈ§ê', note: 'ÂõûÂà∞Êú≠ÂπåÁ¥Ñ 20:00\nÂª∫Ë≠∞ÂêÉ ÊπØÂíñÂì© (Suage+/GARAKU) Êàñ ÊãâÈ∫µÂÖ±ÂíåÂúã', isNoteExpanded: false }
    ],
    [
        { id: 38, category: 'food', startTime: '08:00', name: 'È£ØÂ∫óÊó©È§ê', note: '', isNoteExpanded: false },
        { id: 39, category: 'sightseeing', startTime: '09:30', name: 'ÂåóÊµ∑ÈÅìÁ•ûÂÆÆ', note: 'ÂèÉÊãúËàáË≥ºË≤∑ÁâπËâ≤Âæ°ÂÆà\nÂìÅÂöêÂÖ≠Ëä±‰∫≠Á•ûÂÆÆÂ∫óÈôêÂÆöÂà§ÂÆòÈ§Ö', isNoteExpanded: false },
        { id: 40, category: 'food', startTime: '12:00', name: '‰∫åÊ¢ùÂ∏ÇÂ†¥', note: 'ÂçàÈ§ê‰∫´Áî®Êñ∞ÈÆÆÊµ∑ËÜΩ„ÄÅÂìàÂØÜÁìú', isNoteExpanded: false },
        { id: 41, category: 'shopping', startTime: '14:00', name: '„ÄêÈ®éÂ£´ÁµÑ„ÄëRicoland Êú≠ÂπåÁôΩÁü≥Â∫ó', note: 'ÂåóÊµ∑ÈÅìÊúÄÂ§ßÈáçÊ©üÁî®ÂìÅÂ∫ó (Âª∫Ë≠∞Êê≠Ë®àÁ®ãËªäÂâçÂæÄ)', isNoteExpanded: false },
        { id: 42, category: 'shopping', startTime: '14:00', name: '„ÄêË≥ºÁâ©ÁµÑ„ÄëÁã∏Â∞èË∑Ø / Â§ß‰∏∏ÁôæË≤®', note: 'Ëó•Â¶ù„ÄÅÈõªÂô®„ÄÅÁ≤æÂìÅÊé°Ë≥º', isNoteExpanded: false },
        { id: 43, category: 'food', startTime: '19:00', name: 'Ê≠°ÈÄÅÊúÉÊôöÈ§ê', note: '‰∏âÂ§ßËüπÂêÉÂà∞È£Ω (Â¶ÇÔºöÈõ£ÈôÄ) Êàñ È†ÇÁ¥öÂíåÁâõÂ£ΩÂñúÁáí', isNoteExpanded: false }
    ],
    [
        { id: 44, category: 'food', startTime: '08:00', name: 'È£ØÂ∫óÊó©È§ê', note: '', isNoteExpanded: false },
        { id: 45, category: 'transport', startTime: '10:00', name: 'ÂâçÂæÄÊñ∞ÂçÉÊ≠≤Ê©üÂ†¥', note: '', travelTime: '1Â∞èÊôÇ', isNoteExpanded: false },
        { id: 46, category: 'shopping', startTime: '11:00', name: 'ÂúãÂÖßÁ∑öËà™Âªà 2F', note: 'Êé°Ë≤∑‰º¥ÊâãÁ¶Æ (Royce„ÄÅÁôΩËâ≤ÊàÄ‰∫∫„ÄÅÂÖ≠Ëä±‰∫≠Á≠â)\nÊúÄÂæåÁæéÈ£üË°ùÂà∫', isNoteExpanded: false },
        { id: 47, category: 'flight', startTime: '14:40', name: 'CTS >> TPE (CI131)', note: 'Âπ≥ÂÆâËøîÂúã', isNoteExpanded: false }
    ]
];

                return initialItineraryData;
            };
            
            // Load initial data
            itineraryData.value = populateInitialData();

            return {
                currentTab, dates, selectedDateIndex, hotels, mustBuyList, shoppingList, expenses, members, shoppingCategories,
                itineraryData, currentItinerary, totalExpensesJPY, totalExpensesTWD, balanceSheet, settlements, selectedMemberName, selectedMemberData, inboundFlights,
                // currencyInput is removed
                formatNumber, exchangeRate,
                getCategoryColor, getCategoryIcon, getWeatherIcon, openMap,
                getShoppingCategoryColor, getShoppingCategoryIcon, getShoppingCategoryName, getPieChartGradient, getPaymentPieChartGradient, getFilterPieChartGradient, getFilteredCategoryStats, // Added missing functions
                showItineraryModal, showShoppingModal, showExpenseModal, isEditMode, isMustBuyEditMode, newRegionName,
                newItinerary, newShoppingItem, newExpense, CATEGORY_HEX, CATEGORY_MAP_NAME, CATEGORY_MAP,
                handleAddClick, saveItineraryItem, editItem, removeItineraryItem, removeItineraryItemCard,
                addShoppingItem, removeShoppingItem, addExpense, removeExpense: removeExpenseObj, saveExpense, editExpense, // Updated removeExpense to removeExpenseObj
                toggleSelectAll, addRegion, removeRegion, addMustBuyItem, removeMustBuyItem,
                triggerSync, syncData, isConnected, statusMessage, syncStatusClass,
                resetShoppingForm, onJPYInput, onTWDInput, onRateInput,
                calculateTWD, calculateJPY, onExchangeRateChange,
                calcJPY, calcTWD, filterMember, filterCategory, filteredExpenses, analysisItems, // Added analysisItems
                isExpenseEditMode, editingExpenseIndex,
                copyExpense, // Make sure this is returned
                isDataLoaded // Added loading state
            }
        }
    }).mount('#app');
</script>
</body>
</html>

