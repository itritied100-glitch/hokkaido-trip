<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hokkaido Trip 2026 (雲端同步版)</title>
    
    <!-- Tab Icon -->
    <link rel="icon" type="image/jpeg" href="./image_ec3041.jpg">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'snow-white': '#F0FFFF',
                        'ice-blue': '#B3E5FC',
                        'light-snow-blue': '#E5F3F7',
                        'deep-sea-blue': '#01579B',
                        'accent-yellow': '#FFD54F',
                        'soft-gray': '#F5F5F5',
                        'jp-sage': '#A9B7AA',
                        'warm-orange': '#FF8A65',
                        'balance-pos': '#4CAF50',
                        'balance-neg': '#EF5350'
                    }
                }
            }
        }
    </script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        body { background-color: #E5F3F7; -webkit-tap-highlight-color: transparent; font-family: 'Noto Sans TC', sans-serif; color: #334155; }
        .app-container { max-width: 480px; margin: 0 auto; min-height: 100vh; background-color: #ffffff; box-shadow: 0 0 30px rgba(0, 0, 0, 0.05); position: relative; padding-bottom: 90px; }
        .header-bg { background-color: #ffffff; padding: 0; position: relative; overflow: hidden; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15); border-bottom-left-radius: 35px; border-bottom-right-radius: 35px; z-index: 10; height: 280px; }
        .header-image-container { width: 100%; height: 100%; position: relative; }
        .header-image-container img { width: 100%; height: 100%; object-fit: cover; object-position: center bottom; }
        .snow-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><circle cx="50" cy="50" r="1" fill="%23fff" opacity="0.8"/><circle cx="20" cy="80" r="0.5" fill="%23fff" opacity="0.6"/><circle cx="70" cy="30" r="1.5" fill="%23fff" opacity="0.9"/></svg>'); background-size: 100px 100px; opacity: 0.8; animation: snowfall 10s linear infinite; z-index: 5; pointer-events: none; }
        @keyframes snowfall { to { background-position: 100px 100px; } }
        .side-tab-bar { position: absolute; bottom: 20px; right: 20px; z-index: 30; display: flex; gap: 10px; }
        .tab-button { width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2); transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); background-color: rgba(255, 255, 255, 0.9); color: #90A4AE; border: 2px solid white; }
        .tab-button.active { background-color: #01579B; color: #ffffff; transform: scale(1.15) translateY(-5px); box-shadow: 0 8px 20px rgba(1, 87, 155, 0.4); border-color: #01579B; }
        .app-main { padding-top: 20px; position: relative; z-index: 5; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .card-shadow { box-shadow: 0 4px 20px rgba(179, 229, 252, 0.25); transition: transform 0.2s ease; }
        .animate-fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .note-content { max-height: 2.5rem; overflow: hidden; transition: max-height 0.3s ease-out; }
        .note-content.expanded { max-height: 500px; }
        .date-selector-sticky { background-color: rgba(255,255,255,0.95); backdrop-filter: blur(5px); border-bottom: 1px solid #f0f0f0; z-index: 20; top: 0; padding-top: 10px; padding-bottom: 10px; }
        .banner-text-overlay { background: linear-gradient(to top, rgba(0,0,0,0.6) 0%, rgba(0,0,0,0) 100%); position: absolute; bottom: 0; left: 0; width: 100%; height: 50%; border-bottom-left-radius: 35px; border-bottom-right-radius: 35px; pointer-events: none; }
        .member-checkbox:checked + div { background-color: #01579B; color: white; border-color: #01579B; }
        
        /* 同步狀態指示燈 */
        .sync-status { position: absolute; top: 20px; right: 20px; z-index: 50; font-size: 0.7rem; padding: 4px 8px; border-radius: 12px; background: rgba(0,0,0,0.3); color: white; backdrop-filter: blur(4px); display: flex; align-items: center; gap: 5px; }
        .sync-dot { width: 8px; height: 8px; border-radius: 50%; background-color: #EF5350; }
        .sync-dot.online { background-color: #4CAF50; box-shadow: 0 0 5px #4CAF50; }
        .sync-dot.busy { background-color: #FFC107; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body>

<div id="app" class="app-container">

    <!-- Sync Status -->
    <div class="sync-status">
        <div class="sync-dot" :class="syncStatusClass"></div>
        <span>{{ statusMessage }}</span>
    </div>

    <!-- Header 區域 -->
    <div class="header-bg">
        <div class="header-image-container">
            <img src="./banner.jpg" 
                 onerror="this.src='https://images.unsplash.com/photo-1548578709-32269a838573?q=80&w=1920&auto=format&fit=crop'"
                 alt="北海道家族旅行">
            <div class="banner-text-overlay"></div>
            <div class="absolute bottom-6 left-6 text-white z-20">
                <h1 class="text-3xl font-bold tracking-widest drop-shadow-md">HOKKAIDO</h1>
                <p class="text-sm font-light tracking-wider opacity-90">2026.03.06 - 03.14</p>
            </div>
        </div>
        
        <div class="snow-layer"></div> 
        
        <div class="side-tab-bar">
            <button @click="currentTab = 'itinerary'" :class="{'active': currentTab === 'itinerary'}" class="tab-button"><i class="fa-solid fa-map-location-dot"></i></button>
            <button @click="currentTab = 'info'" :class="{'active': currentTab === 'info'}" class="tab-button"><i class="fa-solid fa-circle-info"></i></button>
            <button @click="currentTab = 'shopping'" :class="{'active': currentTab === 'shopping'}" class="tab-button"><i class="fa-solid fa-basket-shopping"></i></button>
            <button @click="currentTab = 'expenses'" :class="{'active': currentTab === 'expenses'}" class="tab-button"><i class="fa-solid fa-coins"></i></button>
        </div>
    </div>

    <!-- 主要內容 -->
    <main class="p-4 app-main">
        
        <!-- Tab 1: 行程 -->
        <div v-if="currentTab === 'itinerary'" class="animate-fade-in">
            <div class="flex overflow-x-auto hide-scrollbar space-x-3 mb-4 snap-x px-1 sticky date-selector-sticky -mx-4 px-4 pb-2">
                <div v-for="(day, index) in dates" :key="index" @click="selectedDateIndex = index"
                     class="snap-center flex-shrink-0 w-[60px] h-[70px] rounded-2xl flex flex-col items-center justify-center cursor-pointer transition-all duration-300 border-2 shadow-sm"
                     :class="selectedDateIndex === index ? 'bg-deep-sea-blue text-white border-deep-sea-blue shadow-lg scale-105' : 'bg-white text-slate-400 border-transparent hover:bg-soft-gray'">
                    <span class="text-sm font-bold uppercase">{{ day.weekday }}</span> 
                    <span class="text-xs font-medium opacity-80">{{ day.date }}</span> 
                </div>
            </div>

            <div class="mb-5 bg-snow-white border border-ice-blue rounded-2xl p-4 flex justify-between items-center shadow-sm">
                <div class="flex items-center text-deep-sea-blue gap-3">
                    <i :class="getWeatherIcon(dates[selectedDateIndex].weather)" class="text-4xl text-blue-400"></i>
                    <div>
                        <div class="text-2xl font-bold">{{ dates[selectedDateIndex].temp }}</div>
                        <div class="text-xs text-slate-500">{{ dates[selectedDateIndex].area }}</div>
                    </div>
                </div>
                <div class="text-right">
                    <span v-if="dates[selectedDateIndex].transport" class="inline-block bg-white text-deep-sea-blue text-xs font-bold px-3 py-1.5 rounded-full shadow-sm border border-ice-blue">
                        <i class="fa-solid fa-van-shuttle mr-1 text-accent-yellow"></i> {{ dates[selectedDateIndex].transport }}
                    </span>
                </div>
            </div>

            <div class="space-y-4 pb-20">
                <div v-for="(item, idx) in currentItinerary" :key="item.id" class="relative pl-4">
                    <div v-if="idx < currentItinerary.length - 1" class="absolute left-[23px] top-8 bottom-[-16px] w-0.5 bg-slate-200 z-0"></div>
                    <div class="bg-white rounded-2xl p-4 card-shadow relative z-10 border border-slate-50">
                        <div class="flex items-start gap-3">
                            <div class="flex flex-col items-center min-w-[50px]">
                                <div class="w-10 h-10 rounded-full flex items-center justify-center text-white shadow-md text-sm mb-1" :class="getCategoryColor(item.category)">
                                    <i :class="getCategoryIcon(item.category)"></i>
                                </div>
                                <span class="text-xs font-bold text-slate-500">{{ item.startTime }}</span>
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="flex justify-between items-start">
                                    <h3 class="font-bold text-slate-800 text-lg leading-tight truncate pr-2">{{ item.name }}</h3>
                                    <div class="flex gap-2 shrink-0">
                                        <button @click.stop="openMap(item.address || item.name)" class="w-7 h-7 bg-ice-blue/30 text-deep-sea-blue rounded-full flex items-center justify-center text-xs hover:bg-deep-sea-blue hover:text-white transition-colors"><i class="fa-solid fa-location-arrow"></i></button>
                                        <button @click.stop="editItem(item)" class="w-7 h-7 bg-slate-100 text-slate-400 rounded-full flex items-center justify-center text-xs hover:bg-slate-200"><i class="fa-solid fa-pencil"></i></button>
                                    </div>
                                </div>
                                <div class="text-sm text-slate-500 mt-2 space-y-1">
                                    <p v-if="item.price" class="flex items-center"><i class="fa-solid fa-ticket w-4 text-center mr-1 text-ice-blue"></i> {{ item.price }}</p>
                                    <p v-if="item.address" class="flex items-center truncate"><i class="fa-solid fa-map-pin w-4 text-center mr-1 text-ice-blue"></i> {{ item.address }}</p>
                                </div>
                                <div v-if="item.note" class="mt-3 bg-slate-50 p-2.5 rounded-xl border border-slate-100 text-xs text-slate-600">
                                    <div class="note-content" :class="{'expanded': item.isNoteExpanded}">{{ item.note }}</div>
                                    <button v-if="item.note.length > 40" @click="item.isNoteExpanded = !item.isNoteExpanded" class="text-deep-sea-blue font-bold mt-1">{{ item.isNoteExpanded ? '收合' : '展開...' }}</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div v-if="currentItinerary.length === 0" class="text-center py-10 text-slate-300"><p>本日暫無行程，點擊右下角 + 新增</p></div>
            </div>
        </div>

        <!-- Tab 2: 資訊 -->
        <div v-if="currentTab === 'info'" class="animate-fade-in space-y-5 pb-20">
            <div class="bg-gradient-to-br from-deep-sea-blue to-cyan-700 rounded-3xl p-6 text-white shadow-xl relative overflow-hidden">
                <div class="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full -mr-10 -mt-10 blur-2xl"></div>
                <div class="flex justify-between items-center mb-4 relative z-10">
                    <h3 class="font-bold flex items-center"><i class="fa-solid fa-calculator mr-2"></i> 匯率換算</h3>
                    <div class="flex items-center bg-white/20 rounded-lg px-2 py-1">
                        <span class="text-xs text-cyan-200 mr-1">匯率:</span>
                        <input type="number" v-model="exchangeRate" @change="triggerSync" step="0.001" class="w-12 bg-transparent text-white font-bold text-sm text-right focus:outline-none border-b border-white/30">
                    </div>
                </div>
                <div class="flex items-center justify-between gap-4 relative z-10">
                    <div class="flex-1">
                        <label class="text-[10px] text-cyan-200 block mb-1">JPY</label>
                        <input type="number" v-model="currencyInput" class="w-full bg-white/20 border border-white/30 rounded-xl px-3 py-2 text-white font-bold text-lg focus:outline-none">
                    </div>
                    <i class="fa-solid fa-arrow-right-arrow-left text-cyan-300 mt-4"></i>
                    <div class="flex-1">
                        <label class="text-[10px] text-cyan-200 block mb-1">TWD</label>
                        <div class="w-full bg-white/10 rounded-xl px-3 py-2 text-white text-lg font-bold border border-transparent">{{ currencyResult }}</div>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-3xl p-6 card-shadow">
                <h3 class="font-bold text-slate-800 mb-4 border-b border-slate-100 pb-2"><i class="fa-solid fa-hotel text-purple-500 mr-2"></i> 住宿清單</h3>
                <ul class="space-y-4">
                    <li v-for="hotel in hotels" class="group">
                        <div class="flex justify-between items-start">
                            <div><span class="font-bold text-slate-700 block">{{ hotel.name }}</span><span class="text-xs bg-purple-50 text-purple-600 px-2 py-0.5 rounded-md mt-1 inline-block">{{ hotel.date }}</span></div>
                            <button @click="openMap(hotel.name)" class="w-8 h-8 rounded-full bg-purple-50 text-purple-500 flex items-center justify-center hover:bg-purple-500 hover:text-white transition-colors"><i class="fa-solid fa-location-arrow text-xs"></i></button>
                        </div>
                        <p class="text-xs text-slate-400 mt-1"><i class="fa-solid fa-map-pin mr-1"></i> {{ hotel.address }}</p>
                    </li>
                </ul>
            </div>

            <div class="bg-white rounded-3xl p-6 card-shadow relative">
                <div class="flex justify-between items-center mb-4 border-b border-slate-100 pb-2">
                    <h3 class="font-bold text-slate-800"><i class="fa-solid fa-thumbs-up text-red-400 mr-2"></i> 必買推薦</h3>
                    <button @click="isMustBuyEditMode = !isMustBuyEditMode" class="text-xs px-2 py-1 rounded-full transition-colors" :class="isMustBuyEditMode ? 'bg-deep-sea-blue text-white' : 'bg-slate-100 text-slate-500'">
                        <i class="fa-solid fa-pen-to-square mr-1"></i> {{ isMustBuyEditMode ? '完成' : '編輯' }}
                    </button>
                </div>
                
                <div v-for="(region, rIdx) in mustBuyList" :key="rIdx" class="mb-5 last:mb-0 group/region">
                    <div class="flex items-center mb-2">
                        <span class="w-1.5 h-4 bg-red-300 rounded-r mr-2"></span>
                        <input v-if="isMustBuyEditMode" v-model="region.area" @change="triggerSync" class="font-bold text-sm text-slate-600 bg-slate-50 border-b border-slate-300 w-full focus:outline-none">
                        <h4 v-else class="font-bold text-sm text-slate-600">{{ region.area }}</h4>
                        
                        <button v-if="isMustBuyEditMode" @click="removeRegion(rIdx)" class="ml-2 text-slate-300 hover:text-red-400 text-xs"><i class="fa-solid fa-trash-can"></i></button>
                    </div>
                    
                    <div class="flex flex-wrap gap-2">
                        <span v-for="(item, iIdx) in region.items" :key="iIdx" class="bg-slate-50 text-slate-600 text-xs px-3 py-1.5 rounded-lg border border-slate-100 flex items-center">
                            {{ item }}
                            <button v-if="isMustBuyEditMode" @click="removeMustBuyItem(rIdx, iIdx)" class="ml-2 text-slate-300 hover:text-red-400 font-bold">×</button>
                        </span>
                        
                        <div v-if="isMustBuyEditMode" class="flex items-center">
                            <input @keyup.enter="addMustBuyItem(rIdx, $event)" placeholder="輸入後Enter" class="text-xs bg-white border border-slate-200 rounded-lg px-2 py-1.5 w-24 outline-none focus:border-deep-sea-blue">
                        </div>
                    </div>
                </div>

                <div v-if="isMustBuyEditMode" class="mt-4 pt-4 border-t border-slate-100">
                    <div class="flex items-center gap-2">
                        <input v-model="newRegionName" placeholder="新區域名稱" class="flex-1 text-sm bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 outline-none focus:border-deep-sea-blue">
                        <button @click="addRegion" class="bg-deep-sea-blue text-white text-xs px-3 py-2 rounded-lg font-bold">新增區域</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab 3: 購物清單 -->
        <div v-if="currentTab === 'shopping'" class="animate-fade-in pb-20">
            <button @click="showShoppingModal = true; resetShoppingForm()" class="w-full bg-white border-2 border-dashed border-slate-300 rounded-2xl p-4 mb-4 text-slate-400 font-bold hover:bg-slate-50 hover:border-slate-400 transition-colors flex items-center justify-center">
                <i class="fa-solid fa-plus mr-2"></i> 新增待買商品
            </button>

            <div class="space-y-3">
                <div v-for="(item, idx) in shoppingList" :key="idx" class="flex items-center bg-white p-3 rounded-2xl card-shadow transition-all hover:translate-x-1">
                    <div class="mr-3 pl-1">
                        <input type="checkbox" v-model="item.checked" @change="triggerSync" class="w-5 h-5 accent-deep-sea-blue rounded border-slate-300 cursor-pointer">
                    </div>
                    <!-- 分類圖示 -->
                    <div class="w-10 h-10 rounded-lg flex items-center justify-center text-white text-sm shrink-0 shadow-sm"
                         :class="getShoppingCategoryColor(item.category)">
                        <i :class="getShoppingCategoryIcon(item.category)"></i>
                    </div>
                    <div class="flex-1 ml-3 overflow-hidden">
                        <div class="flex items-center">
                            <p class="font-bold text-sm text-slate-700 truncate" :class="{'line-through text-slate-400': item.checked}">{{ item.name }}</p>
                            <!-- 顯示購買人 -->
                            <span v-if="item.buyer" class="ml-2 text-[10px] bg-blue-50 text-blue-600 px-1.5 py-0.5 rounded border border-blue-100 flex items-center shrink-0">
                                <i class="fa-solid fa-user mr-1 text-[8px]"></i>{{ item.buyer }}
                            </span>
                        </div>
                        <p class="text-xs text-slate-400 mt-0.5 flex items-center">
                            <span class="font-mono text-deep-sea-blue font-bold mr-2">x{{ item.qty }}</span>
                            <span class="text-[10px] bg-slate-100 px-1.5 py-0.5 rounded text-slate-500">{{ getShoppingCategoryName(item.category) }}</span>
                        </p>
                    </div>
                    <button @click="removeShoppingItem(idx)" class="w-8 h-8 rounded-full flex items-center justify-center text-slate-300 hover:text-red-400 hover:bg-red-50 transition-colors ml-2">
                        <i class="fa-solid fa-trash-can"></i>
                    </button>
                </div>
                <div v-if="shoppingList.length === 0" class="text-center py-10 text-slate-300 text-sm">暫無購物清單</div>
            </div>
        </div>

        <!-- Tab 4: 花費 -->
        <div v-if="currentTab === 'expenses'" class="animate-fade-in pb-20">
            <div class="bg-gradient-to-r from-deep-sea-blue to-cyan-600 text-white rounded-3xl p-6 mb-6 relative overflow-hidden shadow-lg">
                <div class="absolute -right-10 -top-10 bg-white/10 w-48 h-48 rounded-full blur-3xl"></div>
                <div class="flex justify-between items-end">
                    <div>
                        <p class="text-xs text-cyan-200 mb-1">本次行程總支出</p>
                        <h2 class="text-3xl font-bold tracking-tight">¥ {{ formatNumber(totalExpensesJPY) }}</h2>
                    </div>
                    <div class="text-right opacity-90">
                        <p class="text-xs">約 NT$ {{ formatNumber(totalExpensesTWD) }}</p>
                    </div>
                </div>
            </div>

            <!-- 分帳結算儀表板 -->
            <div class="bg-white rounded-3xl p-5 mb-6 shadow-sm border border-slate-100">
                <h3 class="font-bold text-slate-800 mb-4 flex items-center text-sm"><i class="fa-solid fa-scale-balanced text-warm-orange mr-2"></i> 分帳結算 (負為應付)</h3>
                <div class="space-y-3">
                    <div v-for="member in balanceSheet" :key="member.name" class="flex items-center justify-between p-2 rounded-lg bg-slate-50">
                        <div class="flex items-center">
                            <div class="w-8 h-8 rounded-full bg-slate-200 flex items-center justify-center text-slate-500 font-bold text-xs mr-3">{{ member.name.charAt(0) }}</div>
                            <span class="text-sm font-bold text-slate-700">{{ member.name }}</span>
                        </div>
                        <div class="text-right">
                            <span class="block font-bold text-sm" :class="member.balance >= 0 ? 'text-balance-pos' : 'text-balance-neg'">
                                {{ member.balance >= 0 ? '+' : '' }}¥{{ formatNumber(member.balance) }}
                            </span>
                            <span class="text-[10px] text-slate-400 block">墊付 ¥{{ formatNumber(member.paid) }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 最佳還款方案 -->
            <div v-if="settlements.length > 0" class="bg-gradient-to-br from-green-50 to-emerald-50 rounded-3xl p-5 mb-6 shadow-sm border border-emerald-100">
                <h3 class="font-bold text-emerald-800 mb-3 flex items-center text-sm"><i class="fa-solid fa-hand-holding-dollar mr-2"></i> 建議還款方案</h3>
                <div class="space-y-2">
                    <div v-for="(txn, idx) in settlements" :key="idx" class="flex items-center justify-between bg-white/60 p-2.5 rounded-xl border border-emerald-100/50">
                        <div class="flex items-center text-sm text-slate-700">
                            <span class="font-bold text-slate-800">{{ txn.from }}</span>
                            <i class="fa-solid fa-arrow-right-long mx-2 text-emerald-400 text-xs"></i>
                            <span class="font-bold text-slate-800">{{ txn.to }}</span>
                        </div>
                        <span class="font-bold text-emerald-600 text-sm font-mono">¥{{ formatNumber(txn.amount) }}</span>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-t-3xl min-h-[400px] p-6 shadow-[0_-10px_40px_rgba(0,0,0,0.03)] -mx-4 px-8">
                <h3 class="font-bold text-slate-800 mb-5 flex items-center"><i class="fa-solid fa-receipt text-slate-300 mr-2"></i>支出紀錄</h3>
                <div v-if="expenses.length === 0" class="text-center text-slate-300 py-10">尚無紀錄</div>
                <div v-else class="space-y-4">
                    <div v-for="(exp, idx) in expenses" :key="idx" class="flex items-start justify-between border-b border-slate-50 pb-3 last:border-0">
                        <div class="flex items-start">
                            <div class="w-10 h-10 rounded-full flex items-center justify-center text-white text-xs mr-3 shadow-sm shrink-0" :class="getCategoryColor(exp.category)">
                                <i :class="getCategoryIcon(exp.category)"></i>
                            </div>
                            <div>
                                <p class="font-bold text-slate-700 text-sm">{{ exp.name }}</p>
                                <p class="text-[10px] text-slate-400 mt-0.5">
                                    <span v-if="exp.category === 'transfer'" class="text-emerald-600 font-bold">轉帳還款</span>
                                    <span v-else>
                                        <span class="bg-slate-100 px-1.5 py-0.5 rounded text-slate-500 mr-1">{{ exp.payer }}</span>
                                        <span v-if="exp.involved && exp.involved.length < members.length" class="text-warm-orange">({{ exp.involved.length }}人)</span>
                                        <span v-else>全體</span>
                                    </span>
                                </p>
                            </div>
                        </div>
                        <div class="text-right shrink-0">
                            <p class="font-bold text-slate-700 text-sm">¥{{ formatNumber(exp.amount) }}</p>
                            <button @click="removeExpense(idx)" class="text-[10px] text-slate-300 hover:text-red-400 mt-1 block w-full text-right">刪除</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <button v-if="currentTab !== 'info'" @click="handleAddClick" class="fixed bottom-24 right-6 w-14 h-14 bg-accent-yellow rounded-full shadow-[0_4px_15px_rgba(255,213,79,0.6)] text-deep-sea-blue text-2xl flex items-center justify-center hover:scale-110 transition-transform z-40">
        <i class="fa-solid fa-plus"></i>
    </button>

    <!-- 1. 行程 Modal -->
    <div v-if="showItineraryModal" class="fixed inset-0 bg-deep-sea-blue/40 z-50 flex items-center justify-center p-6 backdrop-blur-sm animate-fade-in">
        <div class="bg-white rounded-3xl w-full max-w-sm p-6 shadow-2xl max-h-[90vh] overflow-y-auto">
            <h3 class="font-bold text-lg mb-4 text-center text-slate-800">{{ isEditMode ? '編輯行程' : '新增行程' }}</h3>
            <div class="space-y-3">
                <select v-model="newItinerary.category" class="w-full bg-slate-50 rounded-xl p-3 text-sm outline-none">
                    <option value="sightseeing">景點</option>
                    <option value="food">飲食</option>
                    <option value="shopping">購物</option>
                    <option value="accommodation">住宿</option>
                    <option value="transport">交通</option>
                </select>
                <input v-model="newItinerary.name" placeholder="名稱" class="w-full bg-slate-50 rounded-xl p-3 text-sm outline-none focus:ring-2 focus:ring-deep-sea-blue">
                <input v-model="newItinerary.startTime" type="time" class="w-full bg-slate-50 rounded-xl p-3 text-sm outline-none">
                <input v-model="newItinerary.address" placeholder="地址" class="w-full bg-slate-50 rounded-xl p-3 text-sm outline-none">
                <input v-model="newItinerary.price" placeholder="費用" class="w-full bg-slate-50 rounded-xl p-3 text-sm outline-none">
                <textarea v-model="newItinerary.note" placeholder="備註" rows="3" class="w-full bg-slate-50 rounded-xl p-3 text-sm outline-none"></textarea>
            </div>
            <div class="flex space-x-3 mt-6">
                <button @click="showItineraryModal = false" class="flex-1 py-3 rounded-xl bg-slate-100 text-slate-500 font-bold text-sm">取消</button>
                <button @click="saveItineraryItem" class="flex-1 py-3 rounded-xl bg-deep-sea-blue text-white font-bold text-sm shadow-md">{{ isEditMode ? '更新' : '新增' }}</button>
            </div>
        </div>
    </div>

    <!-- 2. 購物 Modal -->
    <div v-if="showShoppingModal" class="fixed inset-0 bg-deep-sea-blue/40 z-50 flex items-center justify-center p-6 backdrop-blur-sm animate-fade-in">
        <div class="bg-white rounded-3xl w-full max-w-sm p-6 shadow-2xl">
            <h3 class="font-bold text-lg mb-4 text-center">新增購物清單</h3>
            <div class="grid grid-cols-3 gap-3 mb-4">
                <div class="col-span-2">
                    <input v-model="newShoppingItem.name" type="text" placeholder="商品名稱" class="w-full bg-slate-50 rounded-xl p-3 text-sm focus:outline-none focus:ring-2 focus:ring-deep-sea-blue">
                </div>
                <div>
                    <input v-model="newShoppingItem.qty" type="number" placeholder="數量" class="w-full bg-slate-50 rounded-xl p-3 text-sm focus:outline-none">
                </div>
            </div>
            
            <div class="mb-4">
                <label class="block text-xs font-bold text-slate-500 mb-2 pl-1">指定購買人</label>
                <div class="flex gap-2 overflow-x-auto pb-2 hide-scrollbar">
                    <button v-for="m in members" :key="m"
                            @click="newShoppingItem.buyer = m"
                            :class="newShoppingItem.buyer === m ? 'bg-deep-sea-blue text-white shadow-md' : 'bg-slate-50 text-slate-500 border border-slate-100'"
                            class="whitespace-nowrap px-3 py-1.5 rounded-lg text-xs font-bold transition-all">
                        {{ m }}
                    </button>
                </div>
            </div>

            <div class="mb-6">
                <label class="block text-xs font-bold text-slate-500 mb-2 pl-1">商品分類</label>
                <div class="grid grid-cols-3 gap-2">
                    <button v-for="cat in shoppingCategories" :key="cat.id" 
                            @click="newShoppingItem.category = cat.id"
                            :class="newShoppingItem.category === cat.id ? 'bg-deep-sea-blue text-white shadow-md' : 'bg-slate-50 text-slate-500 hover:bg-slate-100'"
                            class="py-2.5 rounded-xl text-xs font-bold transition-all flex items-center justify-center">
                        <i :class="cat.icon" class="mr-1.5"></i> {{ cat.name }}
                    </button>
                </div>
            </div>

            <div class="flex space-x-3">
                <button @click="showShoppingModal = false" class="flex-1 py-3 rounded-xl bg-slate-100 text-slate-500 font-bold text-sm">取消</button>
                <button @click="addShoppingItem" class="flex-1 py-3 rounded-xl bg-deep-sea-blue text-white font-bold text-sm shadow-md">新增</button>
            </div>
        </div>
    </div>

    <!-- 3. 新增花費 Modal -->
    <div v-if="showExpenseModal" class="fixed inset-0 bg-deep-sea-blue/40 z-50 flex items-center justify-center p-6 backdrop-blur-sm animate-fade-in">
        <div class="bg-white rounded-3xl w-full max-w-sm p-6 shadow-2xl max-h-[95vh] overflow-y-auto">
            
            <!-- 頂部切換 Tab -->
            <div class="flex mb-5 bg-slate-100 p-1 rounded-xl">
                <button @click="newExpense.type = 'expense'" :class="newExpense.type === 'expense' ? 'bg-white shadow text-deep-sea-blue' : 'text-slate-400'" class="flex-1 py-2 rounded-lg text-sm font-bold transition-all">一般消費</button>
                <button @click="newExpense.type = 'transfer'" :class="newExpense.type === 'transfer' ? 'bg-white shadow text-emerald-600' : 'text-slate-400'" class="flex-1 py-2 rounded-lg text-sm font-bold transition-all">轉帳還款</button>
            </div>

            <!-- 一般消費模式 -->
            <div v-if="newExpense.type === 'expense'">
                <div class="grid grid-cols-2 gap-3 mb-3">
                    <input v-model="newExpense.date" type="date" class="bg-slate-50 rounded-xl p-3 text-sm outline-none">
                    <select v-model="newExpense.category" class="bg-slate-50 rounded-xl p-3 text-sm outline-none">
                        <option value="food">飲食</option>
                        <option value="shopping">購物</option>
                        <option value="transport">交通</option>
                        <option value="stay">住宿</option>
                        <option value="ticket">門票</option>
                    </select>
                </div>
                <input v-model="newExpense.name" placeholder="項目名稱" class="w-full bg-slate-50 rounded-xl p-4 mb-4 text-sm focus:outline-none">
                <div class="relative mb-4">
                    <span class="absolute left-4 top-4 text-slate-400 font-bold">¥</span>
                    <input v-model.number="newExpense.amount" type="number" placeholder="金額" class="w-full bg-slate-50 rounded-xl p-4 pl-8 text-sm focus:outline-none font-bold text-lg">
                </div>
                <div class="mb-6 border-t border-slate-100 pt-4">
                    <label class="block text-xs font-bold text-slate-500 mb-2">付款人 (誰先墊?)</label>
                    <select v-model="newExpense.payer" class="w-full bg-blue-50 text-deep-sea-blue font-bold rounded-xl p-3 text-sm outline-none mb-4">
                        <option v-for="m in members" :key="m" :value="m">{{ m }}</option>
                    </select>
                    <div class="flex justify-between items-center mb-2">
                        <label class="block text-xs font-bold text-slate-500">分攤對象</label>
                        <button @click="toggleSelectAll" class="text-xs text-deep-sea-blue font-bold">{{ newExpense.involved.length === members.length ? '全取消' : '全選' }}</button>
                    </div>
                    <div class="grid grid-cols-2 gap-2 mb-3">
                        <label v-for="m in members" :key="m" class="cursor-pointer relative">
                            <input type="checkbox" :value="m" v-model="newExpense.involved" class="member-checkbox hidden">
                            <div class="bg-slate-50 border border-slate-200 rounded-lg p-2 text-center text-xs text-slate-600 transition-colors hover:bg-slate-100">{{ m }}</div>
                        </label>
                    </div>
                    <div v-if="newExpense.amount > 0 && newExpense.involved.length > 0" class="bg-orange-50 rounded-xl p-3 flex justify-between items-center">
                        <span class="text-xs text-orange-800">每人應付</span>
                        <span class="font-bold text-orange-600">¥ {{ formatNumber(Math.ceil(newExpense.amount / newExpense.involved.length)) }}</span>
                    </div>
                </div>
            </div>

            <!-- 轉帳模式 -->
            <div v-else>
                <div class="mb-4">
                    <input v-model="newExpense.date" type="date" class="w-full bg-slate-50 rounded-xl p-3 text-sm outline-none mb-4">
                    
                    <div class="flex items-center justify-between gap-2 mb-4">
                        <div class="flex-1">
                            <label class="block text-xs font-bold text-slate-400 mb-1">轉出 (還錢)</label>
                            <select v-model="newExpense.payer" class="w-full bg-red-50 text-red-600 font-bold rounded-xl p-3 text-sm outline-none">
                                <option v-for="m in members" :key="m" :value="m">{{ m }}</option>
                            </select>
                        </div>
                        <i class="fa-solid fa-arrow-right text-slate-300 mt-4"></i>
                        <div class="flex-1">
                            <label class="block text-xs font-bold text-slate-400 mb-1">轉入 (收錢)</label>
                            <select v-model="newExpense.payee" class="w-full bg-green-50 text-green-600 font-bold rounded-xl p-3 text-sm outline-none">
                                <option v-for="m in members" :key="m" :value="m">{{ m }}</option>
                            </select>
                        </div>
                    </div>

                    <div class="relative mb-4">
                        <span class="absolute left-4 top-4 text-slate-400 font-bold">¥</span>
                        <input v-model.number="newExpense.amount" type="number" placeholder="轉帳金額" class="w-full bg-slate-50 rounded-xl p-4 pl-8 text-sm focus:outline-none font-bold text-lg text-emerald-600">
                    </div>
                </div>
            </div>

            <div class="flex space-x-3">
                <button @click="showExpenseModal = false" class="flex-1 py-3 rounded-xl bg-slate-100 text-slate-500 font-bold text-sm">取消</button>
                <button @click="addExpense" class="flex-1 py-3 rounded-xl bg-accent-yellow text-deep-sea-blue font-bold text-sm shadow-md">儲存</button>
            </div>
        </div>
    </div>

</div>

<!-- Firebase SDK -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
    import { createApp, ref, computed, onMounted, watch, nextTick } from "https://unpkg.com/vue@3/dist/vue.esm-browser.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDqqag1anowaW3XPQejcYZl8lUTgE7FRWs",
      authDomain: "hokkaido-trip-55b8f.firebaseapp.com",
      projectId: "hokkaido-trip-55b8f",
      storageBucket: "hokkaido-trip-55b8f.firebasestorage.app",
      messagingSenderId: "802810791692",
      appId: "1:802810791692:web:b161ebee4e105f5bda6b29"
    };

    let db;
    try {
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
    } catch (e) {
        console.error("Firebase Initialization Failed", e);
    }

    createApp({
        setup() {
            const currentTab = ref('itinerary');
            const selectedDateIndex = ref(0);
            const isConnected = ref(false);
            const statusMessage = ref('連線中...');
            
            const exchangeRate = ref(0.22);
            const currencyInput = ref(50000);
            const members = ref(['徐續簡進', '孫吳空', '吳古雜糧', '何蕭了嗎', '陳黃廟']);
            
            const shoppingCategories = [
                { id: 'souvenir', name: '伴手禮', color: 'bg-orange-400', icon: 'fa-solid fa-gift' },
                { id: 'snack', name: '零食', color: 'bg-yellow-400', icon: 'fa-solid fa-cookie-bite' },
                { id: 'drug', name: '藥妝', color: 'bg-pink-400', icon: 'fa-solid fa-pump-soap' },
                { id: 'electric', name: '電器', color: 'bg-blue-400', icon: 'fa-solid fa-plug' },
                { id: 'clothes', name: '服飾', color: 'bg-purple-400', icon: 'fa-solid fa-shirt' },
                { id: 'other', name: '其他', color: 'bg-slate-400', icon: 'fa-solid fa-bag-shopping' }
            ];

            const shoppingList = ref([]);
            const expenses = ref([]);
            const itineraryData = ref([]);
            const mustBuyList = ref([]);

            const showItineraryModal = ref(false);
            const showShoppingModal = ref(false);
            const showExpenseModal = ref(false);
            const isEditMode = ref(false);
            const isMustBuyEditMode = ref(false);
            const newRegionName = ref('');
            const isRemoteUpdate = ref(false);

            const newItinerary = ref({ id: null, category: 'sightseeing', name: '', startTime: '', address: '', price: '', note: '' });
            const newShoppingItem = ref({ name: '', qty: 1, category: 'souvenir', buyer: '' });
            
            // 花費狀態 (增加 type: 'expense' | 'transfer')
            const newExpense = ref({ 
                type: 'expense', // 預設為消費
                name: '', amount: null, category: 'food', date: '2026-03-06', 
                payment: 'cash', payer: members.value[0], payee: members.value[1], involved: [...members.value] 
            });

            // Static Data
            const CATEGORY_MAP = { sightseeing: { color: 'bg-green-500', icon: 'fa-solid fa-camera' }, food: { color: 'bg-red-400', icon: 'fa-solid fa-utensils' }, shopping: { color: 'bg-orange-400', icon: 'fa-solid fa-bag-shopping' }, accommodation: { color: 'bg-purple-500', icon: 'fa-solid fa-bed' }, flight: { color: 'bg-blue-500', icon: 'fa-solid fa-plane' }, transport: { color: 'bg-indigo-500', icon: 'fa-solid fa-van-shuttle' }, ticket: { color: 'bg-cyan-500', icon: 'fa-solid fa-ticket' }, stay: { color: 'bg-purple-500', icon: 'fa-solid fa-hotel' }, transfer: { color: 'bg-teal-500', icon: 'fa-solid fa-money-bill-transfer' } };
            const dates = ref([{ date: '3/06', weekday: '五', area: '星野', temp: '-2°C', weather: 'snow', transport: '包車' }, { date: '3/07', weekday: '六', area: '定山溪/札幌', temp: '0°C', weather: 'cloudy', transport: '包車' }, { date: '3/08', weekday: '日', area: '登別/函館', temp: '2°C', weather: 'sunny', transport: '包車' }, { date: '3/09', weekday: '一', area: '函館', temp: '3°C', weather: 'sunny', transport: '市電' }, { date: '3/10', weekday: '二', area: '函館/札幌', temp: '1°C', weather: 'cloudy', transport: 'JR' }, { date: '3/11', weekday: '三', area: '小樽', temp: '-1°C', weather: 'snow', transport: 'JR' }, { date: '3/12', weekday: '四', area: '旭山', temp: '-5°C', weather: 'snow', transport: '巴士' }, { date: '3/13', weekday: '五', area: '札幌', temp: '1°C', weather: 'cloudy', transport: '地鐵' }, { date: '3/14', weekday: '六', area: '回程', temp: '2°C', weather: 'sunny', transport: '飛機' }]);
            const hotels = ref([{ name: '星野リゾート トマム The Tower', date: '3/06', address: '北海道勇払郡占冠村中トマム' }, { name: 'Vessel Inn 札幌中島公園', date: '3/07', address: '札幌市中央區南九條西4-1-2' }, { name: 'OMO5 函館 by 星野集團', date: '3/08', address: '函館市若松町24番1' }, { name: 'Royal Park Canvas 札幌大通公園', date: '3/10', address: '札幌市中央区大通西1-12' }]);

            // Computed
            const currencyResult = computed(() => Math.round(currencyInput.value * exchangeRate.value));
            const currentItinerary = computed(() => itineraryData.value[selectedDateIndex.value] || []);
            const totalExpensesJPY = computed(() => expenses.value.filter(e => e.category !== 'transfer').reduce((sum, e) => sum + (e.amount || 0), 0));
            const totalExpensesTWD = computed(() => Math.round(totalExpensesJPY.value * exchangeRate.value));
            
            // Settlement Logic (Updated for Transfer)
            const balanceSheet = computed(() => {
                const balances = {};
                members.value.forEach(m => balances[m] = { name: m, paid: 0, share: 0, balance: 0 });
                
                expenses.value.forEach(exp => {
                    if (exp.category === 'transfer') {
                        // 轉帳邏輯：A 給 B 錢 => A paid, B share (A 債權增加/債務減少，B 債權減少/債務增加)
                        if (balances[exp.payer]) balances[exp.payer].paid += exp.amount;
                        if (balances[exp.involved[0]]) balances[exp.involved[0]].share += exp.amount;
                    } else {
                        // 一般消費邏輯
                        if (balances[exp.payer]) balances[exp.payer].paid += exp.amount;
                        if (exp.involved && exp.involved.length > 0) {
                            const amountPerPerson = exp.amount / exp.involved.length;
                            exp.involved.forEach(p => { if(balances[p]) balances[p].share += amountPerPerson; });
                        }
                    }
                });
                return Object.values(balances).map(m => { m.balance = Math.round(m.paid - m.share); return m; });
            });

            // Settlement Plan
            const settlements = computed(() => {
                let debts = balanceSheet.value.filter(m => m.balance < -10).map(m => ({...m})); // 忽略小額誤差
                let credits = balanceSheet.value.filter(m => m.balance > 10).map(m => ({...m}));
                debts.sort((a, b) => a.balance - b.balance);
                credits.sort((a, b) => b.balance - a.balance);

                const result = [];
                let i = 0, j = 0;
                while(i < debts.length && j < credits.length) {
                    let debtor = debts[i];
                    let creditor = credits[j];
                    let amount = Math.min(Math.abs(debtor.balance), creditor.balance);
                    
                    if(amount > 0) {
                        result.push({ from: debtor.name, to: creditor.name, amount: Math.round(amount) });
                    }
                    debtor.balance += amount;
                    creditor.balance -= amount;
                    if(Math.abs(debtor.balance) < 10) i++;
                    if(Math.abs(creditor.balance) < 10) j++;
                }
                return result;
            });

            const syncStatusClass = computed(() => {
               if(statusMessage.value === '儲存中...') return 'busy';
               if(isConnected.value) return 'online';
               return '';
            });

            let debounceTimer = null;
            const triggerSync = () => {
                if (isRemoteUpdate.value) return; 
                statusMessage.value = '儲存中...';
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(syncData, 1500); 
            };

            const syncData = () => {
                if (!db) return;
                setDoc(doc(db, "trips", "hokkaido2026"), {
                    shoppingList: shoppingList.value,
                    expenses: expenses.value,
                    itineraryData: JSON.stringify(itineraryData.value),
                    mustBuyList: mustBuyList.value,
                    exchangeRate: exchangeRate.value,
                    lastUpdated: new Date()
                }).then(() => {
                    statusMessage.value = '已同步';
                    isConnected.value = true;
                }).catch(err => {
                    statusMessage.value = '同步失敗';
                    console.error(err);
                });
            };

            watch([shoppingList, expenses, itineraryData, mustBuyList, exchangeRate], () => {
                if (isRemoteUpdate.value) return; 
                triggerSync();
            }, { deep: true });

            onMounted(() => {
                if (db) {
                    onSnapshot(doc(db, "trips", "hokkaido2026"), (doc) => {
                        if (doc.exists()) {
                            isRemoteUpdate.value = true; 
                            const data = doc.data();
                            if(data.shoppingList) shoppingList.value = data.shoppingList;
                            if(data.expenses) expenses.value = data.expenses;
                            if(data.itineraryData) {
                                try {
                                    itineraryData.value = typeof data.itineraryData === 'string' ? JSON.parse(data.itineraryData) : data.itineraryData;
                                } catch(e) { console.error("Data parse error", e); }
                            }
                            if(data.mustBuyList) mustBuyList.value = data.mustBuyList;
                            if(data.exchangeRate) exchangeRate.value = data.exchangeRate;
                            isConnected.value = true;
                            statusMessage.value = '連線正常';
                            nextTick(() => { isRemoteUpdate.value = false; });
                        } else {
                            syncData();
                        }
                    });
                } else {
                    statusMessage.value = '未設定 Firebase';
                }
            });

            // Methods
            const formatNumber = (num) => num ? num.toLocaleString() : '0';
            const calculateCurrency = () => {}; 
            const getCategoryColor = (cat) => CATEGORY_MAP[cat]?.color || 'bg-gray-400';
            const getCategoryIcon = (cat) => CATEGORY_MAP[cat]?.icon || 'fa-solid fa-circle';
            const getShoppingCategoryColor = (id) => shoppingCategories.find(c => c.id === id)?.color || 'bg-slate-400';
            const getShoppingCategoryIcon = (id) => shoppingCategories.find(c => c.id === id)?.icon || 'fa-solid fa-bag-shopping';
            const getShoppingCategoryName = (id) => shoppingCategories.find(c => c.id === id)?.name || '其他';
            const getWeatherIcon = (w) => w === 'snow' ? 'fa-solid fa-snowflake' : (w === 'sunny' ? 'fa-solid fa-sun' : 'fa-solid fa-cloud');
            const openMap = (q) => window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(q)}`, '_blank');
            const handleAddClick = () => {
                if (currentTab.value === 'itinerary') { isEditMode.value = false; newItinerary.value = { category: 'sightseeing' }; showItineraryModal.value = true; }
                else if (currentTab.value === 'shopping') { newShoppingItem.value = { name: '', qty: 1, category: 'souvenir', buyer: members.value[0] }; showShoppingModal.value = true; }
                else if (currentTab.value === 'expenses') { newExpense.value = { type: 'expense', category: 'food', payment: 'cash', date: '2026-03-06', payer: members.value[0], payee: members.value[1], involved: [...members.value], amount: null, name: '' }; showExpenseModal.value = true; }
            };
            const toggleSelectAll = () => newExpense.value.involved = newExpense.value.involved.length === members.value.length ? [] : [...members.value];
            const saveItineraryItem = () => {
                if(!newItinerary.value.name) return;
                const newItem = { ...newItinerary.value, id: Date.now(), isNoteExpanded: false };
                if(isEditMode.value) {
                    const idx = currentItinerary.value.findIndex(i => i.id === newItem.id);
                    if(idx !== -1) currentItinerary.value[idx] = newItem;
                } else {
                    itineraryData.value[selectedDateIndex.value].push(newItem);
                    itineraryData.value[selectedDateIndex.value].sort((a,b) => (a.startTime > b.startTime) ? 1 : -1);
                }
                showItineraryModal.value = false;
                triggerSync();
            };
            const editItem = (item) => { isEditMode.value = true; newItinerary.value = { ...item }; showItineraryModal.value = true; };
            const addShoppingItem = () => { if(newShoppingItem.value.name) shoppingList.value.push({ ...newShoppingItem.value, checked: false }); showShoppingModal.value = false; triggerSync(); };
            const removeShoppingItem = (idx) => { shoppingList.value.splice(idx, 1); triggerSync(); };
            const resetShoppingForm = () => { newShoppingItem.value = { name: '', qty: 1, category: 'souvenir', buyer: members.value[0] }; };
            
            // Add Expense (Handle Transfer vs Expense)
            const addExpense = () => { 
                if(!newExpense.value.amount) return;
                
                if (newExpense.value.type === 'transfer') {
                    // 轉帳記錄
                    expenses.value.push({
                        name: `轉帳: ${newExpense.value.payer} ➔ ${newExpense.value.payee}`,
                        amount: newExpense.value.amount,
                        category: 'transfer',
                        date: newExpense.value.date,
                        payer: newExpense.value.payer,
                        involved: [newExpense.value.payee] // 只有收款人涉及
                    });
                } else {
                    // 一般消費記錄
                    if(!newExpense.value.name) return;
                    expenses.value.push({ 
                        ...newExpense.value, 
                        involved: [...newExpense.value.involved] 
                    }); 
                }
                showExpenseModal.value = false; 
                triggerSync(); 
            };
            
            const removeExpense = (idx) => { expenses.value.splice(idx, 1); triggerSync(); };
            const addRegion = () => { if (newRegionName.value) { mustBuyList.value.push({ area: newRegionName.value, items: [] }); newRegionName.value = ''; triggerSync(); }};
            const removeRegion = (idx) => { mustBuyList.value.splice(idx, 1); triggerSync(); };
            const addMustBuyItem = (rIdx, event) => { const val = event.target.value.trim(); if (val) { mustBuyList.value[rIdx].items.push(val); event.target.value = ''; triggerSync(); }};
            const removeMustBuyItem = (rIdx, iIdx) => { mustBuyList.value[rIdx].items.splice(iIdx, 1); triggerSync(); };

            return {
                currentTab, dates, selectedDateIndex, hotels, mustBuyList, shoppingList, expenses, members, shoppingCategories,
                itineraryData, currentItinerary, totalExpensesJPY, totalExpensesTWD, balanceSheet, settlements,
                currencyInput, currencyResult, calculateCurrency, formatNumber, exchangeRate,
                getCategoryColor, getCategoryIcon, getWeatherIcon, openMap,
                getShoppingCategoryColor, getShoppingCategoryIcon, getShoppingCategoryName,
                showItineraryModal, showShoppingModal, showExpenseModal, isEditMode,
                newItinerary, newShoppingItem, newExpense,
                handleAddClick, saveItineraryItem, editItem,
                addShoppingItem, removeShoppingItem, addExpense, removeExpense,
                toggleSelectAll, isMustBuyEditMode, newRegionName, addRegion, removeRegion, addMustBuyItem, removeMustBuyItem,
                triggerSync, syncData, isConnected, statusMessage, syncStatusClass,
                resetShoppingForm 
            }
        }
    }).mount('#app');
</script>
</body>
</html>