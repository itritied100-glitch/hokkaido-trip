<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hokkaido Trip 2026 (雲端同步版)</title>
    
    <!-- Tab Icon -->
    <link rel="icon" type="image/jpeg" href="./image_ec3041.jpg">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- SortableJS (For Drag and Drop) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'jp-slate': '#7A848D',
                        'jp-rust': '#976666',
                        'jp-sage': '#A9B7AA',
                        'jp-rose': '#C09D9B',
                        'jp-sand': '#DBD2C9',
                        'jp-beige': '#DBD4C6',
                        'jp-mist': '#CCD2CC',
                        'jp-gray-1': '#999EA2',
                        'jp-gray-2': '#93939B',
                        'jp-silver': '#BEBEBE',
                        'balance-pos': '#A9B7AA',
                        'balance-neg': '#EF5350'
                    }
                }
            }
        }
    </script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        
        body { background-color: #F2F4F6; -webkit-tap-highlight-color: transparent; font-family: 'Noto Sans TC', sans-serif; color: #7A848D; }
        .app-container { max-width: 480px; margin: 0 auto; min-height: 100vh; background-color: #ffffff; box-shadow: 0 0 40px rgba(122, 132, 141, 0.15); position: relative; padding-bottom: 90px; }
        .header-bg { background-color: #ffffff; padding: 0; position: relative; overflow: hidden; box-shadow: 0 4px 20px rgba(122, 132, 141, 0.2); border-bottom-left-radius: 35px; border-bottom-right-radius: 35px; z-index: 10; height: 280px; }
        .header-image-container { width: 100%; height: 100%; position: relative; }
        .header-image-container img { width: 100%; height: 100%; object-fit: cover; object-position: center bottom; }
        .snow-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><circle cx="50" cy="50" r="1" fill="%23fff" opacity="0.8"/><circle cx="20" cy="80" r="0.5" fill="%23fff" opacity="0.6"/><circle cx="70" cy="30" r="1.5" fill="%23fff" opacity="0.9"/></svg>'); background-size: 100px 100px; opacity: 0.8; animation: snowfall 10s linear infinite; z-index: 5; pointer-events: none; }
        @keyframes snowfall { to { background-position: 100px 100px; } }
        .side-tab-bar { position: absolute; bottom: 20px; right: 20px; z-index: 30; display: flex; gap: 10px; }
        .tab-button { width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; box-shadow: 0 4px 12px rgba(122, 132, 141, 0.3); transition: all 0.3s ease; background-color: rgba(255, 255, 255, 0.95); color: #BEBEBE; border: 2px solid white; }
        .tab-button.active { background-color: #7A848D; color: #ffffff; transform: scale(1.1) translateY(-5px); box-shadow: 0 8px 20px rgba(122, 132, 141, 0.5); border-color: #7A848D; }
        .app-main { padding-top: 20px; position: relative; z-index: 5; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .card-shadow { box-shadow: 0 4px 20px rgba(153, 158, 162, 0.15); transition: transform 0.2s ease; border: 1px solid #F0F2F5; }
        .animate-fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .note-content { max-height: 2.5rem; overflow: hidden; transition: max-height 0.3s ease-out; }
        .note-content.expanded { max-height: 500px; }
        .date-selector-sticky { background-color: rgba(255,255,255,0.95); backdrop-filter: blur(8px); border-bottom: 1px solid #E5E7EB; z-index: 20; top: 0; padding-top: 10px; padding-bottom: 10px; }
        .banner-text-overlay { background: linear-gradient(to top, rgba(122, 132, 141, 0.7) 0%, rgba(0,0,0,0) 100%); position: absolute; bottom: 0; left: 0; width: 100%; height: 60%; border-bottom-left-radius: 35px; border-bottom-right-radius: 35px; pointer-events: none; }
        .member-checkbox:checked + div { background-color: #7A848D; color: white; border-color: #7A848D; }
        .sync-status { position: absolute; top: 20px; right: 20px; z-index: 50; font-size: 0.7rem; padding: 4px 10px; border-radius: 20px; background: rgba(122, 132, 141, 0.6); color: white; backdrop-filter: blur(4px); display: flex; align-items: center; gap: 6px; letter-spacing: 0.5px; }
        .sync-dot { width: 6px; height: 6px; border-radius: 50%; background-color: #976666; }
        .sync-dot.online { background-color: #A9B7AA; box-shadow: 0 0 5px #A9B7AA; }
        .sync-dot.busy { background-color: #DBD4C6; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        .pie-chart { border-radius: 50%; transition: all 0.5s ease; }
        .drag-handle { cursor: move; touch-action: none; }
        
        /* 飛機圖示飛行方向 */
        .flight-arrow-outbound { transform: rotate(90deg); display: inline-block; }
        .flight-arrow-inbound { transform: rotate(-90deg); display: inline-block; }
    </style>
</head>
<body class="text-jp-slate">

<div id="app" class="app-container">

    <!-- Sync Status -->
    <div class="sync-status">
        <div class="sync-dot" :class="syncStatusClass"></div>
        <span>{{ statusMessage }}</span>
    </div>

    <!-- Header -->
    <div class="header-bg">
        <div class="header-image-container">
            <img src="./banner.jpg"
                 onerror="this.src='https://images.unsplash.com/photo-1548578709-32269a838573?q=80&w=1920&auto=format&fit=crop'"
                 alt="北海道家族旅行">
            <div class="banner-text-overlay"></div>
            <div class="absolute bottom-6 left-6 text-white z-20">
                <h1 class="text-3xl font-bold tracking-widest drop-shadow-md text-white">HOKKAIDO</h1>
                <p class="text-sm font-light tracking-wider opacity-90 text-jp-silver">2026.03.06 - 03.14</p>
            </div>
        </div>
        <div class="snow-layer"></div> 
        <div class="side-tab-bar">
            <button @click="currentTab = 'itinerary'" :class="{'active': currentTab === 'itinerary'}" class="tab-button"><i class="fa-solid fa-map-location-dot"></i></button>
            <button @click="currentTab = 'info'" :class="{'active': currentTab === 'info'}" class="tab-button"><i class="fa-solid fa-circle-info"></i></button>
            <button @click="currentTab = 'shopping'" :class="{'active': currentTab === 'shopping'}" class="tab-button"><i class="fa-solid fa-basket-shopping"></i></button>
            <button @click="currentTab = 'expenses'" :class="{'active': currentTab === 'expenses'}" class="tab-button"><i class="fa-solid fa-coins"></i></button>
        </div>
    </div>

    <!-- Main Content -->
    <main class="p-4 app-main">
        
        <!-- Tab 1: 行程 -->
        <div v-if="currentTab === 'itinerary'" class="animate-fade-in">
            <div class="flex overflow-x-auto hide-scrollbar space-x-3 mb-6 snap-x px-1 sticky date-selector-sticky -mx-4 px-4 pb-2">
                <div v-for="(day, index) in dates" :key="index" @click="selectedDateIndex = index"
                     class="snap-center flex-shrink-0 w-[70px] h-[80px] rounded-2xl flex flex-col items-center justify-center cursor-pointer transition-all duration-300 border shadow-sm"
                     :class="selectedDateIndex === index ? 'bg-jp-slate text-white border-jp-slate shadow-lg scale-105' : 'bg-white text-jp-gray-1 border-transparent hover:bg-jp-mist/20'">
                    <span class="text-[10px] font-bold uppercase tracking-wider opacity-90">{{ day.dayLabel }}</span>
                    <span class="text-sm font-bold mt-0.5">{{ day.date }}</span> 
                    <span class="text-[10px] font-medium opacity-70">({{ day.weekday }})</span> 
                </div>
            </div>

            <!-- 行程標題與天氣 -->
            <div class="flex items-center justify-between mb-6 px-1 mt-2">
                <div class="flex items-center gap-2 flex-1 min-w-0 mr-4">
                    <i class="fa-solid fa-map-location-dot text-2xl text-jp-rust shrink-0"></i>
                    <input v-model="dates[selectedDateIndex].area" 
                           @change="triggerSync"
                           class="text-3xl font-bold text-jp-slate tracking-tight bg-transparent border-b-2 border-transparent focus:border-jp-slate focus:outline-none w-full truncate"
                           type="text">
                </div>
                <div class="flex flex-col items-end shrink-0">
                    <div class="flex items-center gap-2 mb-1">
                         <span class="text-2xl font-bold text-jp-gray-1 tracking-tight">{{ dates[selectedDateIndex].temp }}</span>
                         <div class="w-8 h-8 rounded-full bg-white border border-jp-mist/50 flex items-center justify-center text-jp-slate shadow-sm" :title="dates[selectedDateIndex].weather">
                            <i :class="getWeatherIcon(dates[selectedDateIndex].weather)" class="text-lg"></i>
                        </div>
                    </div>
                     <span v-if="dates[selectedDateIndex].transport" class="text-[10px] bg-jp-mist/30 text-jp-slate px-2 py-0.5 rounded-full mt-1">
                        <i class="fa-solid fa-van-shuttle mr-1"></i> {{ dates[selectedDateIndex].transport }}
                    </span>
                </div>
            </div>

            <!-- 行程列表 -->
            <div class="space-y-4 pb-20" id="itinerary-list" ref="itineraryList">
                <div v-for="(item, idx) in currentItinerary" :key="item.id" class="relative pl-4 group" :data-id="item.id">
                    <!-- 連接線 -->
                    <div v-if="idx < currentItinerary.length - 1" class="absolute left-[23px] top-8 bottom-[-16px] w-0.5 bg-jp-silver/50 z-0">
                        <!-- 交通時間標籤 -->
                        <div v-if="item.travelTime" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-jp-mist/80 text-jp-slate text-[9px] font-bold px-1.5 py-0.5 rounded-full border border-white whitespace-nowrap z-10 shadow-sm">
                            <i class="fa-solid fa-arrow-down mr-0.5"></i> {{ item.travelTime }}
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-2xl p-4 card-shadow relative z-10">
                        <div class="flex items-start gap-3">
                            <div class="flex flex-col items-center min-w-[50px]">
                                <div class="w-10 h-10 rounded-full flex items-center justify-center text-white shadow-md text-sm mb-1" :class="getCategoryColor(item.category)">
                                    <i :class="getCategoryIcon(item.category)"></i>
                                </div>
                                <span class="text-xs font-bold text-jp-gray-1">{{ item.startTime }}</span>
                            </div>
                            
                            <div class="flex-1 min-w-0">
                                <div class="flex justify-between items-start">
                                    <h3 class="font-bold text-jp-slate text-lg leading-tight truncate pr-6">{{ item.name }}</h3>
                                    <div class="flex gap-3 shrink-0 absolute top-4 right-4">
                                         <button @click.stop="editItem(item)" class="text-jp-silver hover:text-jp-slate transition-colors"><i class="fa-solid fa-pencil"></i></button>
                                         <button @click.stop="removeItineraryItemCard(item.id)" class="text-jp-silver hover:text-jp-rust transition-colors"><i class="fa-solid fa-trash-can"></i></button>
                                         <button class="drag-handle text-jp-silver hover:text-jp-slate transition-colors"><i class="fa-solid fa-bars"></i></button>
                                    </div>
                                </div>
                                
                                <div class="flex gap-2 mt-2">
                                    <!-- 地址連結按鈕 -->
                                    <button v-if="item.address" @click.stop="openMap(item.address)" class="text-xs bg-jp-mist/20 text-jp-slate px-2.5 py-1.5 rounded-lg hover:bg-jp-slate hover:text-white transition-colors flex items-center text-left">
                                        <i class="fa-solid fa-location-dot mr-1.5 text-jp-rust"></i> {{ item.address }}
                                    </button>
                                    <!-- 備用導航按鈕 -->
                                    <button v-else @click.stop="openMap(item.name)" class="text-xs bg-jp-mist/20 text-jp-slate px-2.5 py-1.5 rounded-lg hover:bg-jp-slate hover:text-white transition-colors flex items-center">
                                        <i class="fa-solid fa-map mr-1.5"></i> 導航
                                    </button>

                                    <!-- 費用標籤 -->
                                    <span v-if="item.price" class="text-xs bg-jp-rose/10 text-jp-rose px-2.5 py-1.5 rounded-lg border border-jp-rose/20 flex items-center whitespace-nowrap">
                                        <i class="fa-solid fa-ticket mr-1.5"></i> {{ item.price }}
                                    </span>
                                </div>
                                
                                <div v-if="item.note" class="mt-3 bg-jp-mist/10 p-2.5 rounded-xl border border-jp-mist/20 text-xs text-jp-gray-2 whitespace-pre-line">
                                    <div class="note-content" :class="{'expanded': item.isNoteExpanded}">{{ item.note }}</div>
                                    <button v-if="item.note.length > 40" @click="item.isNoteExpanded = !item.isNoteExpanded" class="text-jp-slate font-bold mt-1">{{ item.isNoteExpanded ? '收合' : '展開...' }}</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div v-if="currentItinerary.length === 0" class="text-center py-10 text-jp-silver"><p>本日暫無行程，點擊右下角 + 新增</p></div>
            </div>
        </div>

        <!-- Tab 2: 資訊 -->
        <div v-if="currentTab === 'info'" class="animate-fade-in space-y-5 pb-20">
             <!-- 匯率計算 (雙向) -->
             <div class="bg-gradient-to-br from-jp-slate to-jp-gray-2 rounded-3xl p-6 text-white shadow-xl relative overflow-hidden">
                <div class="absolute top-0 right-0 w-32 h-32 bg-white/5 rounded-full -mr-10 -mt-10 blur-2xl"></div>
                <div class="flex justify-between items-center mb-4 relative z-10">
                    <h3 class="font-bold flex items-center"><i class="fa-solid fa-calculator mr-2"></i> 匯率換算</h3>
                    <div class="flex items-center bg-white/10 rounded-lg px-2 py-1 border border-white/10">
                        <span class="text-xs text-jp-sand mr-1">匯率:</span>
                        <input type="number" v-model="exchangeRate" @change="triggerSync" step="0.001" class="w-12 bg-transparent text-white font-bold text-sm text-right focus:outline-none border-b border-white/30">
                    </div>
                </div>
                <div class="flex items-center justify-between gap-4 relative z-10">
                    <div class="flex-1">
                        <label class="text-[10px] text-jp-sand block mb-1">JPY</label>
                        <input type="number" v-model="calcJPY" @input="calculateTWD" class="w-full bg-white/10 border border-white/20 rounded-xl px-3 py-2 text-white font-bold text-lg focus:outline-none">
                    </div>
                    <i class="fa-solid fa-arrow-right-arrow-left text-jp-sand mt-4"></i>
                    <div class="flex-1">
                        <label class="text-[10px] text-jp-sand block mb-1">TWD</label>
                        <!-- 雙向綁定 -->
                        <input type="number" v-model="calcTWD" @input="calculateJPY" class="w-full bg-white/10 border border-white/20 rounded-xl px-3 py-2 text-white font-bold text-lg focus:outline-none">
                    </div>
                </div>
            </div>

            <!-- 航班資訊 -->
            <div class="bg-white rounded-3xl p-6 card-shadow mb-6">
                <h3 class="font-bold text-jp-slate mb-4 border-b border-jp-mist/30 pb-2 flex items-center">
                    <i class="fa-solid fa-plane-departure text-jp-gray-1 mr-2"></i> 航班資訊
                </h3>
                
                <div class="space-y-6">
                    <!-- 去程 -->
                    <div class="relative pl-3 border-l-2 border-jp-rust/50">
                        <div class="absolute -left-[5px] top-0 w-2.5 h-2.5 rounded-full bg-jp-rust"></div>
                        <span class="text-xs font-bold text-white bg-jp-rust px-2 py-0.5 rounded mb-2 inline-block">去程 03/06 (五)</span>
                        <div class="bg-jp-mist/10 p-3 rounded-xl">
                            <div class="flex justify-between items-center mb-1">
                                <span class="font-bold text-jp-slate">泰越捷航空 VZ570</span>
                            </div>
                            <div class="flex justify-between text-sm text-jp-gray-2">
                                <div>
                                    <div class="font-mono font-bold text-jp-slate text-lg">02:50</div>
                                    <div class="text-xs">TPE T1</div>
                                </div>
                                <i class="fa-solid fa-plane text-jp-rose mx-3 flight-arrow-outbound"></i>
                                <div class="text-right">
                                    <div class="font-mono font-bold text-jp-slate text-lg">07:30</div>
                                    <div class="text-xs">CTS</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 回程 -->
                    <div class="relative pl-3 border-l-2 border-jp-slate/50">
                        <div class="absolute -left-[5px] top-0 w-2.5 h-2.5 rounded-full bg-jp-slate"></div>
                        <span class="text-xs font-bold text-white bg-jp-slate px-2 py-0.5 rounded mb-2 inline-block">回程 03/14 (六)</span>
                        
                        <div class="space-y-3">
                            <!-- 回程 1 -->
                            <div class="bg-jp-mist/10 p-3 rounded-xl border border-transparent hover:border-jp-mist/50 transition-colors">
                                <div class="flex justify-between items-center mb-1">
                                    <span class="font-bold text-jp-slate text-sm">中華航空 CI131</span>
                                </div>
                                <div class="flex justify-between items-center text-sm text-jp-gray-2">
                                    <div><span class="font-mono font-bold text-jp-slate text-lg">14:40</span> CTS</div>
                                    <i class="fa-solid fa-plane text-jp-silver mx-2 flight-arrow-inbound"></i>
                                    <div class="text-right"><span class="font-mono font-bold text-jp-slate text-lg">18:15</span> TPE T2</div>
                                </div>
                            </div>
                            <!-- 回程 2 -->
                            <div class="bg-jp-mist/10 p-3 rounded-xl border border-transparent hover:border-jp-mist/50 transition-colors">
                                <div class="flex justify-between items-center mb-1">
                                    <span class="font-bold text-jp-slate text-sm">星宇航空 JX851</span>
                                </div>
                                <div class="flex justify-between items-center text-sm text-jp-gray-2">
                                    <div><span class="font-mono font-bold text-jp-slate text-lg">15:20</span> CTS</div>
                                    <i class="fa-solid fa-plane text-jp-silver mx-2 flight-arrow-inbound"></i>
                                    <div class="text-right"><span class="font-mono font-bold text-jp-slate text-lg">19:05</span> TPE T1</div>
                                </div>
                            </div>
                            <!-- 回程 3 -->
                            <div class="bg-jp-mist/10 p-3 rounded-xl border border-transparent hover:border-jp-mist/50 transition-colors">
                                <div class="flex justify-between items-center mb-1">
                                    <span class="font-bold text-jp-slate text-sm">酷航 TR893</span>
                                </div>
                                <div class="flex justify-between items-center text-sm text-jp-gray-2">
                                    <div><span class="font-mono font-bold text-jp-slate text-lg">18:40</span> CTS</div>
                                    <i class="fa-solid fa-plane text-jp-silver mx-2 flight-arrow-inbound"></i>
                                    <div class="text-right"><span class="font-mono font-bold text-jp-slate text-lg">22:20</span> TPE T1</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 住宿清單 -->
            <div class="bg-white rounded-3xl p-6 card-shadow">
                <h3 class="font-bold text-jp-slate mb-4 border-b border-jp-mist/30 pb-2"><i class="fa-solid fa-hotel text-jp-rose mr-2"></i> 住宿清單</h3>
                <ul class="space-y-4">
                    <li v-for="hotel in hotels" class="group">
                        <div class="flex justify-between items-start">
                            <div><span class="font-bold text-jp-slate block">{{ hotel.name }}</span><span class="text-xs bg-jp-mist/30 text-jp-slate px-2 py-0.5 rounded-md mt-1 inline-block">{{ hotel.date }}</span></div>
                            <button @click="openMap(hotel.name)" class="w-8 h-8 rounded-full bg-jp-mist/20 text-jp-slate flex items-center justify-center hover:bg-jp-slate hover:text-white transition-colors"><i class="fa-solid fa-location-arrow text-xs"></i></button>
                        </div>
                        <p class="text-xs text-jp-gray-1 mt-1"><i class="fa-solid fa-map-pin mr-1"></i> {{ hotel.address }}</p>
                    </li>
                </ul>
            </div>

            <!-- 必買清單 -->
            <div class="bg-white rounded-3xl p-6 card-shadow relative mt-6">
                <div class="flex justify-between items-center mb-4 border-b border-jp-mist/30 pb-2">
                    <h3 class="font-bold text-jp-slate"><i class="fa-solid fa-thumbs-up text-jp-rust mr-2"></i> 必買推薦</h3>
                    <button @click="isMustBuyEditMode = !isMustBuyEditMode" class="text-xs px-2 py-1 rounded-full transition-colors" :class="isMustBuyEditMode ? 'bg-jp-slate text-white' : 'bg-jp-mist/30 text-jp-slate'">
                        <i class="fa-solid fa-pen-to-square mr-1"></i> {{ isMustBuyEditMode ? '完成' : '編輯' }}
                    </button>
                </div>
                
                <div v-for="(region, rIdx) in mustBuyList" :key="rIdx" class="mb-5 last:mb-0 group/region">
                    <div class="flex items-center mb-2">
                        <span class="w-1.5 h-4 bg-jp-rose rounded-r mr-2"></span>
                        <input v-if="isMustBuyEditMode" v-model="region.area" @change="triggerSync" class="font-bold text-sm text-jp-gray-2 bg-gray-50 border-b border-jp-silver w-full focus:outline-none">
                        <h4 v-else class="font-bold text-sm text-jp-gray-2">{{ region.area }}</h4>
                        <button v-if="isMustBuyEditMode" @click="removeRegion(rIdx)" class="ml-2 text-jp-silver hover:text-jp-rust text-xs"><i class="fa-solid fa-trash-can"></i></button>
                    </div>
                    <div class="flex flex-wrap gap-2">
                        <span v-for="(item, iIdx) in region.items" :key="iIdx" class="bg-jp-beige/50 text-jp-gray-2 text-xs px-3 py-1.5 rounded-lg border border-jp-beige flex items-center">
                            {{ item }}
                            <button v-if="isMustBuyEditMode" @click="removeMustBuyItem(rIdx, iIdx)" class="ml-2 text-jp-silver hover:text-jp-rust font-bold">×</button>
                        </span>
                        <div v-if="isMustBuyEditMode" class="flex items-center">
                            <input @keyup.enter="addMustBuyItem(rIdx, $event)" placeholder="輸入後Enter" class="text-xs bg-white border border-jp-silver rounded-lg px-2 py-1.5 w-24 outline-none focus:border-jp-slate">
                        </div>
                    </div>
                </div>

                <div v-if="isMustBuyEditMode" class="mt-4 pt-4 border-t border-jp-mist/30">
                    <div class="flex items-center gap-2">
                        <input v-model="newRegionName" placeholder="新區域名稱" class="flex-1 text-sm bg-gray-50 border border-jp-silver rounded-lg px-3 py-2 outline-none focus:border-jp-slate">
                        <button @click="addRegion" class="bg-jp-slate text-white text-xs px-3 py-2 rounded-lg font-bold">新增</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab 3: 購物清單 -->
        <div v-if="currentTab === 'shopping'" class="animate-fade-in pb-20">
            <button @click="showShoppingModal = true; resetShoppingForm()" class="w-full bg-white border-2 border-dashed border-jp-silver rounded-2xl p-4 mb-4 text-jp-gray-1 font-bold hover:bg-jp-beige/20 hover:border-jp-slate transition-colors flex items-center justify-center">
                <i class="fa-solid fa-plus mr-2"></i> 新增待買商品
            </button>

            <div class="space-y-3">
                <div v-for="(item, idx) in shoppingList" :key="idx" class="flex items-center bg-white p-3 rounded-2xl card-shadow transition-all hover:translate-x-1">
                    <div class="mr-3 pl-1">
                        <input type="checkbox" v-model="item.checked" @change="triggerSync" class="w-5 h-5 accent-jp-slate rounded border-jp-silver cursor-pointer">
                    </div>
                    <!-- 分類圖示 -->
                    <div class="w-10 h-10 rounded-lg flex items-center justify-center text-white text-sm shrink-0 shadow-sm"
                         :class="getShoppingCategoryColor(item.category)">
                        <i :class="getShoppingCategoryIcon(item.category)"></i>
                    </div>
                    <div class="flex-1 ml-3 overflow-hidden">
                        <div class="flex items-center">
                            <p class="font-bold text-sm text-jp-slate truncate" :class="{'line-through text-jp-silver': item.checked}">{{ item.name }}</p>
                            <span v-if="item.buyer" class="ml-2 text-[10px] bg-jp-mist/20 text-jp-slate px-1.5 py-0.5 rounded border border-jp-mist/30 flex items-center shrink-0">
                                <i class="fa-solid fa-user mr-1 text-[8px]"></i>{{ item.buyer }}
                            </span>
                        </div>
                        <p class="text-xs text-jp-gray-1 mt-0.5 flex items-center">
                            <span class="font-mono text-deep-sea-blue font-bold mr-2">x{{ item.qty }}</span>
                            <span class="text-[10px] bg-jp-beige/40 px-1.5 py-0.5 rounded text-jp-gray-2">{{ getShoppingCategoryName(item.category) }}</span>
                        </p>
                    </div>
                    <button @click="removeShoppingItem(idx)" class="w-8 h-8 rounded-full flex items-center justify-center text-jp-silver hover:text-jp-rust hover:bg-jp-rose/10 transition-colors ml-2">
                        <i class="fa-solid fa-trash-can"></i>
                    </button>
                </div>
                <div v-if="shoppingList.length === 0" class="text-center py-10 text-jp-silver text-sm">暫無購物清單</div>
            </div>
        </div>

        <!-- Tab 4: 花費 -->
        <div v-if="currentTab === 'expenses'" class="animate-fade-in pb-20">
            <!-- 總支出 -->
            <div class="bg-gradient-to-r from-jp-slate to-jp-gray-2 text-white rounded-3xl p-6 mb-6 relative overflow-hidden shadow-lg">
                <div class="absolute -right-10 -top-10 bg-white/10 w-48 h-48 rounded-full blur-3xl"></div>
                
                <div class="flex justify-between items-end relative z-10">
                    <div>
                        <p class="text-xs text-jp-sand mb-1">本次行程總支出</p>
                        <h2 class="text-3xl font-bold tracking-tight">¥ {{ formatNumber(totalExpensesJPY) }}</h2>
                    </div>
                    <div class="text-right">
                        <p class="text-lg font-bold text-jp-sand">NT$ {{ formatNumber(totalExpensesTWD) }}</p>
                    </div>
                </div>
            </div>

            <!-- 新增支出按鈕 -->
            <button @click="handleAddClick" class="w-full bg-jp-rust text-white rounded-2xl p-3 mb-6 shadow-md hover:bg-jp-rust/90 transition-all flex items-center justify-center font-bold">
                <i class="fa-solid fa-plus mr-2"></i> 新增支出
            </button>

            <!-- 支出明細篩選 -->
            <div class="mb-6">
                 <h3 class="font-bold text-jp-slate mb-3 flex items-center text-sm px-1"><i class="fa-solid fa-filter mr-2 text-jp-gray-1"></i> 支出明細篩選</h3>
                 <div class="flex gap-3">
                     <select v-model="filterMember" class="flex-1 bg-white border border-jp-mist/50 rounded-xl p-2.5 text-sm text-jp-slate outline-none focus:border-jp-rust">
                         <option value="all">所有成員</option>
                         <option v-for="m in members" :key="m" :value="m">{{ m }}</option>
                     </select>
                     <select v-model="filterCategory" class="flex-1 bg-white border border-jp-mist/50 rounded-xl p-2.5 text-sm text-jp-slate outline-none focus:border-jp-rust">
                         <option value="all">所有類別</option>
                         <option v-for="(icon, cat) in CATEGORY_MAP" :key="cat" :value="cat">{{ CATEGORY_MAP_NAME[cat] || cat }}</option>
                     </select>
                 </div>
                 <div v-if="filteredExpenses.length > 0 && (filterMember !== 'all' || filterCategory !== 'all')" class="mt-2 text-right text-xs text-jp-gray-1">
                     篩選總計: ¥{{ formatNumber(filteredExpenses.reduce((s, e) => s + e.amount, 0)) }}
                 </div>
            </div>

            <!-- 分帳結算 -->
            <div class="mb-6">
                <h3 class="font-bold text-jp-slate mb-3 flex items-center text-sm px-1"><i class="fa-solid fa-scale-balanced text-jp-rose mr-2"></i> 分帳結算</h3>
                
                <div class="flex overflow-x-auto hide-scrollbar gap-3 px-1 pb-2">
                    <div v-for="member in balanceSheet" :key="member.name" 
                         @click="selectedMemberName = member.name"
                         class="flex flex-col items-center min-w-[60px] cursor-pointer transition-all duration-300"
                         :class="selectedMemberName === member.name ? 'scale-110 opacity-100' : 'opacity-60 scale-100'">
                        <div class="w-12 h-12 rounded-full flex items-center justify-center text-white font-bold text-lg mb-1 shadow-md transition-colors border-2 border-white"
                             :class="member.balance >= 0 ? 'bg-jp-sage' : 'bg-jp-rust'">
                            {{ member.name.charAt(0) }}
                        </div>
                        <span class="text-xs font-bold text-jp-gray-2 whitespace-nowrap">{{ member.name }}</span>
                    </div>
                </div>

                <div v-if="selectedMemberData" class="bg-white rounded-3xl p-5 mt-2 shadow-sm border border-jp-mist/30 animate-fade-in">
                    <div class="flex justify-between items-center mb-4 border-b border-jp-mist/30 pb-3">
                        <h3 class="font-bold text-jp-slate text-lg">{{ selectedMemberData.name }} 的帳務</h3>
                        <div class="text-right">
                            <span class="block font-bold text-lg" :class="selectedMemberData.balance >= 0 ? 'text-jp-sage' : 'text-jp-rust'">
                                {{ selectedMemberData.balance >= 0 ? '應收' : '應付' }} ¥{{ formatNumber(Math.abs(selectedMemberData.balance)) }}
                            </span>
                            <span class="text-xs opacity-60 block" :class="selectedMemberData.balanceTWD >= 0 ? 'text-jp-sage' : 'text-jp-rust'">
                                ≈ NT$ {{ formatNumber(Math.abs(selectedMemberData.balanceTWD)) }}
                            </span>
                        </div>
                    </div>
                    
                    <!-- Charts: 收支對比 -->
                    <div class="mb-5">
                        <div class="flex justify-between text-xs text-jp-gray-1 mb-1">
                            <span>收支對比 (JPY)</span>
                        </div>
                        <div class="w-full h-3 bg-jp-mist/20 rounded-full flex overflow-hidden">
                            <div class="bg-jp-rose h-full" :style="{ width: (selectedMemberData.share / (Math.max(selectedMemberData.share, selectedMemberData.paid) * 1.2 || 1) * 100) + '%' }"></div>
                        </div>
                        <div class="flex justify-between text-[10px] mt-1 text-jp-gray-2">
                            <span>應付 ¥{{ formatNumber(Math.round(selectedMemberData.share)) }}</span>
                            <span>已付 ¥{{ formatNumber(selectedMemberData.paid) }}</span>
                        </div>
                        <div class="w-full h-3 bg-jp-mist/20 rounded-full flex overflow-hidden mt-1">
                            <div class="bg-jp-slate h-full" :style="{ width: (selectedMemberData.paid / (Math.max(selectedMemberData.share, selectedMemberData.paid) * 1.2 || 1) * 100) + '%' }"></div>
                        </div>
                    </div>

                    <!-- Pie Chart: 消費類別 (Updated to Horizontal Bar List) -->
                    <div v-if="selectedMemberData.categoryBreakdown" class="mb-2">
                        <div class="text-xs text-jp-gray-1 mb-3">消費類別分析 (依金額排序)</div>
                        <div class="space-y-2">
                            <!-- Loop through sorted categories -->
                            <div v-for="(amount, cat) in Object.entries(selectedMemberData.categoryBreakdown).sort((a,b) => b[1] - a[1])" 
                                 :key="cat[0]" 
                                 v-show="amount > 0">
                                
                                <div class="flex justify-between items-center text-[10px] text-jp-gray-2 mb-0.5">
                                    <div class="flex items-center">
                                        <i :class="[getCategoryIcon(cat[0]), 'mr-1.5 text-xs', 'text-' + getCategoryColor(cat[0]).replace('bg-', '')]"></i>
                                        <span>{{ CATEGORY_MAP_NAME[cat[0]] || cat[0] }}</span>
                                    </div>
                                    <div class="text-right">
                                        <span class="font-bold text-jp-slate mr-1">¥{{ formatNumber(Math.round(amount)) }}</span>
                                        <span class="opacity-60">({{ Math.round(amount / (selectedMemberData.share || 1) * 100) }}%)</span>
                                    </div>
                                </div>
                                <div class="w-full h-1.5 bg-jp-mist/20 rounded-full overflow-hidden">
                                    <div class="h-full rounded-full" 
                                         :class="getCategoryColor(cat[0])"
                                         :style="{ width: (amount / (selectedMemberData.share || 1) * 100) + '%' }">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 支付方式分析 (Pie Chart) -->
                    <div class="mb-2 mt-4 border-t border-jp-mist/30 pt-4">
                        <div class="text-xs text-jp-gray-1 mb-3">支付方式分析 (墊付)</div>
                        <div class="flex items-center justify-between bg-m-mist/5 p-3 rounded-xl">
                             <div class="relative w-24 h-24 pie-chart shadow-inner"
                                  :style="{ background: getPaymentPieChartGradient(selectedMemberData) }">
                                  <div class="absolute inset-3 bg-white rounded-full"></div>
                             </div>
                             
                             <div class="flex-1 ml-4 space-y-2">
                                 <div class="flex items-center justify-between text-[10px] text-jp-gray-2" v-if="selectedMemberData.paidCash > 0">
                                     <div class="flex items-center"><div class="w-2.5 h-2.5 rounded-full mr-2 bg-jp-rust"></div><span>現金</span></div>
                                     <span class="font-bold text-jp-slate">¥{{ formatNumber(selectedMemberData.paidCash) }}</span>
                                 </div>
                                 <div class="flex items-center justify-between text-[10px] text-jp-gray-2" v-if="selectedMemberData.paidCard > 0">
                                     <div class="flex items-center"><div class="w-2.5 h-2.5 rounded-full mr-2 bg-jp-slate"></div><span>信用卡</span></div>
                                     <span class="font-bold text-jp-slate">¥{{ formatNumber(selectedMemberData.paidCard) }}</span>
                                 </div>
                                 <div v-if="selectedMemberData.paid === 0" class="text-xs text-jp-silver italic text-center">無墊付紀錄</div>
                             </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4 mt-4 pt-4 border-t border-jp-mist/30">
                        <div class="bg-jp-beige/20 p-3 rounded-xl border border-jp-beige/50">
                            <span class="text-xs text-jp-gray-1 block mb-1">消費 (應付)</span>
                            <span class="block font-bold text-jp-slate text-lg">¥ {{ formatNumber(Math.round(selectedMemberData.share)) }}</span>
                            <span class="block text-xs text-jp-gray-2 mt-0.5">NT$ {{ formatNumber(Math.round(selectedMemberData.shareTWD)) }}</span>
                        </div>
                        <div class="bg-jp-beige/20 p-3 rounded-xl border border-jp-beige/50">
                            <span class="text-xs text-jp-gray-1 block mb-1">墊付 (已付)</span>
                            <span class="block font-bold text-jp-slate text-lg">¥ {{ formatNumber(selectedMemberData.paid) }}</span>
                            <span class="block text-xs text-jp-gray-2 mt-0.5">NT$ {{ formatNumber(selectedMemberData.paidTWD) }}</span>
                            <div class="mt-1 pt-1 border-t border-jp-mist/30 text-[9px] text-jp-gray-1">
                                (現金: ¥{{ formatNumber(selectedMemberData.paidCash) }} / 卡: ¥{{ formatNumber(selectedMemberData.paidCard) }})
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 最佳還款 -->
            <div v-if="settlements.length > 0" class="bg-gradient-to-br from-jp-beige/40 to-jp-sage/10 rounded-3xl p-5 mb-6 shadow-sm border border-jp-sage/20">
                <h3 class="font-bold text-jp-slate mb-3 flex items-center text-sm"><i class="fa-solid fa-hand-holding-dollar mr-2 text-jp-sage"></i> 建議還款方案</h3>
                <div class="space-y-2">
                    <div v-for="(txn, idx) in settlements" :key="idx" class="flex items-center justify-between bg-white/80 p-2.5 rounded-xl border border-white">
                        <div class="flex items-center text-sm text-jp-gray-2">
                            <span class="font-bold text-jp-slate">{{ txn.from }}</span>
                            <i class="fa-solid fa-arrow-right-long mx-2 text-jp-silver text-xs"></i>
                            <span class="font-bold text-jp-slate">{{ txn.to }}</span>
                        </div>
                        <div class="text-right">
                            <span class="block font-bold text-jp-sage text-sm font-mono">¥{{ formatNumber(txn.amount) }}</span>
                            <span class="block text-[9px] text-jp-gray-1">≈ NT$ {{ formatNumber(Math.round(txn.amountTWD)) }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-t-3xl min-h-[400px] p-6 shadow-[0_-10px_40px_rgba(0,0,0,0.03)] -mx-4 px-8">
                <h3 class="font-bold text-jp-slate mb-5 flex items-center"><i class="fa-solid fa-receipt text-jp-gray-1 mr-2"></i>支出紀錄</h3>
                <div v-if="expenses.length === 0" class="text-center text-jp-silver py-10">尚無紀錄</div>
                <div v-else class="space-y-4">
                    <!-- Filtered Expenses Loop -->
                    <div v-for="(exp, idx) in filteredExpenses" :key="idx" class="flex items-start justify-between border-b border-jp-mist/30 pb-3 last:border-0">
                        <div class="flex items-start">
                            <div class="w-10 h-10 rounded-full flex items-center justify-center text-white text-xs mr-3 shadow-sm shrink-0" :class="getCategoryColor(exp.category)">
                                <i :class="getCategoryIcon(exp.category)"></i>
                            </div>
                            <div>
                                <p class="font-bold text-jp-slate text-sm">{{ exp.name }}</p>
                                <p class="text-[10px] text-jp-gray-1 mt-0.5">
                                    <span v-if="exp.category === 'transfer'" class="text-jp-sage font-bold">轉帳還款</span>
                                    <span v-else>
                                        <span class="bg-jp-mist/20 px-1.5 py-0.5 rounded text-jp-gray-2 mr-1">{{ exp.payer }}</span>
                                        <span v-if="exp.involved && exp.involved.length < members.length" class="text-jp-rust">({{ exp.involved.length }}人)</span>
                                        <span v-else>全體</span>
                                        <span class="ml-1 text-jp-gray-2">
                                            <i v-if="exp.payment === 'card'" class="fa-regular fa-credit-card"></i>
                                            <i v-else class="fa-solid fa-coins"></i>
                                        </span>
                                    </span>
                                </p>
                            </div>
                        </div>
                        <div class="text-right shrink-0">
                            <p class="font-bold text-jp-slate text-sm">¥{{ formatNumber(exp.amount) }}</p>
                            <p class="text-[10px] text-jp-gray-1">NT$ {{ formatNumber(exp.amountTWD) }}</p>
                            <div class="flex justify-end gap-2 mt-1">
                                <button @click="editExpense(exp, idx)" class="text-[10px] text-jp-silver hover:text-jp-slate"><i class="fa-solid fa-pen"></i></button>
                                <button @click="removeExpense(idx)" class="text-[10px] text-jp-silver hover:text-jp-rust"><i class="fa-solid fa-trash-can"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- FAB: Only on shopping/itinerary tabs now -->
    <button v-if="currentTab !== 'info' && currentTab !== 'expenses'" @click="handleAddClick" class="fixed bottom-24 right-6 w-14 h-14 bg-jp-rust rounded-full shadow-[0_4px_15px_rgba(151,102,102,0.5)] text-white text-2xl flex items-center justify-center hover:scale-110 transition-transform z-40">
        <i class="fa-solid fa-plus"></i>
    </button>

    <!-- 1. 行程 Modal -->
    <div v-if="showItineraryModal" class="fixed inset-0 bg-jp-slate/40 z-50 flex items-center justify-center p-6 backdrop-blur-sm animate-fade-in">
        <div class="bg-white rounded-3xl w-full max-w-sm p-6 shadow-2xl max-h-[90vh] overflow-y-auto">
            <h3 class="font-bold text-lg mb-4 text-center text-jp-slate">{{ isEditMode ? '編輯行程' : '新增行程' }}</h3>
            <div class="space-y-3">
                <select v-model="newItinerary.category" class="w-full bg-jp-mist/20 rounded-xl p-3 text-sm outline-none text-jp-slate">
                    <option value="sightseeing">景點</option>
                    <option value="food">飲食</option>
                    <option value="shopping">購物</option>
                    <option value="accommodation">住宿</option>
                    <option value="transport">交通</option>
                    <option value="flight">航班</option>
                </select>
                <input v-model="newItinerary.name" placeholder="名稱" class="w-full bg-jp-mist/20 rounded-xl p-3 text-sm outline-none focus:ring-2 focus:ring-jp-slate text-jp-slate">
                <input v-model="newItinerary.startTime" type="time" class="w-full bg-jp-mist/20 rounded-xl p-3 text-sm outline-none text-jp-slate">
                <input v-model="newItinerary.address" placeholder="地址" class="w-full bg-jp-mist/20 rounded-xl p-3 text-sm outline-none text-jp-slate">
                <input v-model="newItinerary.price" placeholder="費用" class="w-full bg-jp-mist/20 rounded-xl p-3 text-sm outline-none text-jp-slate">
                <textarea v-model="newItinerary.note" placeholder="備註" rows="3" class="w-full bg-jp-mist/20 rounded-xl p-3 text-sm outline-none text-jp-slate"></textarea>
            </div>
            
            <div class="flex space-x-3 mt-6">
                 <!-- 修正：當 isEditMode 為 true 時顯示刪除按鈕 -->
                <button v-if="isEditMode" @click="removeItineraryItem" class="py-3 px-4 rounded-xl bg-jp-rust/10 text-jp-rust font-bold text-sm hover:bg-jp-rust/20"><i class="fa-solid fa-trash-can"></i></button>
                <button @click="showItineraryModal = false" class="flex-1 py-3 rounded-xl bg-jp-mist/30 text-jp-gray-2 font-bold text-sm">取消</button>
                <button @click="saveItineraryItem" class="flex-1 py-3 rounded-xl bg-jp-slate text-white font-bold text-sm shadow-md">{{ isEditMode ? '更新' : '新增' }}</button>
            </div>
        </div>
    </div>

    <!-- 2. 購物 Modal -->
    <div v-if="showShoppingModal" class="fixed inset-0 bg-jp-slate/40 z-50 flex items-center justify-center p-6 backdrop-blur-sm animate-fade-in">
        <div class="bg-white rounded-3xl w-full max-w-sm p-6 shadow-2xl">
            <h3 class="font-bold text-lg mb-4 text-center text-jp-slate">新增購物清單</h3>
            <div class="grid grid-cols-3 gap-3 mb-4">
                <div class="col-span-2">
                    <input v-model="newShoppingItem.name" type="text" placeholder="商品名稱" class="w-full bg-jp-mist/20 rounded-xl p-3 text-sm focus:outline-none focus:ring-2 focus:ring-jp-slate text-jp-slate">
                </div>
                <div>
                    <input v-model="newShoppingItem.qty" type="number" placeholder="數量" class="w-full bg-jp-mist/20 rounded-xl p-3 text-sm focus:outline-none text-jp-slate">
                </div>
            </div>
            
            <div class="mb-4">
                <label class="block text-xs font-bold text-jp-gray-1 mb-2 pl-1">指定購買人</label>
                <div class="flex gap-2 overflow-x-auto pb-2 hide-scrollbar">
                    <button v-for="m in members" :key="m"
                            @click="newShoppingItem.buyer = m"
                            :class="newShoppingItem.buyer === m ? 'bg-jp-slate text-white shadow-md' : 'bg-jp-mist/20 text-jp-gray-2 border border-jp-mist/30'"
                            class="whitespace-nowrap px-3 py-1.5 rounded-lg text-xs font-bold transition-all">
                        {{ m }}
                    </button>
                </div>
            </div>

            <div class="mb-6">
                <label class="block text-xs font-bold text-jp-gray-1 mb-2 pl-1">商品分類</label>
                <div class="grid grid-cols-3 gap-2">
                    <button v-for="cat in shoppingCategories" :key="cat.id" 
                            @click="newShoppingItem.category = cat.id"
                            :class="newShoppingItem.category === cat.id ? 'bg-jp-slate text-white shadow-md' : 'bg-jp-mist/20 text-jp-gray-2 hover:bg-jp-mist/30'"
                            class="py-2.5 rounded-xl text-xs font-bold transition-all flex items-center justify-center">
                        <i :class="cat.icon" class="mr-1.5"></i> {{ cat.name }}
                    </button>
                </div>
            </div>

            <div class="flex space-x-3">
                <button @click="showShoppingModal = false" class="flex-1 py-3 rounded-xl bg-jp-mist/30 text-jp-gray-2 font-bold text-sm">取消</button>
                <button @click="addShoppingItem" class="flex-1 py-3 rounded-xl bg-jp-slate text-white font-bold text-sm shadow-md">新增</button>
            </div>
        </div>
    </div>

    <!-- 3. 新增花費 Modal -->
    <div v-if="showExpenseModal" class="fixed inset-0 bg-jp-slate/40 z-50 flex items-center justify-center p-6 backdrop-blur-sm animate-fade-in">
        <div class="bg-white rounded-3xl w-full max-w-sm p-6 shadow-2xl max-h-[95vh] overflow-y-auto">
            <h3 class="font-bold text-lg mb-4 text-center text-jp-slate">{{ isExpenseEditMode ? '編輯支出' : '記一筆' }}</h3>
            
            <div class="flex mb-5 bg-jp-mist/20 p-1 rounded-xl">
                <button @click="newExpense.type = 'expense'" :class="newExpense.type === 'expense' ? 'bg-white shadow text-jp-slate' : 'text-jp-gray-1'" class="flex-1 py-2 rounded-lg text-sm font-bold transition-all">一般消費</button>
                <button @click="newExpense.type = 'transfer'" :class="newExpense.type === 'transfer' ? 'bg-white shadow text-jp-sage' : 'text-jp-gray-1'" class="flex-1 py-2 rounded-lg text-sm font-bold transition-all">轉帳還款</button>
            </div>

            <div class="mb-4 bg-jp-mist/10 p-3 rounded-xl border border-jp-mist/30 flex justify-between items-center">
                <span class="text-xs text-jp-gray-1 font-bold">本筆匯率</span>
                <div class="flex items-center">
                    <span class="text-xs text-jp-gray-1 mr-1">1 JPY =</span>
                    <input v-model="newExpense.customRate" @input="onRateInput" type="number" step="0.001" class="w-14 bg-white border border-jp-silver rounded px-1 py-0.5 text-sm text-right outline-none focus:border-jp-slate text-jp-slate">
                    <span class="text-xs text-jp-gray-1 ml-1">TWD</span>
                </div>
            </div>

            <div v-if="newExpense.type === 'expense'">
                <div class="grid grid-cols-2 gap-3 mb-3">
                    <input v-model="newExpense.date" type="date" class="bg-jp-mist/20 rounded-xl p-3 text-sm outline-none text-jp-slate">
                    <select v-model="newExpense.category" class="bg-jp-mist/20 rounded-xl p-3 text-sm outline-none text-jp-slate">
                        <option value="food">飲食</option>
                        <option value="shopping">購物</option>
                        <option value="transport">交通</option>
                        <option value="stay">住宿</option>
                        <option value="ticket">門票</option>
                        <option value="entertainment">娛樂</option>
                        <option value="communication">網卡/通訊</option>
                        <option value="medical">醫藥</option>
                        <option value="other">其他/雜支</option>
                    </select>
                </div>
                <input v-model="newExpense.name" placeholder="項目名稱" class="w-full bg-jp-mist/20 rounded-xl p-4 mb-4 text-sm focus:outline-none text-jp-slate">
                
                <div class="grid grid-cols-2 gap-3 mb-4">
                    <div class="relative">
                        <span class="absolute left-3 top-3 text-jp-gray-1 font-bold text-xs">JPY</span>
                        <input v-model.number="newExpense.amount" @input="onJPYInput" type="number" placeholder="日幣" class="w-full bg-jp-mist/20 rounded-xl p-3 pl-10 text-sm outline-none focus:ring-2 focus:ring-jp-slate text-jp-slate font-bold">
                    </div>
                    <div class="relative">
                        <span class="absolute left-3 top-3 text-jp-gray-1 font-bold text-xs">TWD</span>
                        <input v-model.number="newExpense.amountTWD" @input="onTWDInput" type="number" placeholder="台幣" class="w-full bg-jp-mist/20 rounded-xl p-3 pl-10 text-sm outline-none focus:ring-2 focus:ring-jp-slate text-jp-slate">
                    </div>
                </div>

                <div class="flex space-x-3 mb-4">
                    <button @click="newExpense.payment='cash'" :class="newExpense.payment==='cash' ? 'bg-jp-slate text-white' : 'bg-jp-mist/20 text-jp-gray-2'" class="flex-1 py-2 rounded-xl text-sm transition-colors font-bold"><i class="fa-solid fa-coins mr-1"></i> 現金</button>
                    <button @click="newExpense.payment='card'" :class="newExpense.payment==='card' ? 'bg-jp-slate text-white' : 'bg-jp-mist/20 text-jp-gray-2'" class="flex-1 py-2 rounded-xl text-sm transition-colors font-bold"><i class="fa-regular fa-credit-card mr-1"></i> 信用卡</button>
                </div>

                <div class="mb-6 border-t border-jp-mist/30 pt-4">
                    <label class="block text-xs font-bold text-jp-gray-1 mb-2">付款人 (誰先墊?)</label>
                    <select v-model="newExpense.payer" class="w-full bg-jp-mist/30 text-jp-slate font-bold rounded-xl p-3 text-sm outline-none mb-4">
                        <option v-for="m in members" :key="m" :value="m">{{ m }}</option>
                    </select>
                    <div class="flex justify-between items-center mb-2">
                        <label class="block text-xs font-bold text-jp-gray-1">分攤對象</label>
                        <button @click="toggleSelectAll" class="text-xs text-jp-slate font-bold">{{ newExpense.involved.length === members.length ? '全取消' : '全選' }}</button>
                    </div>
                    <div class="grid grid-cols-2 gap-2 mb-3">
                        <label v-for="m in members" :key="m" class="cursor-pointer relative">
                            <input type="checkbox" :value="m" v-model="newExpense.involved" class="member-checkbox hidden">
                            <div class="bg-jp-mist/20 border border-jp-mist/50 rounded-lg p-2 text-center text-xs text-jp-gray-2 transition-colors hover:bg-jp-mist/40">{{ m }}</div>
                        </label>
                    </div>
                    <div v-if="newExpense.amount > 0 && newExpense.involved.length > 0" class="bg-jp-beige/30 rounded-xl p-3 flex justify-between items-center">
                        <span class="text-xs text-jp-rust">每人應付</span>
                        <span class="font-bold text-jp-rust">¥ {{ formatNumber(Math.ceil(newExpense.amount / newExpense.involved.length)) }}</span>
                    </div>
                </div>
            </div>

            <div v-else>
                <div class="mb-4">
                    <input v-model="newExpense.date" type="date" class="w-full bg-jp-mist/20 rounded-xl p-3 text-sm outline-none mb-4 text-jp-slate">
                    
                    <div class="flex items-center justify-between gap-2 mb-4">
                        <div class="flex-1">
                            <label class="block text-xs font-bold text-jp-gray-1 mb-1">轉出 (還錢)</label>
                            <select v-model="newExpense.payer" class="w-full bg-jp-rust/10 text-jp-rust font-bold rounded-xl p-3 text-sm outline-none">
                                <option v-for="m in members" :key="m" :value="m">{{ m }}</option>
                            </select>
                        </div>
                        <i class="fa-solid fa-arrow-right text-jp-silver mt-4"></i>
                        <div class="flex-1">
                            <label class="block text-xs font-bold text-jp-gray-1 mb-1">轉入 (收錢)</label>
                            <select v-model="newExpense.payee" class="w-full bg-jp-sage/20 text-jp-sage font-bold rounded-xl p-3 text-sm outline-none">
                                <option v-for="m in members" :key="m" :value="m">{{ m }}</option>
                            </select>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-3 mb-4">
                        <div class="relative">
                            <span class="absolute left-3 top-3 text-jp-gray-1 font-bold text-xs">JPY</span>
                            <input v-model.number="newExpense.amount" @input="onJPYInput" type="number" placeholder="日幣" class="w-full bg-jp-mist/20 rounded-xl p-3 pl-10 text-sm outline-none focus:ring-2 focus:ring-jp-sage font-bold text-jp-sage">
                        </div>
                        <div class="relative">
                            <span class="absolute left-3 top-3 text-jp-gray-1 font-bold text-xs">TWD</span>
                            <input v-model.number="newExpense.amountTWD" @input="onTWDInput" type="number" placeholder="台幣" class="w-full bg-jp-mist/20 rounded-xl p-3 pl-10 text-sm outline-none focus:ring-2 focus:ring-jp-sage">
                        </div>
                    </div>
                </div>
            </div>

            <div class="flex space-x-3">
                <button @click="showExpenseModal = false" class="flex-1 py-3 rounded-xl bg-jp-mist/30 text-jp-gray-2 font-bold text-sm">取消</button>
                <button @click="saveExpense" class="flex-1 py-3 rounded-xl bg-jp-rust text-white font-bold text-sm shadow-md">儲存</button>
            </div>
        </div>
    </div>

</div>

<!-- Firebase SDK -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
    import { createApp, ref, computed, onMounted, watch, nextTick } from "https://unpkg.com/vue@3/dist/vue.esm-browser.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDqqag1anowaW3XPQejcYZl8lUTgE7FRWs",
      authDomain: "hokkaido-trip-55b8f.firebaseapp.com",
      projectId: "hokkaido-trip-55b8f",
      storageBucket: "hokkaido-trip-55b8f.firebasestorage.app",
      messagingSenderId: "802810791692",
      appId: "1:802810791692:web:b161ebee4e105f5bda6b29"
    };

    let db;
    try { const app = initializeApp(firebaseConfig); db = getFirestore(app); } catch (e) { console.error("Firebase Init Failed", e); }

    createApp({
        setup() {
            const currentTab = ref('itinerary');
            const selectedDateIndex = ref(0);
            const isConnected = ref(false);
            const statusMessage = ref('連線中...');
            const exchangeRate = ref(0.22);
            // currencyInput removed
            const members = ref(['徐續簡進', '孫吳空', '吳古雜糧', '何蕭了嗎', '陳黃廟']);
            const selectedMemberName = ref(members.value[0]); 
            
            const shoppingCategories = [
                { id: 'souvenir', name: '伴手禮', color: 'bg-jp-rose', icon: 'fa-solid fa-gift' },
                { id: 'snack', name: '零食', color: 'bg-jp-sand', icon: 'fa-solid fa-cookie-bite' },
                { id: 'drug', name: '藥妝', color: 'bg-jp-rust', icon: 'fa-solid fa-pump-soap' },
                { id: 'electric', name: '電器', color: 'bg-jp-slate', icon: 'fa-solid fa-plug' },
                { id: 'clothes', name: '服飾', color: 'bg-jp-sage', icon: 'fa-solid fa-shirt' },
                { id: 'other', name: '其他', color: 'bg-jp-gray-1', icon: 'fa-solid fa-bag-shopping' }
            ];

            const shoppingList = ref([]);
            const expenses = ref([]);
            const itineraryData = ref([]);
            const mustBuyList = ref([]);

            // Filters
            const filterMember = ref('all');
            const filterCategory = ref('all');

            const showItineraryModal = ref(false);
            const showShoppingModal = ref(false);
            const showExpenseModal = ref(false);
            const isEditMode = ref(false);
            const isMustBuyEditMode = ref(false);
            const newRegionName = ref('');
            const isRemoteUpdate = ref(false);
            
            // New state for expense editing
            const isExpenseEditMode = ref(false);
            const editingExpenseIndex = ref(null);

            const newItinerary = ref({ id: null, category: 'sightseeing', name: '', startTime: '', address: '', price: '', note: '' });
            const newShoppingItem = ref({ name: '', qty: 1, category: 'souvenir', buyer: '' });
            
            const newExpense = ref({ 
                type: 'expense', name: '', amount: null, amountTWD: null, 
                customRate: 0.22, category: 'food', date: '2026-03-06', 
                payment: 'cash', payer: members.value[0], payee: members.value[1], involved: [...members.value] 
            });

            const onJPYInput = () => { if(newExpense.value.amount) newExpense.value.amountTWD = Math.round(newExpense.value.amount * newExpense.value.customRate); else newExpense.value.amountTWD = null; };
            const onTWDInput = () => { if(newExpense.value.amountTWD) newExpense.value.amount = Math.round(newExpense.value.amountTWD / newExpense.value.customRate); else newExpense.value.amount = null; };
            const onRateInput = () => { if(newExpense.value.amount) newExpense.value.amountTWD = Math.round(newExpense.value.amount * newExpense.value.customRate); };

            // Info Tab Calculator Logic (Bi-directional)
            const calcJPY = ref(50000); 
            const calcTWD = ref(Math.round(50000 * 0.22));
            const calculateTWD = () => { if (calcJPY.value !== '') calcTWD.value = Math.round(calcJPY.value * exchangeRate.value); };
            const calculateJPY = () => { if (calcTWD.value !== '') calcJPY.value = Math.round(calcTWD.value / exchangeRate.value); };
            const onExchangeRateChange = () => { triggerSync(); calculateTWD(); };

            const CATEGORY_MAP = { 
                sightseeing: { color: 'bg-jp-sage', icon: 'fa-solid fa-camera' }, 
                food: { color: 'bg-jp-rust', icon: 'fa-solid fa-utensils' }, 
                shopping: { color: 'bg-jp-rose', icon: 'fa-solid fa-bag-shopping' }, 
                accommodation: { color: 'bg-jp-slate', icon: 'fa-solid fa-bed' }, 
                flight: { color: 'bg-jp-gray-1', icon: 'fa-solid fa-plane' }, 
                transport: { color: 'bg-jp-gray-2', icon: 'fa-solid fa-van-shuttle' }, 
                ticket: { color: 'bg-jp-sage', icon: 'fa-solid fa-ticket' }, 
                stay: { color: 'bg-jp-slate', icon: 'fa-solid fa-hotel' }, 
                transfer: { color: 'bg-jp-sage', icon: 'fa-solid fa-money-bill-transfer' },
                entertainment: { color: 'bg-jp-sand', icon: 'fa-solid fa-gamepad' },
                communication: { color: 'bg-jp-gray-2', icon: 'fa-solid fa-wifi' },
                medical: { color: 'bg-jp-rose', icon: 'fa-solid fa-kit-medical' },
                other: { color: 'bg-jp-silver', icon: 'fa-solid fa-ellipsis' }
            };
            const CATEGORY_MAP_NAME = { sightseeing: '景點', food: '飲食', shopping: '購物', accommodation: '住宿', flight: '機票', transport: '交通', ticket: '門票', stay: '住宿', transfer: '轉帳', entertainment: '娛樂', communication: '通訊', medical: '醫藥', other: '其他' };
            const CATEGORY_HEX = { sightseeing: '#A9B7AA', food: '#976666', shopping: '#C09D9B', accommodation: '#7A848D', flight: '#999EA2', transport: '#93939B', ticket: '#A9B7AA', stay: '#7A848D', transfer: '#A9B7AA', entertainment: '#DBD2C9', communication: '#93939B', medical: '#C09D9B', other: '#BEBEBE' };

            const dates = ref([
                { dayLabel: 'Day 1', date: '03/06', weekday: '五', area: '星野', temp: '-2°C', weather: 'snow', transport: '包車' }, 
                { dayLabel: 'Day 2', date: '03/07', weekday: '六', area: '定山溪/札幌', temp: '0°C', weather: 'cloudy', transport: '包車' }, 
                { dayLabel: 'Day 3', date: '03/08', weekday: '日', area: '登別/函館', temp: '2°C', weather: 'sunny', transport: '包車' }, 
                { dayLabel: 'Day 4', date: '03/09', weekday: '一', area: '函館', temp: '3°C', weather: 'sunny', transport: '市電' }, 
                { dayLabel: 'Day 5', date: '03/10', weekday: '二', area: '函館/札幌', temp: '1°C', weather: 'cloudy', transport: 'JR' }, 
                { dayLabel: 'Day 6', date: '03/11', weekday: '三', area: '小樽', temp: '-1°C', weather: 'snow', transport: 'JR' }, 
                { dayLabel: 'Day 7', date: '03/12', weekday: '四', area: '旭山', temp: '-5°C', weather: 'snow', transport: '巴士' }, 
                { dayLabel: 'Day 8', date: '03/13', weekday: '五', area: '札幌', temp: '1°C', weather: 'cloudy', transport: '地鐵' }, 
                { dayLabel: 'Day 9', date: '03/14', weekday: '六', area: '回程', temp: '2°C', weather: 'sunny', transport: '飛機' }
            ]);
            
            const hotels = ref([{ name: '星野リゾート トマム The Tower', date: '3/06', address: '北海道勇払郡占冠村中トマム' }, { name: 'Vessel Inn 札幌中島公園', date: '3/07', address: '札幌市中央區南九條西4-1-2' }, { name: 'OMO5 函館 by 星野集團', date: '3/08', address: '函館市若松町24番1' }, { name: 'Royal Park Canvas 札幌大通公園', date: '3/10', address: '札幌市中央区大通西1-12' }]);
            
            const inboundFlights = ref([
                { airline: '中華航空', code: 'CI131', depTime: '14:40', arrTime: '18:15', arrTerminal: 'TPE T2' },
                { airline: '星宇航空', code: 'JX851', depTime: '15:20', arrTime: '19:05', arrTerminal: 'TPE T1' },
                { airline: '酷航', code: 'TR893', depTime: '18:40', arrTime: '22:20', arrTerminal: 'TPE T1' }
            ]);

            // Removed currencyResult as it is no longer used directly in template (using calcTWD)
            const currentItinerary = computed(() => itineraryData.value[selectedDateIndex.value] || []);
            
            // Computed for filtered expenses
            const filteredExpenses = computed(() => {
                return expenses.value.filter(exp => {
                    const matchMember = filterMember.value === 'all' || exp.payer === filterMember.value || (exp.involved && exp.involved.includes(filterMember.value));
                    const matchCategory = filterCategory.value === 'all' || exp.category === filterCategory.value;
                    return matchMember && matchCategory;
                }).sort((a, b) => new Date(b.date) - new Date(a.date)); // Sort by date desc
            });

            const totalExpensesTWD = computed(() => expenses.value.filter(e => e.category !== 'transfer').reduce((sum, e) => sum + (e.amountTWD || Math.round(e.amount * (e.customRate || exchangeRate.value))), 0));
            const totalExpensesJPY = computed(() => expenses.value.filter(e => e.category !== 'transfer').reduce((sum, e) => sum + (e.amount || 0), 0));
            
            const balanceSheet = computed(() => {
                const balances = {};
                members.value.forEach(m => balances[m] = { name: m, paid: 0, share: 0, balance: 0, paidTWD: 0, shareTWD: 0, balanceTWD: 0, paidCash: 0, paidCard: 0, categoryBreakdown: {} });
                Object.keys(CATEGORY_MAP).forEach(cat => { members.value.forEach(m => balances[m].categoryBreakdown[cat] = 0) });

                expenses.value.forEach(exp => {
                    const rate = exp.customRate || exchangeRate.value;
                    const jpy = exp.amount;
                    const twd = exp.amountTWD || Math.round(jpy * rate);

                    if (exp.category === 'transfer') {
                        if (balances[exp.payer]) { balances[exp.payer].paid += jpy; balances[exp.payer].paidTWD += twd; }
                        if (balances[exp.involved[0]]) { balances[exp.involved[0]].share += jpy; balances[exp.involved[0]].shareTWD += twd; }
                    } else {
                        if (balances[exp.payer]) { 
                            balances[exp.payer].paid += jpy; 
                            balances[exp.payer].paidTWD += twd;
                            if(exp.payment === 'cash') balances[exp.payer].paidCash += jpy;
                            if(exp.payment === 'card') balances[exp.payer].paidCard += jpy;
                        }
                        if (exp.involved && exp.involved.length > 0) {
                            const shareJPY = jpy / exp.involved.length;
                            const shareTWD = twd / exp.involved.length;
                            exp.involved.forEach(p => { 
                                if(balances[p]) {
                                    balances[p].share += shareJPY;
                                    balances[p].shareTWD += shareTWD;
                                    if(balances[p].categoryBreakdown[exp.category] !== undefined) balances[p].categoryBreakdown[exp.category] += shareJPY;
                                }
                            });
                        }
                    }
                });
                return Object.values(balances).map(m => { m.balance = Math.round(m.paid - m.share); m.balanceTWD = Math.round(m.paidTWD - m.shareTWD); return m; });
            });

            const selectedMemberData = computed(() => balanceSheet.value.find(m => m.name === selectedMemberName.value));
            
            const getPieChartGradient = (memberData) => {
                if (!memberData || !memberData.categoryBreakdown) return 'conic-gradient(#ddd 0% 100%)';
                const total = memberData.share || 1;
                let currentAngle = 0;
                const gradientParts = [];
                Object.entries(memberData.categoryBreakdown).forEach(([cat, amount]) => {
                    if (amount > 0) {
                        const percentage = (amount / total) * 100;
                        const color = CATEGORY_HEX[cat] || '#ccc';
                        const start = currentAngle;
                        const end = currentAngle + percentage;
                        gradientParts.push(`${color} ${start}% ${end}%`);
                        currentAngle = end;
                    }
                });
                if (gradientParts.length === 0) return 'conic-gradient(#f0f0f0 0% 100%)';
                return `conic-gradient(${gradientParts.join(', ')})`;
            };
            
            const getPaymentPieChartGradient = (memberData) => {
                if (!memberData || (memberData.paidCash === 0 && memberData.paidCard === 0)) return 'conic-gradient(#ddd 0% 100%)';
                const total = memberData.paidCash + memberData.paidCard;
                const cashPercent = (memberData.paidCash / total) * 100;
                // Cash: m-rust (#976666), Card: m-charcoal (#7A848D)
                return `conic-gradient(#976666 0% ${cashPercent}%, #7A848D ${cashPercent}% 100%)`;
            };

            const settlements = computed(() => {
                let debts = balanceSheet.value.filter(m => m.balance < -10).map(m => ({...m}));
                let credits = balanceSheet.value.filter(m => m.balance > 10).map(m => ({...m}));
                debts.sort((a, b) => a.balance - b.balance); credits.sort((a, b) => b.balance - a.balance);
                const result = []; let i = 0, j = 0;
                while(i < debts.length && j < credits.length) {
                    let debtor = debts[i], creditor = credits[j];
                    let amount = Math.min(Math.abs(debtor.balance), creditor.balance);
                    if(amount > 0) {
                        const amountTWD = amount * exchangeRate.value; 
                        result.push({ from: debtor.name, to: creditor.name, amount: Math.round(amount), amountTWD: Math.round(amountTWD) });
                    }
                    debtor.balance += amount; creditor.balance -= amount;
                    if(Math.abs(debtor.balance) < 10) i++; if(Math.abs(creditor.balance) < 10) j++;
                }
                return result;
            });

            const syncStatusClass = computed(() => { if(statusMessage.value === '儲存中...') return 'busy'; if(isConnected.value) return 'online'; return ''; });
            let debounceTimer = null;
            const triggerSync = () => { if (isRemoteUpdate.value) return; statusMessage.value = '儲存中...'; clearTimeout(debounceTimer); debounceTimer = setTimeout(syncData, 1500); };

            const syncData = () => {
                if (!db) return;
                setDoc(doc(db, "trips", "hokkaido_final_v2"), { // Force New Doc ID
                    shoppingList: shoppingList.value,
                    expenses: expenses.value,
                    itineraryData: JSON.stringify(itineraryData.value),
                    mustBuyList: mustBuyList.value,
                    exchangeRate: exchangeRate.value,
                    lastUpdated: new Date()
                }).then(() => { statusMessage.value = '已同步'; isConnected.value = true; }).catch(err => { statusMessage.value = '同步失敗'; });
            };

            watch([shoppingList, expenses, itineraryData, mustBuyList, exchangeRate], () => { if (isRemoteUpdate.value) return; triggerSync(); }, { deep: true });

            onMounted(() => {
                if (db) {
                    onSnapshot(doc(db, "trips", "hokkaido_final_v2"), (doc) => {
                        if (doc.exists()) {
                            isRemoteUpdate.value = true; const data = doc.data();
                            if(data.shoppingList) shoppingList.value = data.shoppingList;
                            if(data.expenses) expenses.value = data.expenses;
                            if(data.itineraryData) { try { itineraryData.value = typeof data.itineraryData === 'string' ? JSON.parse(data.itineraryData) : data.itineraryData; } catch(e) {} }
                            if(data.mustBuyList) mustBuyList.value = data.mustBuyList;
                            if(data.exchangeRate) exchangeRate.value = data.exchangeRate;
                            isConnected.value = true; statusMessage.value = '連線正常';
                            nextTick(() => { isRemoteUpdate.value = false; });
                        } else { syncData(); }
                        initSortable();
                    });
                }
            });

            const initSortable = () => {
                const el = document.getElementById('itinerary-list');
                if (el) {
                    Sortable.create(el, {
                        handle: '.drag-handle',
                        animation: 150,
                        onEnd: (evt) => {
                            const list = itineraryData.value[selectedDateIndex.value];
                            const item = list.splice(evt.oldIndex, 1)[0];
                            list.splice(evt.newIndex, 0, item);
                            triggerSync();
                        }
                    });
                }
            };
            
            watch(selectedDateIndex, () => { nextTick(() => { initSortable(); }); });

            const formatNumber = (num) => num ? num.toLocaleString() : '0';
            
            const getCategoryColor = (cat) => CATEGORY_MAP[cat]?.color || 'bg-m-gray';
            const getCategoryIcon = (cat) => CATEGORY_MAP[cat]?.icon || 'fa-solid fa-circle';
            const getShoppingCategoryColor = (id) => shoppingCategories.find(c => c.id === id)?.color || 'bg-m-slate';
            const getShoppingCategoryIcon = (id) => shoppingCategories.find(c => c.id === id)?.icon || 'fa-solid fa-bag-shopping';
            const getShoppingCategoryName = (id) => shoppingCategories.find(c => c.id === id)?.name || '其他';
            const getWeatherIcon = (w) => w === 'snow' ? 'fa-solid fa-snowflake' : (w === 'sunny' ? 'fa-solid fa-sun' : 'fa-solid fa-cloud');
            const openMap = (q) => window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(q)}`, '_blank');
            const handleAddClick = () => {
                if (currentTab.value === 'itinerary') { isEditMode.value = false; newItinerary.value = { category: 'sightseeing' }; showItineraryModal.value = true; }
                else if (currentTab.value === 'shopping') { newShoppingItem.value = { name: '', qty: 1, category: 'souvenir', buyer: members.value[0] }; showShoppingModal.value = true; }
                else if (currentTab.value === 'expenses') { 
                    newExpense.value = { 
                        type: 'expense', 
                        category: 'food', payment: 'cash', date: '2026-03-06', 
                        payer: members.value[0], payee: members.value[1], involved: [...members.value], 
                        amount: null, amountTWD: null, name: '', customRate: exchangeRate.value 
                    }; 
                    showExpenseModal.value = true; 
                    isExpenseEditMode.value = false; // Ensure Add mode
                    editingExpenseIndex.value = null;
                }
            };
            const toggleSelectAll = () => newExpense.value.involved = newExpense.value.involved.length === members.value.length ? [] : [...members.value];
            const saveItineraryItem = () => {
                if(!newItinerary.value.name) return;
                const newItem = { 
                    ...newItinerary.value, 
                    isNoteExpanded: false
                };
                // Make sure ID exists
                if(!newItem.id) newItem.id = Date.now();
                
                if(isEditMode.value) {
                    const idx = currentItinerary.value.findIndex(i => i.id === newItem.id);
                    if(idx !== -1) currentItinerary.value[idx] = newItem;
                } else {
                    if(!itineraryData.value[selectedDateIndex.value]) itineraryData.value[selectedDateIndex.value] = [];
                    itineraryData.value[selectedDateIndex.value].push(newItem);
                }
                showItineraryModal.value = false; triggerSync();
            };
            const removeItineraryItem = () => {
                // Remove the currently editing item
                const idx = currentItinerary.value.findIndex(i => i.id === newItinerary.value.id);
                if(idx !== -1) {
                    if(confirm("確定要刪除此行程嗎？")) {
                        currentItinerary.value.splice(idx, 1);
                        showItineraryModal.value = false;
                        triggerSync();
                    }
                }
            };
            
            // Function to delete from card directly
            const removeItineraryItemCard = (id) => {
                if(confirm("確定要刪除此行程嗎？")) {
                    const idx = currentItinerary.value.findIndex(i => i.id === id);
                    if (idx !== -1) {
                        currentItinerary.value.splice(idx, 1);
                        triggerSync();
                    }
                }
            };
            
            const editItem = (item) => { isEditMode.value = true; newItinerary.value = { ...item }; showItineraryModal.value = true; };
            const addShoppingItem = () => { if(newShoppingItem.value.name) shoppingList.value.push({ ...newShoppingItem.value, checked: false }); showShoppingModal.value = false; triggerSync(); };
            const removeShoppingItem = (idx) => { shoppingList.value.splice(idx, 1); triggerSync(); };
            const resetShoppingForm = () => { newShoppingItem.value = { name: '', qty: 1, category: 'souvenir', buyer: members.value[0] }; };
            
            // Expense Edit Functions
            const editExpense = (exp, idx) => {
                isExpenseEditMode.value = true;
                editingExpenseIndex.value = idx;
                newExpense.value = JSON.parse(JSON.stringify(exp)); // Deep copy
                // Ensure number types
                newExpense.value.amount = Number(newExpense.value.amount);
                if(newExpense.value.amountTWD) newExpense.value.amountTWD = Number(newExpense.value.amountTWD);
                if(newExpense.value.customRate) newExpense.value.customRate = Number(newExpense.value.customRate);
                showExpenseModal.value = true;
            };

            const saveExpense = () => {
                if (!newExpense.value.amount) return;

                const expenseData = {
                    ...newExpense.value,
                    // Re-construct name based on type if needed, or allow manual edit
                    // For transfer, auto-generate name to keep format
                    name: newExpense.value.type === 'transfer' 
                          ? `轉帳: ${newExpense.value.payer} ➔ ${newExpense.value.payee}` 
                          : newExpense.value.name,
                    involved: newExpense.value.type === 'transfer' 
                              ? [newExpense.value.payee] 
                              : [...newExpense.value.involved]
                };

                if (isExpenseEditMode.value && editingExpenseIndex.value !== null) {
                    expenses.value[editingExpenseIndex.value] = expenseData;
                } else {
                    if (newExpense.value.type !== 'transfer' && !newExpense.value.name) return;
                    expenses.value.push(expenseData);
                }

                showExpenseModal.value = false;
                triggerSync();
                isExpenseEditMode.value = false;
                editingExpenseIndex.value = null;
            };
            
            const addExpense = () => { saveExpense(); }; // Alias for backward compatibility in template binding
            
            const removeExpense = (idx) => { expenses.value.splice(idx, 1); triggerSync(); };
            const addRegion = () => { if (newRegionName.value) { mustBuyList.value.push({ area: newRegionName.value, items: [] }); newRegionName.value = ''; triggerSync(); }};
            const removeRegion = (idx) => { mustBuyList.value.splice(idx, 1); triggerSync(); };
            const addMustBuyItem = (rIdx, event) => { const val = event.target.value.trim(); if (val) { mustBuyList.value[rIdx].items.push(val); event.target.value = ''; triggerSync(); }};
            const removeMustBuyItem = (rIdx, iIdx) => { mustBuyList.value[rIdx].items.splice(iIdx, 1); triggerSync(); };
            
            // Initial Data Population based on User Request
            const populateInitialData = () => {
                const initialItineraryData = [
    [
        { id: 1, category: 'flight', startTime: '02:50', name: 'TPE >> CTS (VZ570)', note: '07:30 抵達新千歲', isNoteExpanded: false },
        { id: 2, category: 'transport', startTime: '08:45', name: '機場接駁包車出發', note: '前往星野度假村', travelTime: '15分鐘', isNoteExpanded: false },
        { id: 3, category: 'sightseeing', startTime: '09:00', name: '霧冰平台', note: '搭乘雲海纜車 (¥2,500)\n推薦前往 KUMO Cafe 品嚐雲朵冰淇淋', isNoteExpanded: false },
        { id: 4, category: 'sightseeing', startTime: '13:00', name: 'Tomamu Snow Kart (雪地卡丁車)', note: '費用：¥3,500\n⚠️ 需於 12/1 09:00 (日本時間) 開放時搶先預約', isNoteExpanded: false },
        { id: 5, category: 'accommodation', startTime: '15:00', name: '星野リゾート トマム The Tower', note: 'Check-in (退房 11:00)', isNoteExpanded: false },
        { id: 6, category: 'food', startTime: '17:00', name: 'Forest Restaurant 森林餐廳', note: '自助餐 (費用：¥5,500)\n營業時間：17:00-20:30', isNoteExpanded: false },
        { id: 7, category: 'sightseeing', startTime: '19:00', name: '愛絲冰城 (Ice Village)', note: '入場費：¥600 (最後入場 21:30)\n開放至 22:00', isNoteExpanded: false }
    ],
    [
        { id: 8, category: 'food', startTime: '08:00', name: '飯店早餐', note: '', isNoteExpanded: false },
        { id: 9, category: 'transport', startTime: '08:45', name: '包車出發', note: '', travelTime: '2小時', isNoteExpanded: false },
        { id: 10, category: 'sightseeing', startTime: '11:30', name: '定山溪泛舟', note: '集合點：札幌市南区定山渓温泉西４丁目371-4\n12:00活動開始，約2小時\n費用：¥9,500', address: '札幌市南区定山渓温泉西４丁目371-4', isNoteExpanded: false },
        { id: 11, category: 'accommodation', startTime: '14:00', name: 'Vessel Inn Sapporo Nakajima Park', note: 'Check-in (退房 11:00)', isNoteExpanded: false },
        { id: 12, category: 'food', startTime: '18:00', name: '成吉思汗烤羊肉', note: '札幌必吃特色料理', isNoteExpanded: false }
    ],
    [
        { id: 13, category: 'food', startTime: '08:00', name: '飯店早餐', note: '', isNoteExpanded: false },
        { id: 14, category: 'transport', startTime: '08:30', name: '包車出發', note: '札幌 > 登別 > 洞爺湖 > 函館', travelTime: '2小時', isNoteExpanded: false },
        { id: 15, category: 'sightseeing', startTime: '10:30', name: '登別地獄谷', note: '地獄谷散策', isNoteExpanded: false },
        { id: 16, category: 'sightseeing', startTime: '13:00', name: '洞爺湖', note: '昭和新山、湖畔展望台', isNoteExpanded: false },
        { id: 17, category: 'accommodation', startTime: '15:00', name: 'OMO5 函館 by 星野集團', note: 'Check-in (退房 11:00)\n地址：北海道函館市若松町24番1', address: '北海道函館市若松町24番1', isNoteExpanded: false },
        { id: 18, category: 'food', startTime: '19:00', name: '晚餐', note: '函館市區或飯店周邊', isNoteExpanded: false }
    ],
    [
        { id: 19, category: 'food', startTime: '07:00', name: '函館朝市', note: '建議 07:00 前抵達\n體驗釣烏賊與品嚐海鮮丼', isNoteExpanded: false },
        { id: 20, category: 'sightseeing', startTime: '10:00', name: '五稜郭公園＋五稜郭塔', note: '搭市電約30分鐘，俯瞰星形堡壘', isNoteExpanded: false },
        { id: 21, category: 'shopping', startTime: '13:00', name: '金森紅磚倉庫', note: '港灣散步、購物、下午茶', isNoteExpanded: false },
        { id: 22, category: 'sightseeing', startTime: '15:00', name: '元町教會群、八幡坂', note: '拍攝著名的坡道海景與教堂群', isNoteExpanded: false },
        { id: 23, category: 'sightseeing', startTime: '18:00', name: '函館山夜景', note: '搭乘纜車欣賞百萬夜景\n(可利用飯店免費接駁巴士)', isNoteExpanded: false },
        { id: 24, category: 'food', startTime: '20:00', name: '晚餐', note: '小丑漢堡 (Lucky Pierrot) 或 鹽味拉麵', isNoteExpanded: false }
    ],
    [
        { id: 25, category: 'food', startTime: '08:00', name: '飯店早餐', note: '', isNoteExpanded: false },
        { id: 26, category: 'transport', startTime: '09:00', name: 'JR 特急北斗號', note: '函館 > 札幌 (車程約4小時)\n費用：約 ¥9,440', travelTime: '4小時', isNoteExpanded: false },
        { id: 27, category: 'accommodation', startTime: '15:00', name: 'The Royal Park Canvas 札幌大通公園', note: 'Check-in (退房 11:00)\n地址：札幌市中央区大通西1-12\n抵達後於大通公園周邊活動', address: '札幌市中央区大通西1-12', isNoteExpanded: false }
    ],
    [
        { id: 28, category: 'food', startTime: '09:00', name: '早餐', note: '飯店早餐或自行覓食', isNoteExpanded: false },
        { id: 29, category: 'transport', startTime: '10:00', name: 'JR 快速 Airport 號', note: '往返小樽 (約35分)', travelTime: '35分鐘', isNoteExpanded: false },
        { id: 30, category: 'food', startTime: '11:00', name: '三角市場', note: '出站即達，早午餐好選擇 (帝王蟹/海鮮丼)', isNoteExpanded: false },
        { id: 31, category: 'sightseeing', startTime: '12:30', name: '小樽運河', note: '淺草橋拍照、運河倉庫群', isNoteExpanded: false },
        { id: 32, category: 'shopping', startTime: '13:30', name: '堺町通商店街', note: '甜點：六花亭、北菓樓(妖精之森年輪蛋糕)、LeTAO\n工藝：北一哨子館、小樽音樂盒堂', isNoteExpanded: false },
        { id: 33, category: 'food', startTime: '18:00', name: '晚餐', note: '若雞時代 (Naruto) 炸半雞定食 或 小樽壽司通', isNoteExpanded: false }
    ],
    [
        { id: 34, category: 'food', startTime: '07:00', name: '早餐', note: '建議提前準備簡易早餐', isNoteExpanded: false },
        { id: 35, category: 'transport', startTime: '07:40', name: '集合：大通地鐵站 31 號門', note: '一日遊觀光巴士\n集合點：Statue of Hope 希望之像', travelTime: '2.5小時', isNoteExpanded: false },
        { id: 36, category: 'sightseeing', startTime: '10:30', name: '旭山動物園', note: '企鵝散步為冬季限定，視融雪狀況而定', isNoteExpanded: false },
        { id: 37, category: 'food', startTime: '20:00', name: '晚餐', note: '回到札幌約 20:00\n建議吃 湯咖哩 (Suage+/GARAKU) 或 拉麵共和國', isNoteExpanded: false }
    ],
    [
        { id: 38, category: 'food', startTime: '08:00', name: '飯店早餐', note: '', isNoteExpanded: false },
        { id: 39, category: 'sightseeing', startTime: '09:30', name: '北海道神宮', note: '參拜與購買特色御守\n品嚐六花亭神宮店限定判官餅', isNoteExpanded: false },
        { id: 40, category: 'food', startTime: '12:00', name: '二條市場', note: '午餐享用新鮮海膽、哈密瓜', isNoteExpanded: false },
        { id: 41, category: 'shopping', startTime: '14:00', name: '【騎士組】Ricoland 札幌白石店', note: '北海道最大重機用品店 (建議搭計程車前往)', isNoteExpanded: false },
        { id: 42, category: 'shopping', startTime: '14:00', name: '【購物組】狸小路 / 大丸百貨', note: '藥妝、電器、精品採購', isNoteExpanded: false },
        { id: 43, category: 'food', startTime: '19:00', name: '歡送會晚餐', note: '三大蟹吃到飽 (如：難陀) 或 頂級和牛壽喜燒', isNoteExpanded: false }
    ],
    [
        { id: 44, category: 'food', startTime: '08:00', name: '飯店早餐', note: '', isNoteExpanded: false },
        { id: 45, category: 'transport', startTime: '10:00', name: '前往新千歲機場', note: '', travelTime: '1小時', isNoteExpanded: false },
        { id: 46, category: 'shopping', startTime: '11:00', name: '國內線航廈 2F', note: '採買伴手禮 (Royce、白色戀人、六花亭等)\n最後美食衝刺', isNoteExpanded: false },
        { id: 47, category: 'flight', startTime: '14:40', name: 'CTS >> TPE (CI131)', note: '平安返國', isNoteExpanded: false }
    ]
];

                return initialItineraryData;
            };
            
            // Load initial data
            itineraryData.value = populateInitialData();

            return {
                currentTab, dates, selectedDateIndex, hotels, mustBuyList, shoppingList, expenses, members, shoppingCategories,
                itineraryData, currentItinerary, totalExpensesJPY, totalExpensesTWD, balanceSheet, settlements, selectedMemberName, selectedMemberData, inboundFlights,
                // currencyInput is removed
                formatNumber, exchangeRate,
                getCategoryColor, getCategoryIcon, getWeatherIcon, openMap,
                getShoppingCategoryColor, getShoppingCategoryIcon, getShoppingCategoryName, getPieChartGradient, getPaymentPieChartGradient,
                showItineraryModal, showShoppingModal, showExpenseModal, isEditMode, isMustBuyEditMode, newRegionName,
                newItinerary, newShoppingItem, newExpense, CATEGORY_HEX, CATEGORY_MAP_NAME,
                handleAddClick, saveItineraryItem, editItem, removeItineraryItem, removeItineraryItemCard,
                addShoppingItem, removeShoppingItem, addExpense, removeExpense, saveExpense, editExpense,
                toggleSelectAll, addRegion, removeRegion, addMustBuyItem, removeMustBuyItem,
                triggerSync, syncData, isConnected, statusMessage, syncStatusClass,
                resetShoppingForm, onJPYInput, onTWDInput, onRateInput,
                calculateTWD, calculateJPY, onExchangeRateChange,
                calcJPY, calcTWD, filterMember, filterCategory, filteredExpenses, // Add filteredExpenses, filterMember, filterCategory
                isExpenseEditMode, editingExpenseIndex
            }
        }
    }).mount('#app');
</script>
</body>
</html>
