<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hokkaido Trip 2026</title>
    
    <!-- Tab Icon -->
    <link rel="icon" type="image/jpeg" href="./image_ec3041.jpg">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Vue.js 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'snow-white': '#F0FFFF',        // 雪白色
                        'ice-blue': '#B3E5FC',          // 冰川藍
                        'light-snow-blue': '#E5F3F7',   // 頁面底色
                        'deep-sea-blue': '#01579B',     // 深海藍 (強調)
                        'accent-yellow': '#FFD54F',     // 溫暖黃 (按鈕)
                        'soft-gray': '#F5F5F5',         // 背景灰
                        'jp-sage': '#A9B7AA',           // 日系鼠尾草綠 (輔助)
                        'warm-orange': '#FF8A65'        // 暖橘色 (分帳用)
                    }
                }
            }
        }
    </script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        body {
            background-color: #E5F3F7; 
            -webkit-tap-highlight-color: transparent;
            font-family: 'Noto Sans TC', sans-serif;
            color: #334155;
        }

        .app-container {
            max-width: 480px;
            margin: 0 auto;
            min-height: 100vh;
            background-color: #ffffff; 
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.05);
            position: relative;
            padding-bottom: 90px;
        }

        /* 頁首設計 */
        .header-bg {
            background-color: #ffffff; 
            padding: 0; 
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15); 
            border-bottom-left-radius: 35px; 
            border-bottom-right-radius: 35px;
            z-index: 10; 
            height: 280px;
        }
        
        .header-image-container {
            width: 100%;
            height: 100%; 
            position: relative;
        }
        
        .header-image-container img {
            width: 100%;
            height: 100%;
            object-fit: cover; 
            object-position: center bottom;
        }
        
        /* 雪花特效 */
        .snow-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><circle cx="50" cy="50" r="1" fill="%23fff" opacity="0.8"/><circle cx="20" cy="80" r="0.5" fill="%23fff" opacity="0.6"/><circle cx="70" cy="30" r="1.5" fill="%23fff" opacity="0.9"/></svg>');
            background-size: 100px 100px;
            opacity: 0.8;
            animation: snowfall 10s linear infinite;
            z-index: 5;
            pointer-events: none;
        }

        @keyframes snowfall {
            to { background-position: 100px 100px; }
        }
        
        /* 懸浮 Tab 按鈕 */
        .side-tab-bar {
            position: absolute;
            bottom: 20px; 
            right: 20px;
            z-index: 30; 
            display: flex;
            gap: 10px; 
        }
        
        .tab-button {
            width: 45px; 
            height: 45px;
            border-radius: 50%; 
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem; 
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2); 
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            background-color: rgba(255, 255, 255, 0.9);
            color: #90A4AE;
            border: 2px solid white;
        }
        
        .tab-button.active {
            background-color: #01579B; 
            color: #ffffff;
            transform: scale(1.15) translateY(-5px);
            box-shadow: 0 8px 20px rgba(1, 87, 155, 0.4); 
            border-color: #01579B;
        }

        /* 主內容區 */
        .app-main {
            padding-top: 20px; 
            position: relative;
            z-index: 5;
        }
        
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .card-shadow {
            box-shadow: 0 4px 20px rgba(179, 229, 252, 0.25);
            transition: transform 0.2s ease;
        }

        .animate-fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* 備註展開 */
        .note-content {
            max-height: 2.5rem;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        .note-content.expanded { max-height: 500px; }

        /* 日期選擇器 */
        .date-selector-sticky {
            background-color: rgba(255,255,255,0.95);
            backdrop-filter: blur(5px);
            border-bottom: 1px solid #f0f0f0; 
            z-index: 20; 
            top: 0; 
            padding-top: 10px;
            padding-bottom: 10px;
        }

        /* Banner 文字遮罩 */
        .banner-text-overlay {
            background: linear-gradient(to top, rgba(0,0,0,0.6) 0%, rgba(0,0,0,0) 100%);
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 50%;
            border-bottom-left-radius: 35px;
            border-bottom-right-radius: 35px;
            pointer-events: none;
        }
    </style>
</head>
<body>

<div id="app" class="app-container">

    <!-- Header 區域 -->
    <div class="header-bg">
        <div class="header-image-container">
            <!-- 使用您的圖片 -->
            <img src="./banner.jpg"
                 onerror="this.src='https://images.unsplash.com/photo-1548578709-32269a838573?q=80&w=1920&auto=format&fit=crop'"
                 alt="北海道家族旅行">
            <div class="banner-text-overlay"></div>
            <div class="absolute bottom-6 left-6 text-white z-20">
                <h1 class="text-3xl font-bold tracking-widest drop-shadow-md">HOKKAIDO</h1>
                <p class="text-sm font-light tracking-wider opacity-90">2026.03.06 - 03.14</p>
            </div>
        </div>
        
        <div class="snow-layer"></div> 
        
        <!-- 懸浮 Tab 按鈕 -->
        <div class="side-tab-bar">
            <button @click="currentTab = 'itinerary'" :class="{'active': currentTab === 'itinerary'}" class="tab-button">
                <i class="fa-solid fa-map-location-dot"></i>
            </button>
            <button @click="currentTab = 'info'" :class="{'active': currentTab === 'info'}" class="tab-button">
                <i class="fa-solid fa-circle-info"></i>
            </button>
            <button @click="currentTab = 'shopping'" :class="{'active': currentTab === 'shopping'}" class="tab-button">
                <i class="fa-solid fa-basket-shopping"></i>
            </button>
            <button @click="currentTab = 'expenses'" :class="{'active': currentTab === 'expenses'}" class="tab-button">
                <i class="fa-solid fa-coins"></i>
            </button>
        </div>
    </div>

    <!-- 主要內容 -->
    <main class="p-4 app-main">
        
        <!-- Tab 1: 行程 -->
        <div v-if="currentTab === 'itinerary'" class="animate-fade-in">
            <!-- 日期選擇器 -->
            <div class="flex overflow-x-auto hide-scrollbar space-x-3 mb-4 snap-x px-1 sticky date-selector-sticky -mx-4 px-4 pb-2">
                <div v-for="(day, index) in dates" :key="index" 
                     @click="selectedDateIndex = index"
                     class="snap-center flex-shrink-0 w-[60px] h-[70px] rounded-2xl flex flex-col items-center justify-center cursor-pointer transition-all duration-300 border-2 shadow-sm"
                     :class="selectedDateIndex === index ? 'bg-deep-sea-blue text-white border-deep-sea-blue shadow-lg scale-105' : 'bg-white text-slate-400 border-transparent hover:bg-soft-gray'">
                    <span class="text-sm font-bold uppercase">{{ day.weekday }}</span> 
                    <span class="text-xs font-medium opacity-80">{{ day.date }}</span> 
                </div>
            </div>

            <!-- 天氣與交通摘要 -->
            <div class="mb-5 bg-snow-white border border-ice-blue rounded-2xl p-4 flex justify-between items-center shadow-sm">
                <div class="flex items-center text-deep-sea-blue gap-3">
                    <i :class="getWeatherIcon(dates[selectedDateIndex].weather)" class="text-4xl text-blue-400"></i>
                    <div>
                        <div class="text-2xl font-bold">{{ dates[selectedDateIndex].temp }}</div>
                        <div class="text-xs text-slate-500">{{ dates[selectedDateIndex].area }}</div>
                    </div>
                </div>
                <div class="text-right">
                    <span v-if="dates[selectedDateIndex].transport" class="inline-block bg-white text-deep-sea-blue text-xs font-bold px-3 py-1.5 rounded-full shadow-sm border border-ice-blue">
                        <i class="fa-solid fa-van-shuttle mr-1 text-accent-yellow"></i> {{ dates[selectedDateIndex].transport }}
                    </span>
                </div>
            </div>

            <!-- 行程列表 -->
            <div class="space-y-4 pb-20">
                <div v-for="(item, idx) in currentItinerary" :key="item.id" class="relative pl-4">
                    <!-- 連接線 -->
                    <div v-if="idx < currentItinerary.length - 1" class="absolute left-[23px] top-8 bottom-[-16px] w-0.5 bg-slate-200 z-0"></div>
                    
                    <div class="bg-white rounded-2xl p-4 card-shadow relative z-10 border border-slate-50">
                        <div class="flex items-start gap-3">
                            <div class="flex flex-col items-center min-w-[50px]">
                                <div class="w-10 h-10 rounded-full flex items-center justify-center text-white shadow-md text-sm mb-1" :class="getCategoryColor(item.category)">
                                    <i :class="getCategoryIcon(item.category)"></i>
                                </div>
                                <span class="text-xs font-bold text-slate-500">{{ item.startTime }}</span>
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="flex justify-between items-start">
                                    <h3 class="font-bold text-slate-800 text-lg leading-tight truncate pr-2">{{ item.name }}</h3>
                                    <div class="flex gap-2 shrink-0">
                                        <button @click.stop="openMap(item.address || item.name)" class="w-7 h-7 bg-ice-blue/30 text-deep-sea-blue rounded-full flex items-center justify-center text-xs hover:bg-deep-sea-blue hover:text-white transition-colors">
                                            <i class="fa-solid fa-location-arrow"></i>
                                        </button>
                                        <button @click.stop="editItem(item)" class="w-7 h-7 bg-slate-100 text-slate-400 rounded-full flex items-center justify-center text-xs hover:bg-slate-200">
                                            <i class="fa-solid fa-pencil"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="text-sm text-slate-500 mt-2 space-y-1">
                                    <p v-if="item.price" class="flex items-center"><i class="fa-solid fa-ticket w-4 text-center mr-1 text-ice-blue"></i> {{ item.price }}</p>
                                    <p v-if="item.address" class="flex items-center truncate"><i class="fa-solid fa-map-pin w-4 text-center mr-1 text-ice-blue"></i> {{ item.address }}</p>
                                </div>
                                <div v-if="item.note" class="mt-3 bg-slate-50 p-2.5 rounded-xl border border-slate-100 text-xs text-slate-600">
                                    <div class="note-content" :class="{'expanded': item.isNoteExpanded}">{{ item.note }}</div>
                                    <button v-if="item.note.length > 40" @click="item.isNoteExpanded = !item.isNoteExpanded" class="text-deep-sea-blue font-bold mt-1">
                                        {{ item.isNoteExpanded ? '收合' : '展開...' }}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div v-if="currentItinerary.length === 0" class="text-center py-10 text-slate-300">
                    <p>本日暫無行程，點擊右下角 + 新增</p>
                </div>
            </div>
        </div>

        <!-- Tab 2: 資訊 -->
        <div v-if="currentTab === 'info'" class="animate-fade-in space-y-5 pb-20">
            <!-- 匯率計算 (已更新：可編輯匯率) -->
            <div class="bg-gradient-to-br from-deep-sea-blue to-cyan-700 rounded-3xl p-6 text-white shadow-xl relative overflow-hidden">
                <div class="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full -mr-10 -mt-10 blur-2xl"></div>
                
                <div class="flex justify-between items-center mb-4 relative z-10">
                    <h3 class="font-bold flex items-center"><i class="fa-solid fa-calculator mr-2"></i> 匯率換算</h3>
                    <!-- 匯率編輯區 -->
                    <div class="flex items-center bg-white/20 rounded-lg px-2 py-1">
                        <span class="text-xs text-cyan-200 mr-1">匯率:</span>
                        <input type="number" v-model="exchangeRate" @input="calculateCurrency" step="0.001" class="w-12 bg-transparent text-white font-bold text-sm text-right focus:outline-none border-b border-white/30 focus:border-white">
                    </div>
                </div>

                <div class="flex items-center justify-between gap-4 relative z-10">
                    <div class="flex-1">
                        <label class="text-[10px] text-cyan-200 block mb-1">JPY</label>
                        <input type="number" v-model="currencyInput" @input="calculateCurrency" class="w-full bg-white/20 border border-white/30 rounded-xl px-3 py-2 text-white font-bold text-lg focus:outline-none">
                    </div>
                    <i class="fa-solid fa-arrow-right-arrow-left text-cyan-300 mt-4"></i>
                    <div class="flex-1">
                        <label class="text-[10px] text-cyan-200 block mb-1">TWD</label>
                        <div class="w-full bg-white/10 rounded-xl px-3 py-2 text-white text-lg font-bold border border-transparent">
                            {{ currencyResult }}
                        </div>
                    </div>
                </div>
            </div>

            <!-- 住宿資訊 -->
            <div class="bg-white rounded-3xl p-6 card-shadow">
                <h3 class="font-bold text-slate-800 mb-4 border-b border-slate-100 pb-2"><i class="fa-solid fa-hotel text-purple-500 mr-2"></i> 住宿清單</h3>
                <ul class="space-y-4">
                    <li v-for="hotel in hotels" class="group">
                        <div class="flex justify-between items-start">
                            <div>
                                <span class="font-bold text-slate-700 block">{{ hotel.name }}</span>
                                <span class="text-xs bg-purple-50 text-purple-600 px-2 py-0.5 rounded-md mt-1 inline-block">{{ hotel.date }}</span>
                            </div>
                            <button @click="openMap(hotel.name)" class="w-8 h-8 rounded-full bg-purple-50 text-purple-500 flex items-center justify-center hover:bg-purple-500 hover:text-white transition-colors">
                                <i class="fa-solid fa-location-arrow text-xs"></i>
                            </button>
                        </div>
                        <p class="text-xs text-slate-400 mt-1"><i class="fa-solid fa-map-pin mr-1"></i> {{ hotel.address }}</p>
                    </li>
                </ul>
            </div>

            <!-- 必買清單 -->
            <div class="bg-white rounded-3xl p-6 card-shadow">
                <h3 class="font-bold text-slate-800 mb-4 border-b border-slate-100 pb-2"><i class="fa-solid fa-thumbs-up text-red-400 mr-2"></i> 必買推薦</h3>
                <div v-for="region in mustBuyList" :key="region.area" class="mb-4 last:mb-0">
                    <h4 class="font-bold text-sm text-slate-600 mb-2 flex items-center"><span class="w-1.5 h-4 bg-red-300 rounded-r mr-2"></span>{{ region.area }}</h4>
                    <div class="flex flex-wrap gap-2">
                        <span v-for="item in region.items" class="bg-slate-50 text-slate-600 text-xs px-3 py-1.5 rounded-lg border border-slate-100">{{ item }}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab 3: 購物清單 -->
        <div v-if="currentTab === 'shopping'" class="animate-fade-in pb-20">
            <div class="grid grid-cols-2 gap-4">
                <div @click="showShoppingModal = true; resetShoppingForm()" class="bg-white border-2 border-dashed border-slate-200 rounded-2xl p-4 flex flex-col items-center justify-center text-slate-400 cursor-pointer min-h-[160px] hover:bg-slate-50 transition-colors">
                    <i class="fa-solid fa-plus text-3xl mb-2"></i>
                    <span class="text-xs font-bold">新增商品</span>
                </div>

                <div v-for="(item, idx) in shoppingList" :key="idx" class="bg-white rounded-2xl p-3 card-shadow relative group">
                    <div class="aspect-square bg-slate-50 rounded-xl mb-2 overflow-hidden relative border border-slate-100 flex items-center justify-center">
                        <img v-if="item.image" :src="item.image" class="w-full h-full object-cover">
                        <i v-else class="fa-solid fa-gift text-4xl text-slate-200"></i>
                        <button @click="removeShoppingItem(idx)" class="absolute top-2 right-2 bg-black/50 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition-opacity">
                            <i class="fa-solid fa-xmark"></i>
                        </button>
                    </div>
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="font-bold text-sm text-slate-800 truncate w-24">{{ item.name }}</p>
                            <p class="text-xs text-slate-400">x {{ item.qty }}</p>
                        </div>
                        <input type="checkbox" v-model="item.checked" class="w-5 h-5 accent-deep-sea-blue rounded border-slate-300">
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab 4: 花費 -->
        <div v-if="currentTab === 'expenses'" class="animate-fade-in pb-20">
            <div class="bg-gradient-to-r from-deep-sea-blue to-cyan-600 text-white rounded-3xl p-8 mb-6 relative overflow-hidden shadow-lg">
                <div class="absolute -right-10 -top-10 bg-white/10 w-48 h-48 rounded-full blur-3xl"></div>
                <p class="text-xs text-cyan-200 mb-1 relative z-10">預估總支出 (JPY)</p>
                <h2 class="text-4xl font-bold relative z-10 tracking-tight">¥ {{ formatNumber(totalExpensesJPY) }}</h2>
                <div class="flex justify-between items-end mt-2 relative z-10 opacity-80">
                    <span class="text-[10px] bg-white/20 px-2 py-0.5 rounded">匯率 {{ exchangeRate }}</span>
                    <p class="text-xs">約 NT$ {{ formatNumber(totalExpensesTWD) }}</p>
                </div>
            </div>

            <!-- 獨立的 AA 分帳小工具 -->
            <div class="bg-gradient-to-r from-warm-orange to-orange-400 text-white rounded-3xl p-5 mb-6 relative overflow-hidden shadow-md">
                <div class="absolute -left-10 -bottom-10 bg-white/10 w-32 h-32 rounded-full blur-2xl"></div>
                <h3 class="font-bold text-sm mb-3 flex items-center relative z-10"><i class="fa-solid fa-users mr-2"></i> 快速分帳計算機</h3>
                <div class="grid grid-cols-2 gap-4 relative z-10">
                    <div>
                        <label class="text-[10px] text-orange-100 block mb-1">總金額 (JPY)</label>
                        <input type="number" v-model.number="quickSplit.amount" class="w-full bg-white/20 border border-white/30 rounded-xl px-2 py-1.5 text-white font-bold text-sm focus:outline-none placeholder-white/50" placeholder="0">
                    </div>
                    <div>
                        <label class="text-[10px] text-orange-100 block mb-1">人數</label>
                        <div class="flex items-center">
                            <button @click="quickSplit.people > 1 ? quickSplit.people-- : null" class="w-6 h-6 bg-white/20 rounded-l-lg flex items-center justify-center text-xs hover:bg-white/30">-</button>
                            <input type="number" v-model.number="quickSplit.people" class="w-10 bg-white/20 border-y border-white/30 py-1 text-center text-white font-bold text-sm focus:outline-none">
                            <button @click="quickSplit.people++" class="w-6 h-6 bg-white/20 rounded-r-lg flex items-center justify-center text-xs hover:bg-white/30">+</button>
                        </div>
                    </div>
                </div>
                <div class="mt-3 pt-3 border-t border-white/20 flex justify-between items-center relative z-10">
                    <span class="text-xs text-orange-100">每人應付</span>
                    <span class="font-bold text-lg">¥ {{ formatNumber(Math.ceil((quickSplit.amount || 0) / quickSplit.people)) }}</span>
                </div>
            </div>

            <div class="bg-white rounded-t-3xl min-h-[400px] p-6 shadow-[0_-10px_40px_rgba(0,0,0,0.03)] -mx-4 px-8">
                <h3 class="font-bold text-slate-800 mb-5 flex items-center"><i class="fa-solid fa-receipt text-slate-300 mr-2"></i>支出紀錄</h3>
                <div v-if="expenses.length === 0" class="text-center text-slate-300 py-10">尚無紀錄</div>
                <div v-else class="space-y-4">
                    <div v-for="(exp, idx) in expenses" :key="idx" class="flex items-center justify-between border-b border-slate-50 pb-3 last:border-0">
                        <div class="flex items-center">
                            <div class="w-10 h-10 rounded-full flex items-center justify-center text-white text-xs mr-3 shadow-sm" :class="getCategoryColor(exp.category)">
                                <i :class="getCategoryIcon(exp.category)"></i>
                            </div>
                            <div>
                                <p class="font-bold text-slate-700 text-sm">{{ exp.name }}</p>
                                <p class="text-[10px] text-slate-400 uppercase">{{ exp.date }} · {{ exp.payment === 'card' ? '刷卡' : '現金' }}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="font-bold text-slate-700 text-sm">¥{{ formatNumber(exp.amount) }}</p>
                            <button @click="removeExpense(idx)" class="text-xs text-red-300 hover:text-red-500 mt-1">刪除</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- 浮動新增按鈕 (FAB) -->
    <button v-if="currentTab !== 'info'" @click="handleAddClick" class="fixed bottom-24 right-6 w-14 h-14 bg-accent-yellow rounded-full shadow-[0_4px_15px_rgba(255,213,79,0.6)] text-deep-sea-blue text-2xl flex items-center justify-center hover:scale-110 transition-transform z-40">
        <i class="fa-solid fa-plus"></i>
    </button>

    <!-- Modals -->
    <!-- 1. 新增行程 Modal -->
    <div v-if="showItineraryModal" class="fixed inset-0 bg-deep-sea-blue/40 z-50 flex items-center justify-center p-6 backdrop-blur-sm animate-fade-in">
        <div class="bg-white rounded-3xl w-full max-w-sm p-6 shadow-2xl max-h-[90vh] overflow-y-auto">
            <h3 class="font-bold text-lg mb-4 text-center text-slate-800">{{ isEditMode ? '編輯行程' : '新增行程' }}</h3>
            <div class="space-y-3">
                <select v-model="newItinerary.category" class="w-full bg-slate-50 rounded-xl p-3 text-sm outline-none">
                    <option value="sightseeing">景點</option>
                    <option value="food">飲食</option>
                    <option value="shopping">購物</option>
                    <option value="accommodation">住宿</option>
                    <option value="transport">交通</option>
                </select>
                <input v-model="newItinerary.name" placeholder="名稱" class="w-full bg-slate-50 rounded-xl p-3 text-sm outline-none focus:ring-2 focus:ring-deep-sea-blue">
                <input v-model="newItinerary.startTime" type="time" class="w-full bg-slate-50 rounded-xl p-3 text-sm outline-none">
                <input v-model="newItinerary.address" placeholder="地址 (導航用)" class="w-full bg-slate-50 rounded-xl p-3 text-sm outline-none">
                <input v-model="newItinerary.price" placeholder="費用 (選填)" class="w-full bg-slate-50 rounded-xl p-3 text-sm outline-none">
                <textarea v-model="newItinerary.note" placeholder="備註" rows="3" class="w-full bg-slate-50 rounded-xl p-3 text-sm outline-none"></textarea>
            </div>
            <div class="flex space-x-3 mt-6">
                <button @click="showItineraryModal = false" class="flex-1 py-3 rounded-xl bg-slate-100 text-slate-500 font-bold text-sm">取消</button>
                <button @click="saveItineraryItem" class="flex-1 py-3 rounded-xl bg-deep-sea-blue text-white font-bold text-sm shadow-md">{{ isEditMode ? '更新' : '新增' }}</button>
            </div>
        </div>
    </div>

    <!-- 2. 新增購物 Modal -->
    <div v-if="showShoppingModal" class="fixed inset-0 bg-deep-sea-blue/40 z-50 flex items-center justify-center p-6 backdrop-blur-sm animate-fade-in">
        <div class="bg-white rounded-3xl w-full max-w-sm p-6 shadow-2xl">
            <h3 class="font-bold text-lg mb-4 text-center">新增購物清單</h3>
            <input v-model="newShoppingItem.name" type="text" placeholder="商品名稱" class="w-full bg-slate-50 rounded-xl p-4 mb-4 text-sm focus:outline-none focus:ring-2 focus:ring-deep-sea-blue">
            <input v-model="newShoppingItem.qty" type="number" placeholder="數量" class="w-full bg-slate-50 rounded-xl p-4 mb-4 text-sm focus:outline-none">
            <div class="relative mb-6">
                <input type="file" @change="handleImageUpload" class="hidden" id="fileInput">
                <label for="fileInput" class="w-full h-32 bg-slate-50 border-2 border-dashed border-slate-200 rounded-xl flex items-center justify-center cursor-pointer text-slate-400 hover:bg-slate-100">
                    <span v-if="!newShoppingItem.image" class="flex flex-col items-center text-xs"><i class="fa-solid fa-camera text-2xl mb-2"></i> 上傳照片</span>
                    <img v-else :src="newShoppingItem.image" class="h-full w-full object-contain rounded-xl">
                </label>
            </div>
            <div class="flex space-x-3">
                <button @click="showShoppingModal = false" class="flex-1 py-3 rounded-xl bg-slate-100 text-slate-500 font-bold text-sm">取消</button>
                <button @click="addShoppingItem" class="flex-1 py-3 rounded-xl bg-deep-sea-blue text-white font-bold text-sm shadow-md">新增</button>
            </div>
        </div>
    </div>

    <!-- 3. 新增花費 Modal -->
    <div v-if="showExpenseModal" class="fixed inset-0 bg-deep-sea-blue/40 z-50 flex items-center justify-center p-6 backdrop-blur-sm animate-fade-in">
        <div class="bg-white rounded-3xl w-full max-w-sm p-6 shadow-2xl">
            <h3 class="font-bold text-lg mb-4 text-center text-slate-800">記一筆</h3>
            <div class="grid grid-cols-2 gap-3 mb-3">
                <input v-model="newExpense.date" type="date" class="bg-slate-50 rounded-xl p-3 text-sm outline-none">
                <select v-model="newExpense.category" class="bg-slate-50 rounded-xl p-3 text-sm outline-none">
                    <option value="food">飲食</option>
                    <option value="shopping">購物</option>
                    <option value="transport">交通</option>
                    <option value="stay">住宿</option>
                    <option value="ticket">門票</option>
                </select>
            </div>
            <input v-model="newExpense.name" placeholder="項目名稱" class="w-full bg-slate-50 rounded-xl p-4 mb-4 text-sm focus:outline-none">
            <div class="relative mb-4">
                <span class="absolute left-4 top-4 text-slate-400 font-bold">¥</span>
                <input v-model.number="newExpense.amount" type="number" placeholder="金額" class="w-full bg-slate-50 rounded-xl p-4 pl-8 text-sm focus:outline-none font-bold text-lg">
            </div>

            <!-- 分帳功能區塊 -->
            <div class="mb-4">
                <div class="flex justify-between items-center mb-2">
                    <label class="flex items-center text-sm font-bold text-slate-600 cursor-pointer">
                        <input type="checkbox" v-model="newExpense.isSplit" class="w-4 h-4 mr-2 accent-warm-orange rounded">
                        <i class="fa-solid fa-users-viewfinder mr-1 text-warm-orange"></i> AA 分帳試算
                    </label>
                </div>
                
                <div v-if="newExpense.isSplit" class="bg-orange-50 p-3 rounded-xl border border-orange-100 animate-fade-in">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-xs text-orange-800">人數</span>
                        <div class="flex items-center bg-white rounded-lg border border-orange-200">
                            <button @click="newExpense.splitPeople > 1 ? newExpense.splitPeople-- : null" class="w-8 h-8 flex items-center justify-center text-orange-400 hover:bg-orange-100 rounded-l-lg">-</button>
                            <input type="number" v-model.number="newExpense.splitPeople" class="w-10 text-center text-orange-800 font-bold text-sm focus:outline-none">
                            <button @click="newExpense.splitPeople++" class="w-8 h-8 flex items-center justify-center text-orange-400 hover:bg-orange-100 rounded-r-lg">+</button>
                        </div>
                    </div>
                    <div class="flex justify-between items-center border-t border-orange-200 pt-2 mt-1">
                        <span class="text-xs text-orange-800">每人應付</span>
                        <span class="font-bold text-lg text-orange-600">¥ {{ formatNumber(Math.ceil((newExpense.amount || 0) / newExpense.splitPeople)) }}</span>
                    </div>
                    <button @click="newExpense.amount = Math.ceil((newExpense.amount || 0) / newExpense.splitPeople); newExpense.isSplit = false" class="w-full mt-2 bg-white text-orange-500 text-xs py-1.5 rounded-lg border border-orange-200 hover:bg-orange-100">
                        只記我的份 (帶入此金額)
                    </button>
                </div>
            </div>

            <div class="flex space-x-3 mb-6">
                <button @click="newExpense.payment='cash'" :class="newExpense.payment==='cash' ? 'bg-deep-sea-blue text-white' : 'bg-slate-100 text-slate-500'" class="flex-1 py-2 rounded-xl text-sm transition-colors">現金</button>
                <button @click="newExpense.payment='card'" :class="newExpense.payment==='card' ? 'bg-deep-sea-blue text-white' : 'bg-slate-100 text-slate-500'" class="flex-1 py-2 rounded-xl text-sm transition-colors">信用卡</button>
            </div>
            <div class="flex space-x-3">
                <button @click="showExpenseModal = false" class="flex-1 py-3 rounded-xl bg-slate-100 text-slate-500 font-bold text-sm">取消</button>
                <button @click="addExpense" class="flex-1 py-3 rounded-xl bg-accent-yellow text-deep-sea-blue font-bold text-sm shadow-md">儲存</button>
            </div>
        </div>
    </div>

</div>

<script>
    const { createApp, ref, computed, onMounted } = Vue

    createApp({
        setup() {
            const currentTab = ref('itinerary');
            const selectedDateIndex = ref(0);
            
            // 匯率 (改為 ref 以便編輯)
            const exchangeRate = ref(0.22);
            const currencyInput = ref(50000);
            const currencyResult = ref(0);
            const calculateCurrency = () => currencyResult.value = Math.round(currencyInput.value * exchangeRate.value);

            // 快速分帳
            const quickSplit = ref({ amount: null, people: 2 });

            // Modals
            const showItineraryModal = ref(false);
            const showShoppingModal = ref(false);
            const showExpenseModal = ref(false);
            const isEditMode = ref(false);

            // 類別顏色設定
            const CATEGORY_MAP = {
                sightseeing: { color: 'bg-green-500', icon: 'fa-solid fa-camera' },
                food: { color: 'bg-red-400', icon: 'fa-solid fa-utensils' },
                shopping: { color: 'bg-orange-400', icon: 'fa-solid fa-bag-shopping' },
                accommodation: { color: 'bg-purple-500', icon: 'fa-solid fa-bed' },
                flight: { color: 'bg-blue-500', icon: 'fa-solid fa-plane' },
                transport: { color: 'bg-indigo-500', icon: 'fa-solid fa-van-shuttle' },
                ticket: { color: 'bg-cyan-500', icon: 'fa-solid fa-ticket' },
                stay: { color: 'bg-purple-500', icon: 'fa-solid fa-hotel' }
            };

            // 日期資料 (115/3/06 - 3/14)
            const dates = ref([
                { date: '3/06', weekday: '五', area: '星野', temp: '-2°C', weather: 'snow', transport: '包車' },
                { date: '3/07', weekday: '六', area: '定山溪/札幌', temp: '0°C', weather: 'cloudy', transport: '包車' },
                { date: '3/08', weekday: '日', area: '登別/函館', temp: '2°C', weather: 'sunny', transport: '包車' },
                { date: '3/09', weekday: '一', area: '函館', temp: '3°C', weather: 'sunny', transport: '市電' },
                { date: '3/10', weekday: '二', area: '函館/札幌', temp: '1°C', weather: 'cloudy', transport: 'JR' },
                { date: '3/11', weekday: '三', area: '小樽', temp: '-1°C', weather: 'snow', transport: 'JR' },
                { date: '3/12', weekday: '四', area: '旭山動物園', temp: '-5°C', weather: 'snow', transport: '巴士' },
                { date: '3/13', weekday: '五', area: '札幌', temp: '1°C', weather: 'cloudy', transport: '地鐵' },
                { date: '3/14', weekday: '六', area: '回程', temp: '2°C', weather: 'sunny', transport: '飛機' }
            ]);

            // 住宿清單
            const hotels = ref([
                { name: '星野リゾート トマム The Tower', date: '3/06', address: '北海道勇払郡占冠村中トマム' },
                { name: 'Vessel Inn 札幌中島公園', date: '3/07', address: '札幌市中央區南九條西4-1-2' },
                { name: 'OMO5 函館 by 星野集團', date: '3/08', address: '函館市若松町24番1' },
                { name: 'Royal Park Canvas 札幌大通公園', date: '3/10', address: '札幌市中央区大通西1-12' }
            ]);

            // 行程資料 (對應 dates 索引)
            const itineraryData = ref([
                // 3/06 (五)
                [
                    { id: 1, category: 'flight', startTime: '02:50', name: '桃機出發 (VZ570)', note: '07:30 抵達新千歲', isNoteExpanded: false },
                    { id: 2, category: 'transport', startTime: '08:45', name: '包車前往星野', note: '新千歲出發', isNoteExpanded: false },
                    { id: 3, category: 'sightseeing', startTime: '11:00', name: '霧冰平台 & KUMO Cafe', note: '纜車費用 ¥2500', isNoteExpanded: false },
                    { id: 4, category: 'sightseeing', startTime: '13:00', name: 'Snow Kart 雪上卡丁車', note: '預約連結: xxx', isNoteExpanded: false },
                    { id: 5, category: 'accommodation', startTime: '15:00', name: 'Check-in The Tower', note: '', isNoteExpanded: false },
                    { id: 6, category: 'food', startTime: '17:00', name: 'Forest Restaurant', note: '晚餐費用 ¥5500', isNoteExpanded: false },
                    { id: 7, category: 'sightseeing', startTime: '19:00', name: '愛絲冰城', note: '入場 ¥600', isNoteExpanded: false }
                ],
                // 3/07 (六)
                [
                    { id: 8, category: 'food', startTime: '08:00', name: '飯店早餐', note: '', isNoteExpanded: false },
                    { id: 9, category: 'transport', startTime: '08:45', name: '包車出發', note: '', isNoteExpanded: false },
                    { id: 10, category: 'sightseeing', startTime: '11:30', name: '定山溪泛舟', note: '活動2小時，費用 ¥9500', address: '定山渓温泉西４丁目', isNoteExpanded: false },
                    { id: 11, category: 'accommodation', startTime: '15:00', name: 'Check-in Vessel Inn', note: '', isNoteExpanded: false },
                    { id: 12, category: 'food', startTime: '18:00', name: '成吉思汗烤羊肉', note: '', isNoteExpanded: false }
                ],
                // 3/08 (日)
                [
                     { id: 13, category: 'transport', startTime: '08:30', name: '包車出發', note: '', isNoteExpanded: false },
                     { id: 14, category: 'sightseeing', startTime: '10:30', name: '登別地獄谷', note: '', isNoteExpanded: false },
                     { id: 15, category: 'sightseeing', startTime: '13:00', name: '洞爺湖', note: '', isNoteExpanded: false },
                     { id: 16, category: 'accommodation', startTime: '17:00', name: 'Check-in OMO5 函館', note: '', isNoteExpanded: false }
                ],
                // 3/09 (一) 函館
                [
                    { id: 17, category: 'food', startTime: '07:00', name: '函館朝市', note: '海鮮丼', isNoteExpanded: false },
                    { id: 18, category: 'sightseeing', startTime: '10:00', name: '五稜郭公園', note: '登塔', isNoteExpanded: false },
                    { id: 19, category: 'shopping', startTime: '13:00', name: '金森紅磚倉庫', note: '', isNoteExpanded: false },
                    { id: 20, category: 'sightseeing', startTime: '15:00', name: '八幡坂/元町教會', note: '', isNoteExpanded: false },
                    { id: 21, category: 'sightseeing', startTime: '18:00', name: '函館山夜景', note: '搭纜車', isNoteExpanded: false }
                ],
                // 3/10 (二)
                [
                    { id: 22, category: 'transport', startTime: '09:00', name: 'JR 特急北斗號', note: '往札幌，約4小時', isNoteExpanded: false },
                    { id: 23, category: 'accommodation', startTime: '15:00', name: 'Check-in Royal Park', note: '大通公園旁', isNoteExpanded: false },
                    { id: 24, category: 'sightseeing', startTime: 'Evening', name: '大通公園散策', note: '', isNoteExpanded: false }
                ],
                // 3/11 (三) 小樽
                [
                    { id: 25, category: 'transport', startTime: '10:00', name: 'JR 快速 Airport', note: '往小樽', isNoteExpanded: false },
                    { id: 26, category: 'sightseeing', startTime: '11:00', name: '小樽運河', note: '拍照', isNoteExpanded: false },
                    { id: 27, category: 'shopping', startTime: '13:00', name: '堺町通商店街', note: '六花亭、北菓樓、LeTAO', isNoteExpanded: false }
                ],
                // 3/12 (四) 旭山
                [
                    { id: 28, category: 'transport', startTime: '07:40', name: '集合：大通站31號門', note: '巴士一日遊', isNoteExpanded: false },
                    { id: 29, category: 'sightseeing', startTime: '10:30', name: '旭山動物園', note: '企鵝散步', isNoteExpanded: false },
                    { id: 30, category: 'transport', startTime: '18:00', name: '返回札幌', note: '', isNoteExpanded: false }
                ],
                // 3/13 (五) 札幌
                [
                    { id: 31, category: 'shopping', startTime: 'All Day', name: '札幌市區自由行', note: '狸小路、北海道神宮', isNoteExpanded: false }
                ],
                // 3/14 (六) 回程
                [
                    { id: 32, category: 'transport', startTime: '11:00', name: '前往新千歲機場', note: '', isNoteExpanded: false },
                    { id: 33, category: 'shopping', startTime: '12:00', name: '國內線航廈採購', note: '', isNoteExpanded: false },
                    { id: 34, category: 'flight', startTime: '14:40', name: 'CI131 起飛', note: '或 JX851/TR893', isNoteExpanded: false }
                ]
            ]);

            // 必買清單
            const mustBuyList = ref([
                { area: '小樽', items: ['六花亭 奶油葡萄夾心', '北菓樓 妖精之森', 'LeTAO 雙層乳酪', '音樂盒'] },
                { area: '札幌', items: ['札幌農學校 餅乾', '白色戀人', '佐藤水產', 'Kinotoya 起司塔'] },
                { area: '函館', items: ['Snaffle’s 起司蛋糕', '烏賊飯'] }
            ]);

            // 購物與記帳
            const shoppingList = ref([
                { name: '六花亭', qty: 5, checked: false, image: null },
                { name: '白色戀人', qty: 2, checked: false, image: null }
            ]);
            const expenses = ref([
                { name: '機票', amount: 35000, category: 'flight', date: '2026-01-15', payment: 'card' }
            ]);

            // 新增資料狀態
            const newItinerary = ref({ id: null, category: 'sightseeing', name: '', startTime: '', address: '', price: '', note: '' });
            const newShoppingItem = ref({ name: '', qty: 1, image: null });
            
            // 花費狀態 (包含分帳欄位)
            const newExpense = ref({ 
                name: '', 
                amount: null, 
                category: 'food', 
                date: '2026-03-06', 
                payment: 'cash',
                isSplit: false,
                splitPeople: 2
            });

            // Computed
            const currentItinerary = computed(() => {
                if (!itineraryData.value[selectedDateIndex.value]) itineraryData.value[selectedDateIndex.value] = [];
                return itineraryData.value[selectedDateIndex.value];
            });
            const totalExpensesJPY = computed(() => expenses.value.reduce((sum, e) => sum + (e.amount || 0), 0));
            
            // 全域總金額 (連動可編輯匯率)
            const totalExpensesTWD = computed(() => Math.round(totalExpensesJPY.value * exchangeRate.value));

            // Methods
            const formatNumber = (num) => num ? num.toLocaleString() : '0';
            const getCategoryColor = (cat) => CATEGORY_MAP[cat]?.color || 'bg-gray-400';
            const getCategoryIcon = (cat) => CATEGORY_MAP[cat]?.icon || 'fa-solid fa-circle';
            const getWeatherIcon = (w) => w === 'snow' ? 'fa-solid fa-snowflake' : (w === 'sunny' ? 'fa-solid fa-sun' : 'fa-solid fa-cloud');
            const openMap = (q) => window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(q)}`, '_blank');
            
            const handleAddClick = () => {
                if (currentTab.value === 'itinerary') { isEditMode.value = false; newItinerary.value = { category: 'sightseeing' }; showItineraryModal.value = true; }
                else if (currentTab.value === 'shopping') { newShoppingItem.value = { name: '', qty: 1 }; showShoppingModal.value = true; }
                else if (currentTab.value === 'expenses') { 
                    newExpense.value = { category: 'food', payment: 'cash', date: '2026-03-06', isSplit: false, splitPeople: 2 }; 
                    showExpenseModal.value = true; 
                }
            };

            const saveItineraryItem = () => {
                if(!newItinerary.value.name) return;
                const newItem = { ...newItinerary.value, id: Date.now(), isNoteExpanded: false };
                if(isEditMode.value) {
                    const idx = currentItinerary.value.findIndex(i => i.id === newItem.id);
                    if(idx !== -1) currentItinerary.value[idx] = newItem;
                } else {
                    itineraryData.value[selectedDateIndex.value].push(newItem);
                    itineraryData.value[selectedDateIndex.value].sort((a,b) => (a.startTime > b.startTime) ? 1 : -1);
                }
                showItineraryModal.value = false;
            };

            const editItem = (item) => {
                isEditMode.value = true;
                newItinerary.value = { ...item };
                showItineraryModal.value = true;
            };

            const addShoppingItem = () => {
                if(newShoppingItem.value.name) shoppingList.value.push({ ...newShoppingItem.value, checked: false });
                showShoppingModal.value = false;
            };
            const removeShoppingItem = (idx) => shoppingList.value.splice(idx, 1);
            
            const handleImageUpload = (e) => {
                const file = e.target.files[0];
                if(file) {
                    const reader = new FileReader();
                    reader.onload = (e) => newShoppingItem.value.image = e.target.result;
                    reader.readAsDataURL(file);
                }
            };

            const addExpense = () => {
                if(newExpense.value.name && newExpense.value.amount) expenses.value.push({ ...newExpense.value });
                showExpenseModal.value = false;
            };
            const removeExpense = (idx) => expenses.value.splice(idx, 1);

            onMounted(() => calculateCurrency());

            return {
                currentTab, dates, selectedDateIndex, hotels, mustBuyList, shoppingList, expenses,
                itineraryData, currentItinerary, totalExpensesJPY, totalExpensesTWD,
                currencyInput, currencyResult, calculateCurrency, formatNumber, exchangeRate, // 匯出 exchangeRate
                getCategoryColor, getCategoryIcon, getWeatherIcon, openMap,
                showItineraryModal, showShoppingModal, showExpenseModal, isEditMode,
                newItinerary, newShoppingItem, newExpense,
                handleAddClick, saveItineraryItem, editItem,
                addShoppingItem, removeShoppingItem, handleImageUpload, addExpense, removeExpense,
                quickSplit
            }
        }
    }).mount('#app');
</script>
</body>
</html>